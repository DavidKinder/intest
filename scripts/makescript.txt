# This is the script from which inweb -makefile will construct a makefile.

{platform-settings}

{identity-settings}

# Making the program:

$(ME)/Tangled/$(MYNAME): {dependent-files}
	$(call make-me)

.PHONY: force
force:
	$(call make-me)

define make-me
	$(INWEB) $(ME) -import-from modules -tangle
	$(CC) -o $(ME)/Tangled/$(MYNAME).o $(ME)/Tangled/$(MYNAME).c
	$(LINK) -o $(ME)/Tangled/$(MYNAME) $(ME)/Tangled/$(MYNAME).o $(LINKEROPTS)
endef

# Testing the program:

.PHONY: test
test:
	$(INTEST) -from $(ME) all

# "make commit" should be used only by the Benevolent Overlord of Intest.
# It updates the build code and commits to the repository.

.PHONY: commit
commit:
	$(INWEB) -advance-build-file $(ME)/build.txt
	$(INWEB) -prototype intest/scripts/READMEscript.txt -write-me intest/README.md
	cd $(ME); git commit -a

# Weaving the web for GitHub Pages:

.PHONY: pages
pages:
	mkdir -p $(ME)/docs/$(MYNAME)
	$(INWEB) -prototype intest/scripts/READMEscript.txt -write-me intest/README.md
	rm $(ME)/docs/*.html
	$(INWEB) $(ME)/docs/docs-src/webs.inweb -weave-as GitHubCovers -weave-into $(ME)/docs -navigation $(ME)/docs/docs-src/nav-o.html
	rm $(ME)/docs/$(MYNAME)/*.html
	$(INWEB) $(ME) -weave-docs -weave-into $(ME)/docs/$(MYNAME) -breadcrumb 'Source:../webs.html' -navigation $(ME)/docs/docs-src/nav.html

# Cleaning up:

.PHONY: clean
clean:
	$(call clean-up)

.PHONY: purge
purge:
	$(call clean-up)
	rm -f $(ME)/Tangled/$(MYNAME)

define clean-up
	rm -f $(ME)/Tangled/*.o
	rm -f $(ME)/Tangled/*.c
	rm -f $(ME)/Tangled/*.h
endef
