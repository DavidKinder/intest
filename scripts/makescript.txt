# This is the script from which inweb -makefile will construct a makefile.
# To generate intest.mk from its source, use e.g.:
# inweb/Tangled/inweb intest -prototype intest/scripts/makescript.txt -makefile intest/intest.mk 

{platform-settings}

{identity-settings}

# The colony file for this collection of webs contains information about their
# paths, where they are woven to, and so on

COLONY = $(ME)/colony.txt

# Making the program:

$(ME)/Tangled/$(MYNAME): {dependent-files}
	$(call make-me)

.PHONY: force
force:
	$(call make-me)

define make-me
	$(INWEB) $(ME) -import-from modules -tangle
	$(CC) -o $(ME)/Tangled/$(MYNAME).o $(ME)/Tangled/$(MYNAME).c
	$(LINK) -o $(ME)/Tangled/$(MYNAME) $(ME)/Tangled/$(MYNAME).o $(LINKEROPTS)
endef

# Testing the program:

.PHONY: test
test:
	$(INTEST) -from $(ME) all

# "make commit" should be used only by the Benevolent Overlord of Intest.
# It updates the build code and commits to the repository.

.PHONY: commit
commit:
	$(INWEB) -advance-build-file $(ME)/build.txt
	$(INWEB) -prototype intest/scripts/READMEscript.txt -write-me intest/README.md
	cd $(ME); git commit -a

# Weaving the web for GitHub Pages:

.PHONY: pages
pages:
	$(INWEB) -advance-build-file $(ME)/build.txt
	mkdir -p $(ME)/docs/$(MYNAME)
	$(ME)/Tangled/$(MYNAME) -help > $(ME)/Figures/help.txt
	$(INWEB) -prototype intest/scripts/READMEscript.txt -write-me intest/README.md
	rm -f $(ME)/docs/*.html
	rm -f $(ME)/docs/intest/*.html
	$(INWEB) -colony $(COLONY) -member overview -weave
	$(INWEB) -colony $(COLONY) -member intest -weave

# Cleaning up:

.PHONY: clean
clean:
	$(call clean-up)

.PHONY: purge
purge:
	$(call clean-up)
	rm -f $(ME)/Tangled/$(MYNAME)

define clean-up
	rm -f $(ME)/Tangled/*.o
	rm -f $(ME)/Tangled/*.c
	rm -f $(ME)/Tangled/*.h
endef
