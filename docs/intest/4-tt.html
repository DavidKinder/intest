<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>4/tdc</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '4/tt' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">intest 2.0</a></li><li><a href="index.html#4">Chapter 4: Recipes</a></li><li><b>The Tester</b></li></ul><p class="purpose">To run a compiled recipe on a single test case.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Test interpreter</a></li><li><a href="#SP1_1_1_2_3_2_1">&#167;1.1.1.2.3.2.1. Steps</a></li><li><a href="#SP1_1_1_2_3_2_2">&#167;1.1.1.2.3.2.2. Variables</a></li><li><a href="#SP1_1_1_2_3_2_3">&#167;1.1.1.2.3.2.3. Matches</a></li><li><a href="#SP1_1_1_2_3_2_4">&#167;1.1.1.2.3.2.4. Miscellaneous other commands</a></li><li><a href="#SP3">&#167;3. Purging</a></li><li><a href="#SP5">&#167;5. Token expansion</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Test interpreter. </b>To test is to interpret a recipe already compiled from Delia code into a
parse tree in memory.
</p>

<p class="inwebparagraph">Note that there are several different action types which can bring us here &mdash;
<code class="display"><span class="extract">-test</span></code>, <code class="display"><span class="extract">-show</span></code>, <code class="display"><span class="extract">-bless</span></code>, and so on &mdash; and that the meaning of commands
in the recipe may depend on what we're trying to do with it.
</p>

<p class="inwebparagraph">The "work area" is a folder inside the Intest distribution containing files
we may need: we can read but not write it. The "thread work area", on the
other hand, is a private folder which no other thread has access to, so that
we can both read and write. In Delia code, the text <code class="display"><span class="extract">$WORK</span></code> expands to the
pathname of the thread work area.
</p>

<p class="inwebparagraph">The debugging log is split into multiple logs, one per thread, only if the
"tester" debugging log aspect is switched on. The mutex here means that
performance is greatly reduced if so.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Tester::test</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">test_case</span><span class="plain"> *</span><span class="identifier">tc</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">thread_count</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">action_type</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">tc</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"no test case"</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">passed</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">splitting_logs</span><span class="plain">) {</span>
            <span class="identifier">CREATE_MUTEX</span><span class="plain">(</span><span class="identifier">mutex</span><span class="plain">);</span>
            <span class="identifier">LOCK_MUTEX</span><span class="plain">(</span><span class="identifier">mutex</span><span class="plain">);</span>
            <span class="identifier">DL</span><span class="plain"> = &amp;(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">thread_count</span><span class="plain">]</span><span class="element">.split_log</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">Actually test</span> <span class="cwebmacronumber">1.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">DL</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="identifier">UNLOCK_MUTEX</span><span class="plain">(</span><span class="identifier">mutex</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            &lt;<span class="cwebmacro">Actually test</span> <span class="cwebmacronumber">1.1</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">passed</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Tester::test is used in 2/act (<a href="2-act.html#SP9_2">&#167;9.2</a>), 3/ts (<a href="3-ts.html#SP10">&#167;10</a>).</p>

<p class="inwebparagraph"><a id="SP1_1"></a><b>&#167;1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Actually test</span> <span class="cwebmacronumber">1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Work_Area</span><span class="plain"> = </span><span class="functiontext">Globals::to_pathname</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"workspace"</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">n</span><span class="plain"> = </span><span class="identifier">thread_count</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain"> &lt; 0) </span><span class="identifier">n</span><span class="plain"> = 0; </span>    <span class="comment">if we're not multi-tasking, use thread 0's work area</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Thread_Work_Area</span><span class="plain"> = </span><span class="functiontext">Scheduler::work_area</span><span class="plain">(</span><span class="identifier">n</span><span class="plain">);</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Example_materials</span><span class="plain"> =</span>
            <span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">Thread_Work_Area</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Example.materials"</span><span class="plain">);</span>
        <span class="functiontext">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">Example_materials</span><span class="plain">);</span>

        <span class="functiontext">Tester::purge_work_area</span><span class="plain">(</span><span class="identifier">n</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Perform and report on the test</span> <span class="cwebmacronumber">1.1.1</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1">&#167;1</a> (twice).</p>

<p class="inwebparagraph"><a id="SP1_1_1"></a><b>&#167;1.1.1.  </b>The "brackets" here are used in the summary text; <code class="display"><span class="extract">[5]</span></code>, <code class="display"><span class="extract">(5)</span></code> and <code class="display"><span class="extract">-5-</span></code> are
all possible.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Perform and report on the test</span> <span class="cwebmacronumber">1.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span>    <span class="comment">brief text summarising the outcome, e.g., "passed"</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"passed"</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">damning_evidence</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">match_fail1</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">, *</span><span class="identifier">match_fail2</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">char</span><span class="plain"> </span><span class="identifier">left_bracket</span><span class="plain"> = </span><span class="character">'['</span><span class="plain">, </span><span class="identifier">right_bracket</span><span class="plain"> = </span><span class="character">']'</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Follow the test recipe</span> <span class="cwebmacronumber">1.1.1.2</span>&gt;<span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%c%d%c %S %S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">left_bracket</span><span class="plain">, </span><span class="identifier">count</span><span class="plain">, </span><span class="identifier">right_bracket</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_case_name</span><span class="plain">, </span><span class="identifier">verdict</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">match_fail1</span><span class="plain">) </span>&lt;<span class="cwebmacro">Issue any necessary diff or bbdiff commands</span> <span class="cwebmacronumber">1.1.1.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">damning_evidence</span><span class="plain">) </span><span class="functiontext">Extractor::cat</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">damning_evidence</span><span class="plain">);</span>
        <span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;left_bracket</span><span class="plain"> = </span><span class="identifier">left_bracket</span><span class="plain">;</span>
        <span class="identifier">tc</span><span class="plain">-&gt;</span><span class="identifier">right_bracket</span><span class="plain"> = </span><span class="identifier">right_bracket</span><span class="plain">;</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1">&#167;1.1</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_1"></a><b>&#167;1.1.1.1.  </b>Running with <code class="display"><span class="extract">-diff</span></code> or <code class="display"><span class="extract">-bbdiff</span></code> delegates the displaying of match errors
to those superior tools:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Issue any necessary diff or bbdiff commands</span> <span class="cwebmacronumber">1.1.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">char</span><span class="plain"> *</span><span class="identifier">difftool</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">DIFF_ACTION</span><span class="plain">) </span><span class="identifier">difftool</span><span class="plain"> = </span><span class="string">"diff"</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">BBDIFF_ACTION</span><span class="plain">) </span><span class="identifier">difftool</span><span class="plain"> = </span><span class="string">"bbdiff"</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">difftool</span><span class="plain">) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"%s "</span><span class="plain">, </span><span class="identifier">difftool</span><span class="plain">);</span>
            <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">match_fail1</span><span class="plain">);</span>
            <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">match_fail2</span><span class="plain">);</span>
            <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
            <span class="identifier">damning_evidence</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1">&#167;1.1.1</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2"></a><b>&#167;1.1.1.2.  </b>And now for the interpreter. Given a block of commands, we are either
executing them, or skipping them: we record that on a stack because blocks
can be nested. The entire recipe is considered as a block for this purpose,
and it's one that we are always executing.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_IF_NESTING</span><span class="plain"> 10</span>
    <span class="definitionkeyword">define</span> <span class="constant">CREATE_EXECUTION_CONTEXT</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">execution_state</span><span class="plain">[</span><span class="constant">MAX_IF_NESTING</span><span class="plain">];</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">execution_state_sp</span><span class="plain"> = 0;</span>
    <span class="definitionkeyword">define</span> <span class="identifier">ENTER_EXECUTION_BLOCK</span><span class="plain">(</span><span class="identifier">state</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">execution_state_sp</span><span class="plain"> &gt;= </span><span class="constant">MAX_IF_NESTING</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"ifs too deeply nested in recipe"</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">execution_state</span><span class="plain">[</span><span class="identifier">execution_state_sp</span><span class="plain">++] = </span><span class="identifier">state</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="definitionkeyword">define</span> <span class="constant">INVERT_EXECUTION_BLOCK</span><span class="plain"> {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">execution_state_sp</span><span class="plain"> &lt;= 1) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"ifs nested wrongly in recipe"</span><span class="plain">);</span>
        <span class="identifier">execution_state</span><span class="plain">[</span><span class="identifier">execution_state_sp</span><span class="plain">-1] = (</span><span class="identifier">execution_state</span><span class="plain">[</span><span class="identifier">execution_state_sp</span><span class="plain">-1])?</span><span class="constant">FALSE</span><span class="plain">:</span><span class="constant">TRUE</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="definitionkeyword">define</span> <span class="constant">EXIT_EXECUTION_BLOCK</span><span class="plain"> {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">execution_state_sp</span><span class="plain"> &lt;= 1) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"ifs nested wrongly in recipe"</span><span class="plain">);</span>
        <span class="identifier">execution_state_sp</span><span class="plain">--;</span>
    <span class="plain">}</span>
</pre>

<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Follow the test recipe</span> <span class="cwebmacronumber">1.1.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"Following test recipe %S on %S (action %d)\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
            <span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_recipe_name</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_case_name</span><span class="plain">, </span><span class="identifier">action_type</span><span class="plain">);</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">hash_value_written</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain"> = </span><span class="functiontext">Dictionaries::new</span><span class="plain">(10, </span><span class="constant">TRUE</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Populate the test dictionary</span> <span class="cwebmacronumber">1.1.1.2.1</span>&gt;<span class="plain">;</span>

        <span class="constant">CREATE_EXECUTION_CONTEXT</span><span class="plain">;</span>
        <span class="identifier">ENTER_EXECUTION_BLOCK</span><span class="plain">(</span><span class="constant">TRUE</span><span class="plain">); </span>    <span class="comment">the block for the entire recipe</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">line_count</span><span class="plain"> = 0;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_match_commands</span><span class="plain"> = 0;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_step_commands</span><span class="plain"> = 0;</span>
        <span class="reserved">recipe</span><span class="plain"> *</span><span class="identifier">R</span><span class="plain"> = </span><span class="functiontext">Delia::find</span><span class="plain">(</span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_recipe_name</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">R</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"no recipe called '%S' to test this with"</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_recipe_name</span><span class="plain">);</span>
            <span class="identifier">passed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="reserved">recipe_line</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">L</span><span class="plain">, </span><span class="reserved">recipe_line</span><span class="plain">, </span><span class="identifier">R</span><span class="plain">-</span><span class="element">&gt;lines</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">still_going</span><span class="plain">) {</span>
                    &lt;<span class="cwebmacro">Log the line</span> <span class="cwebmacronumber">1.1.1.2.2</span>&gt;<span class="plain">;</span>
                    &lt;<span class="cwebmacro">Interpret line</span> <span class="cwebmacronumber">1.1.1.2.3</span>&gt;<span class="plain">;</span>
                <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">passed</span><span class="plain">) &amp;&amp; (</span><span class="identifier">hash_value_written</span><span class="plain">))</span>
            <span class="functiontext">Hasher::assign_to_case</span><span class="plain">(</span><span class="identifier">tc</span><span class="plain">, </span><span class="functiontext">Dictionaries::get_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"HASHCODE"</span><span class="plain">));</span>
        <span class="functiontext">Dictionaries::dispose_of</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"Recipe completed: %s: %S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">passed</span><span class="plain">?</span><span class="string">"pass"</span><span class="plain">:</span><span class="string">"fail"</span><span class="plain">, </span><span class="identifier">verdict</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1">&#167;1.1.1</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_1"></a><b>&#167;1.1.1.2.1.  </b>It would be tempting to use intest's main variables dictionary here, but that
wouldn't be thread-safe, so each usage of this routine gets its own private
dictionary.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Populate the test dictionary</span> <span class="cwebmacronumber">1.1.1.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"CASE"</span><span class="plain">), </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_case_name</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"SCRIPT"</span><span class="plain">), </span><span class="string">""</span><span class="plain">); </span>    <span class="comment">set by the <code class="display"><span class="extract">extract</span></code> command, if used</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"PATH"</span><span class="plain">), </span><span class="string">"%p"</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;work_area</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"WORK"</span><span class="plain">), </span><span class="string">"%p"</span><span class="plain">, </span><span class="identifier">Thread_Work_Area</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"HASHCODE"</span><span class="plain">), </span><span class="string">""</span><span class="plain">); </span>    <span class="comment">set by <code class="display"><span class="extract">hash</span></code> commands</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"TYPE"</span><span class="plain">), </span><span class="string">"%S"</span><span class="plain">, </span><span class="functiontext">RecipeFiles::case_type_as_text</span><span class="plain">(</span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_type</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2">&#167;1.1.1.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_2"></a><b>&#167;1.1.1.2.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Log the line</span> <span class="cwebmacronumber">1.1.1.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">line_count</span><span class="plain">++;</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"%d: "</span><span class="plain">, </span><span class="identifier">line_count</span><span class="plain">);</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">execution_state_sp</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) </span><span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"%s "</span><span class="plain">, </span><span class="identifier">execution_state</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]?</span><span class="string">"on"</span><span class="plain">:</span><span class="string">"off"</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"| $L\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2">&#167;1.1.1.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3"></a><b>&#167;1.1.1.2.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Interpret line</span> <span class="cwebmacronumber">1.1.1.2.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">running</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">execution_state_sp</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">execution_state</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">] == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="identifier">running</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;command_used</span><span class="plain">-</span><span class="element">&gt;rc_code</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">IF_RCOM</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">running</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="identifier">ENTER_EXECUTION_BLOCK</span><span class="plain">(</span><span class="constant">FALSE</span><span class="plain">)</span>
                <span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Enter an execution block if a regular expression matches</span> <span class="cwebmacronumber">1.1.1.2.3.1</span>&gt;<span class="plain">;</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">ELSE_RCOM</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">execution_state_sp</span><span class="plain"> &lt;= 1) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"else without if in recipe"</span><span class="plain">);</span>
                <span class="constant">INVERT_EXECUTION_BLOCK</span><span class="plain">;</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">ENDIF_RCOM</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">execution_state_sp</span><span class="plain"> &lt;= 1) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"endif without if in recipe"</span><span class="plain">);</span>
                <span class="constant">EXIT_EXECUTION_BLOCK</span><span class="plain">;</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">PASS_RCOM</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">running</span><span class="plain">) {</span>
                    <span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="identifier">passed</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">; </span><span class="functiontext">Delia::dequote_first_token</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">);</span>
                <span class="plain">}</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">FAIL_RCOM</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">running</span><span class="plain">) {</span>
                    <span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="identifier">passed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="functiontext">Delia::dequote_first_token</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">);</span>
                <span class="plain">}</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">OR_RCOM</span><span class="plain">: </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">default</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">running</span><span class="plain">) </span>&lt;<span class="cwebmacro">Interpret an unconditional line</span> <span class="cwebmacronumber">1.1.1.2.3.2</span>&gt;<span class="plain">;</span>
                <span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2">&#167;1.1.1.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_1"></a><b>&#167;1.1.1.2.3.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Enter an execution block if a regular expression matches</span> <span class="cwebmacronumber">1.1.1.2.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">second</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(1, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">);</span>
        <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">second</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">P_C_string</span><span class="plain">[1024];</span>
        <span class="functiontext">Str::copy_to_wide_string</span><span class="plain">(</span><span class="identifier">P_C_string</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">, 1024);</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="identifier">ENTER_EXECUTION_BLOCK</span><span class="plain">(</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">P_C_string</span><span class="plain">));</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">);</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3">&#167;1.1.1.2.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2"></a><b>&#167;1.1.1.2.3.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Interpret an unconditional line</span> <span class="cwebmacronumber">1.1.1.2.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;command_used</span><span class="plain">-</span><span class="element">&gt;rc_code</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">STEP_RCOM</span><span class="plain">:               </span>&lt;<span class="cwebmacro">Carry out a step</span> <span class="cwebmacronumber">1.1.1.2.3.2.1</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">DEBUGGER_RCOM</span><span class="plain">:	          </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">DEBUGGER_ACTION</span><span class="plain">) </span>&lt;<span class="cwebmacro">Carry out a step</span> <span class="cwebmacronumber">1.1.1.2.3.2.1</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">FAIL_STEP_RCOM</span><span class="plain">:          </span>&lt;<span class="cwebmacro">Carry out a step</span> <span class="cwebmacronumber">1.1.1.2.3.2.1</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>

            <span class="reserved">case</span><span class="plain"> </span><span class="constant">SET_RCOM</span><span class="plain">:                </span>&lt;<span class="cwebmacro">Set a local variable</span> <span class="cwebmacronumber">1.1.1.2.3.2.2</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>

            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_TEXT_RCOM</span><span class="plain">:         </span>&lt;<span class="cwebmacro">Carry out a match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_BINARY_RCOM</span><span class="plain">:       </span>&lt;<span class="cwebmacro">Carry out a match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_FOLDER_RCOM</span><span class="plain">:       </span>&lt;<span class="cwebmacro">Carry out a match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_G_TRANSCRIPT_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Carry out a match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_Z_TRANSCRIPT_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Carry out a match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_PROBLEM_RCOM</span><span class="plain">:      </span>&lt;<span class="cwebmacro">Carry out a match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>

            <span class="reserved">case</span><span class="plain"> </span><span class="constant">HASH_RCOM</span><span class="plain">:               </span>&lt;<span class="cwebmacro">Carry out a hash</span> <span class="cwebmacronumber">1.1.1.2.3.2.7</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">EXTRACT_RCOM</span><span class="plain">:            </span>&lt;<span class="cwebmacro">Make an extract</span> <span class="cwebmacronumber">1.1.1.2.3.2.4</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">EXISTS_RCOM</span><span class="plain">:             </span>&lt;<span class="cwebmacro">Require existence of file</span> <span class="cwebmacronumber">1.1.1.2.3.2.5</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">COPY_RCOM</span><span class="plain">:               </span>&lt;<span class="cwebmacro">Copy a file</span> <span class="cwebmacronumber">1.1.1.2.3.2.8</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MKDIR_RCOM</span><span class="plain">:              </span>&lt;<span class="cwebmacro">Make a directory</span> <span class="cwebmacronumber">1.1.1.2.3.2.9</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>

            <span class="reserved">case</span><span class="plain"> </span><span class="constant">SHOW_RCOM</span><span class="plain">:               </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">SHOW_ACTION</span><span class="plain">) </span>&lt;<span class="cwebmacro">Show file</span> <span class="cwebmacronumber">1.1.1.2.3.2.6</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">SHOW_I6_RCOM</span><span class="plain">:            </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">SHOW_I6_ACTION</span><span class="plain">) </span>&lt;<span class="cwebmacro">Show file</span> <span class="cwebmacronumber">1.1.1.2.3.2.6</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">SHOW_TRANSCRIPT_RCOM</span><span class="plain">:    </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">SHOW_TRANSCRIPT_ACTION</span><span class="plain">) </span>&lt;<span class="cwebmacro">Show file</span> <span class="cwebmacronumber">1.1.1.2.3.2.6</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>

            <span class="reserved">default</span><span class="plain">: </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"unknown recipe command"</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3">&#167;1.1.1.2.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_1"></a><b>&#167;1.1.1.2.3.2.1. Steps. </b>The <code class="display"><span class="extract">step</span></code> and <code class="display"><span class="extract">fail step</span></code> commands are essentially the same: expand the
tokens into a command, call the shell to run it, and require the return value
to be zero (for <code class="display"><span class="extract">step</span></code>) or non-zero (for <code class="display"><span class="extract">fail step</span></code>).
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Carry out a step</span> <span class="cwebmacronumber">1.1.1.2.3.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> != </span><span class="constant">CURSE_ACTION</span><span class="plain">) {</span>
            <span class="identifier">no_step_commands</span><span class="plain">++;</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
            <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">) {</span>
                <span class="functiontext">Tester::quote_expand</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">" "</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">rv</span><span class="plain"> = </span><span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;command_used</span><span class="plain">-</span><span class="element">&gt;rc_code</span><span class="plain"> == </span><span class="constant">FAIL_STEP_RCOM</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rv</span><span class="plain"> == 0) {</span>
                    <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"step %d should have failed but didn't"</span><span class="plain">, </span><span class="identifier">no_step_commands</span><span class="plain">);</span>
                    <span class="identifier">passed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
                    &lt;<span class="cwebmacro">Or...</span> <span class="cwebmacronumber">1.1.1.2.3.2.1.1</span>&gt;<span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rv</span><span class="plain"> != 0) {</span>
                    <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"step %d failed to run"</span><span class="plain">, </span><span class="identifier">no_step_commands</span><span class="plain">);</span>
                    <span class="identifier">passed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
                    &lt;<span class="cwebmacro">Or...</span> <span class="cwebmacronumber">1.1.1.2.3.2.1.1</span>&gt;<span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a> (three times).</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_1_1"></a><b>&#167;1.1.1.2.3.2.1.1.  </b>If the next command is an <code class="display"><span class="extract">or</span></code>, then use its text rather than our bland
one in the event of failure.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Or...</span> <span class="cwebmacronumber">1.1.1.2.3.2.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">linked_list_item</span><span class="plain"> *</span><span class="identifier">next_item</span><span class="plain"> = </span><span class="identifier">NEXT_ITEM_IN_LINKED_LIST</span><span class="plain">(</span><span class="identifier">L_item</span><span class="plain">, </span><span class="reserved">recipe_line</span><span class="plain">);</span>
        <span class="reserved">recipe_line</span><span class="plain"> *</span><span class="identifier">next_line</span><span class="plain"> = </span><span class="identifier">CONTENT_IN_ITEM</span><span class="plain">(</span><span class="identifier">next_item</span><span class="plain">, </span><span class="reserved">recipe_line</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">next_line</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="identifier">next_line</span><span class="plain">-</span><span class="element">&gt;command_used</span><span class="plain">-</span><span class="element">&gt;rc_code</span><span class="plain"> == </span><span class="constant">OR_RCOM</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="functiontext">LinkedLists::len</span><span class="plain">(</span><span class="identifier">next_line</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">) &gt; 0)) {</span>
            <span class="functiontext">Delia::dequote_first_token</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="identifier">next_line</span><span class="plain">);</span>
            <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">second</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(1, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">next_line</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">second</span><span class="plain">) </span><span class="identifier">damning_evidence</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">second</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_1">&#167;1.1.1.2.3.2.1</a> (twice), <a href="#SP1_1_1_2_3_2_3_3">&#167;1.1.1.2.3.2.3.3</a>, <a href="#SP1_1_1_2_3_2_5">&#167;1.1.1.2.3.2.5</a>, <a href="#SP1_1_1_2_3_2_6">&#167;1.1.1.2.3.2.6</a>, <a href="#SP1_1_1_2_3_2_7">&#167;1.1.1.2.3.2.7</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_2"></a><b>&#167;1.1.1.2.3.2.2. Variables. </b>If the given value is a single word then we expand it as such, but otherwise
we use quote expansion on each token. This is important because if "options"
is set to, say, <code class="display"><span class="extract">frog $toad</span></code> before expansion, and the value of "toad" is,
say, "green amphibian", then we get <code class="display"><span class="extract">'frog' 'green amphibian'</span></code>. See the
documentation.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Set a local variable</span> <span class="cwebmacronumber">1.1.1.2.3.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">FIRST_IN_LINKED_LIST</span><span class="plain">(</span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain"> = </span><span class="identifier">first</span><span class="plain">-</span><span class="element">&gt;token_text</span><span class="plain">;</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">);</span>
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain"> != </span><span class="identifier">first</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">LinkedLists::len</span><span class="plain">(</span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">) &gt; 2)</span>
                    <span class="functiontext">Tester::quote_expand</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
                <span class="reserved">else</span>
                    <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="functiontext">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">), </span><span class="identifier">V</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"Variable %S set to &lt;%S&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3"></a><b>&#167;1.1.1.2.3.2.3. Matches. </b>In a match, two files are compared. We'll call the first file "actual" and the
second "ideal"; the idea is that the first has been produced by earlier steps,
while the second is a record of what it ought to come out as.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Carry out a match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">second</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(1, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">matching_actual</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">matching_ideal</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">second</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">exists</span><span class="plain"> = </span><span class="functiontext">TextFiles::exists</span><span class="plain">(</span><span class="identifier">matching_ideal</span><span class="plain">);</span>

        <span class="reserved">switch</span><span class="plain">(</span><span class="identifier">action_type</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">BLESS_ACTION</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">exists</span><span class="plain">) {</span>
                    <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"was already blessed: use -rebless to change"</span><span class="plain">);</span>
                    <span class="identifier">passed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
                <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Perform a blessing</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.1</span>&gt;<span class="plain">;</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">REBLESS_ACTION</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a blessing</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.1</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CURSE_ACTION</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a curse</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.2</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">SHOW_ACTION</span><span class="plain">:</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">TEST_ACTION</span><span class="plain">:</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">DEBUGGER_ACTION</span><span class="plain">:</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">DIFF_ACTION</span><span class="plain">:</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">BBDIFF_ACTION</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (!</span><span class="identifier">exists</span><span class="plain">) {</span>
                    <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"passed (but no blessed result exists to compare with)"</span><span class="plain">);</span>
                    <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"Unable to find blessed file at %f\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">matching_ideal</span><span class="plain">);</span>
                    <span class="identifier">left_bracket</span><span class="plain"> = </span><span class="character">'-'</span><span class="plain">; </span><span class="identifier">right_bracket</span><span class="plain"> = </span><span class="character">'-'</span><span class="plain">;</span>
                <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Perform a test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3</span>&gt;<span class="plain">;</span>
                <span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">no_match_commands</span><span class="plain">++;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a> (6 times).</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_1"></a><b>&#167;1.1.1.2.3.2.3.1.  </b>To "bless" is to make the actual output also the ideal.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Perform a blessing</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"cp -p "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_actual</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_ideal</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"passed (blessing this transcript in future)"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3">&#167;1.1.1.2.3.2.3</a> (twice).</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_2"></a><b>&#167;1.1.1.2.3.2.3.2.  </b>To "curse" is to delete the ideal.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Perform a curse</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"rm "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_ideal</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">CURSE_ACTION</span><span class="plain">) { </span><span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"cursed (no test conducted)"</span><span class="plain">); }</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3">&#167;1.1.1.2.3.2.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_3"></a><b>&#167;1.1.1.2.3.2.3.3.  </b>That just leaves the actual comparison. We support five different file formats
for these, three of which are highly specific to Inform 7.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Perform a test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">DOT</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">DOT</span><span class="plain">, </span><span class="string">"diff_output_%d.txt"</span><span class="plain">, </span><span class="identifier">no_match_commands</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">DO</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">Thread_Work_Area</span><span class="plain">, </span><span class="identifier">DOT</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">DOT</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">rv</span><span class="plain"> = 0;</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;command_used</span><span class="plain">-</span><span class="element">&gt;rc_code</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_TEXT_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a plain text test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.1</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_BINARY_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a binary test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.2</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_FOLDER_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a folder match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_G_TRANSCRIPT_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a Glulxe transcript test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.5</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_Z_TRANSCRIPT_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a Frotz transcript test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.4</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">MATCH_PROBLEM_RCOM</span><span class="plain">: </span>&lt;<span class="cwebmacro">Perform a problem test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.6</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">default</span><span class="plain">: </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"unknown recipe command"</span><span class="plain">);</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rv</span><span class="plain"> != 0) {</span>
            <span class="identifier">passed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"failed to match"</span><span class="plain">);</span>
            <span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="identifier">match_fail1</span><span class="plain"> = </span><span class="identifier">matching_actual</span><span class="plain">; </span><span class="identifier">match_fail2</span><span class="plain"> = </span><span class="identifier">matching_ideal</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> != </span><span class="constant">SHOW_ACTION</span><span class="plain">) </span><span class="functiontext">Extractor::cat</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">Or...</span> <span class="cwebmacronumber">1.1.1.2.3.2.1.1</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3">&#167;1.1.1.2.3.2.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_3_1"></a><b>&#167;1.1.1.2.3.2.3.3.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Perform a plain text test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">TO</span><span class="plain"> = &amp;</span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to write file"</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain"> = </span><span class="functiontext">Skeins::from_plain_text</span><span class="plain">(</span><span class="identifier">matching_actual</span><span class="plain">);</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain"> = </span><span class="functiontext">Skeins::from_plain_text</span><span class="plain">(</span><span class="identifier">matching_ideal</span><span class="plain">);</span>
        <span class="identifier">rv</span><span class="plain"> = 0;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Skeins::compare</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">) &gt; 0) </span><span class="identifier">rv</span><span class="plain"> = 1;</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3_3">&#167;1.1.1.2.3.2.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP_1"></a><b>&#167;.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Perform a plain text test match using diff</span> <span class="cwebmacronumber">.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"diff "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_actual</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_ideal</span><span class="plain">);</span>
        <span class="functiontext">Shell::redirect</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
        <span class="identifier">rv</span><span class="plain"> = </span><span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is never used.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_3_2"></a><b>&#167;1.1.1.2.3.2.3.3.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Perform a binary test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"cmp -b "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_actual</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_ideal</span><span class="plain">);</span>
        <span class="functiontext">Shell::redirect</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
        <span class="identifier">rv</span><span class="plain"> = </span><span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3_3">&#167;1.1.1.2.3.2.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_3_3"></a><b>&#167;1.1.1.2.3.2.3.3.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Perform a folder match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"diff -arq -x '.DS_Store' "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_actual</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">matching_ideal</span><span class="plain">);</span>
        <span class="functiontext">Shell::redirect</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
        <span class="identifier">rv</span><span class="plain"> = </span><span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3_3">&#167;1.1.1.2.3.2.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_3_4"></a><b>&#167;1.1.1.2.3.2.3.3.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Perform a Frotz transcript test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">TO</span><span class="plain"> = &amp;</span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to write file"</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain"> = </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;command_line_echoing_detected</span><span class="plain">;</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain"> = </span><span class="functiontext">Skeins::from_Z_transcript</span><span class="plain">(</span><span class="identifier">matching_actual</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">);</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain"> = </span><span class="functiontext">Skeins::from_Z_transcript</span><span class="plain">(</span><span class="identifier">matching_ideal</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">);</span>
        <span class="identifier">rv</span><span class="plain"> = 0;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Skeins::compare</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">) &gt; 0) </span><span class="identifier">rv</span><span class="plain"> = 1;</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3_3">&#167;1.1.1.2.3.2.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_3_5"></a><b>&#167;1.1.1.2.3.2.3.3.5.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Perform a Glulxe transcript test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.5</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">TO</span><span class="plain"> = &amp;</span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to write file"</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain"> = </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;command_line_echoing_detected</span><span class="plain">;</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain"> = </span><span class="functiontext">Skeins::from_G_transcript</span><span class="plain">(</span><span class="identifier">matching_actual</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">);</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain"> = </span><span class="functiontext">Skeins::from_G_transcript</span><span class="plain">(</span><span class="identifier">matching_ideal</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">);</span>
        <span class="identifier">rv</span><span class="plain"> = 0;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Skeins::compare</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">) &gt; 0) </span><span class="identifier">rv</span><span class="plain"> = 1;</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3_3">&#167;1.1.1.2.3.2.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_3_3_6"></a><b>&#167;1.1.1.2.3.2.3.3.6.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Perform a problem test match</span> <span class="cwebmacronumber">1.1.1.2.3.2.3.3.6</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">TO</span><span class="plain"> = &amp;</span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to write file"</span><span class="plain">, </span><span class="identifier">DO</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain"> = </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;command_line_echoing_detected</span><span class="plain">;</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain"> = </span><span class="functiontext">Skeins::from_i7_problems</span><span class="plain">(</span><span class="identifier">matching_actual</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">);</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain"> = </span><span class="functiontext">Skeins::from_i7_problems</span><span class="plain">(</span><span class="identifier">matching_ideal</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">);</span>
        <span class="identifier">rv</span><span class="plain"> = 0;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Skeins::compare</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">) &gt; 0) </span><span class="identifier">rv</span><span class="plain"> = 1;</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="functiontext">Skeins::dispose_of</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2_3_3">&#167;1.1.1.2.3.2.3.3</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_4"></a><b>&#167;1.1.1.2.3.2.4. Miscellaneous other commands. </b>The <code class="display"><span class="extract">extract</span></code> command only makes sense for Inform 7 test cases.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Make an extract</span> <span class="cwebmacronumber">1.1.1.2.3.2.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">second</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(1, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">i7_here</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">test_me_exists</span><span class="plain"> = </span><span class="functiontext">Tester::extract_source_to_file</span><span class="plain">(</span><span class="identifier">i7_here</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">script_file</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">TextFiles::exists</span><span class="plain">(</span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;commands_location</span><span class="plain">)) {</span>
            <span class="identifier">script_file</span><span class="plain"> = </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;commands_location</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">test_me_exists</span><span class="plain">) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
            <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">second</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Z"</span><span class="plain">))</span>
                <span class="identifier">script_file</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">Work_Area</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"ZT.sol"</span><span class="plain">);</span>
            <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"G"</span><span class="plain">))</span>
                <span class="identifier">script_file</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">Work_Area</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"GT.sol"</span><span class="plain">);</span>
            <span class="reserved">else</span>
                <span class="functiontext">Errors::fatal_with_text</span><span class="plain">(</span><span class="string">"extract can only be to Z or G, not %S"</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
            <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">second</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Z"</span><span class="plain">))</span>
                <span class="identifier">script_file</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">Work_Area</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"ZQ.sol"</span><span class="plain">);</span>
            <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"G"</span><span class="plain">))</span>
                <span class="identifier">script_file</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">Work_Area</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"GQ.sol"</span><span class="plain">);</span>
            <span class="reserved">else</span>
                <span class="functiontext">Errors::fatal_with_text</span><span class="plain">(</span><span class="string">"extract can only be to Z or G, not %S"</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">Dictionaries::get_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"SCRIPT"</span><span class="plain">), </span><span class="string">"%f"</span><span class="plain">, </span><span class="identifier">script_file</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_5"></a><b>&#167;1.1.1.2.3.2.5.  </b>The <code class="display"><span class="extract">exists</span></code> command requires a file to exist on disc.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Require existence of file</span> <span class="cwebmacronumber">1.1.1.2.3.2.5</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">TEST_ACTION</span><span class="plain">) {</span>
            <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">putative</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">TextFiles::exists</span><span class="plain">(</span><span class="identifier">putative</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) {</span>
                <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"file doesn't exist: %f"</span><span class="plain">, </span><span class="identifier">putative</span><span class="plain">);</span>
                <span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">; </span><span class="identifier">passed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
                &lt;<span class="cwebmacro">Or...</span> <span class="cwebmacronumber">1.1.1.2.3.2.1.1</span>&gt;<span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_6"></a><b>&#167;1.1.1.2.3.2.6.  </b>The <code class="display"><span class="extract">show</span></code> and <code class="display"><span class="extract">show i6</span></code> commands both use this:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Show file</span> <span class="cwebmacronumber">1.1.1.2.3.2.6</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">putative</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">TextFiles::exists</span><span class="plain">(</span><span class="identifier">putative</span><span class="plain">)) {</span>
            <span class="functiontext">Extractor::cat</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">putative</span><span class="plain">);</span>
            <span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="identifier">passed</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"can't show file, as it doesn't exist: %f"</span><span class="plain">, </span><span class="identifier">putative</span><span class="plain">);</span>
            <span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            &lt;<span class="cwebmacro">Or...</span> <span class="cwebmacronumber">1.1.1.2.3.2.1.1</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a> (three times).</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_7"></a><b>&#167;1.1.1.2.3.2.7.  </b>The <code class="display"><span class="extract">hash</span></code> command hashes the first-named file, writing the resulting
checksum to the second-named file, and also remembering its value.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Carry out a hash</span> <span class="cwebmacronumber">1.1.1.2.3.2.7</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">action_type</span><span class="plain"> == </span><span class="constant">TEST_ACTION</span><span class="plain">) {</span>
            <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
            <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">second</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(1, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">to_hash</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">checksum</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">second</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">hash_utility</span><span class="plain"> = </span><span class="functiontext">Globals::get</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"hash_utility"</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">hash_utility</span><span class="plain">) &gt; 0) {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
                <span class="functiontext">Shell::plain_text</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">hash_utility</span><span class="plain">);</span>
                <span class="functiontext">Shell::plain</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">" "</span><span class="plain">);</span>
                <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">to_hash</span><span class="plain">);</span>
                <span class="functiontext">Shell::redirect</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">checksum</span><span class="plain">);</span>
                <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">hash_value</span><span class="plain"> = </span><span class="functiontext">Dictionaries::get_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"HASHCODE"</span><span class="plain">);</span>
                <span class="functiontext">Hasher::read_hash</span><span class="plain">(</span><span class="identifier">hash_value</span><span class="plain">, </span><span class="identifier">checksum</span><span class="plain">);</span>
                <span class="identifier">hash_value_written</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Hasher::compare_hashes</span><span class="plain">(</span><span class="identifier">tc</span><span class="plain">, </span><span class="identifier">hash_value</span><span class="plain">)) {</span>
                    <span class="identifier">still_going</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
                    <span class="identifier">passed</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
                    <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">); </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">verdict</span><span class="plain">, </span><span class="string">"passed (ending test early on hash value grounds)"</span><span class="plain">);</span>
                    &lt;<span class="cwebmacro">Or...</span> <span class="cwebmacronumber">1.1.1.2.3.2.1.1</span>&gt;<span class="plain">;</span>
                    <span class="identifier">left_bracket</span><span class="plain"> = </span><span class="character">'('</span><span class="plain">;</span>
                    <span class="identifier">right_bracket</span><span class="plain"> = </span><span class="character">')'</span><span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_8"></a><b>&#167;1.1.1.2.3.2.8.  </b>The <code class="display"><span class="extract">copy</span></code> command copies the first-named file to the second filename.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Copy a file</span> <span class="cwebmacronumber">1.1.1.2.3.2.8</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">second</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(1, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">from</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">to</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="identifier">second</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"cp -p "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">from</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_file</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">to</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP1_1_1_2_3_2_9"></a><b>&#167;1.1.1.2.3.2.9.  </b>The <code class="display"><span class="extract">mkdir</span></code> command ensures that a named directory exists.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Make a directory</span> <span class="cwebmacronumber">1.1.1.2.3.2.9</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">ENTRY_IN_LINKED_LIST</span><span class="plain">(0, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">-</span><span class="element">&gt;recipe_tokens</span><span class="plain">);</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">to_make</span><span class="plain"> = </span><span class="functiontext">Tester::extract_as_pathname</span><span class="plain">(</span><span class="identifier">first</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"mkdir -p "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_path</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">to_make</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP1_1_1_2_3_2">&#167;1.1.1.2.3.2</a>.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b></p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Tester::extract_source_to_file</span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">test_case</span><span class="plain"> *</span><span class="identifier">tc</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">tc</span><span class="plain">) </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_me_detected</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">TO</span><span class="plain"> = &amp;</span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
            <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"unable to write to file"</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">tc</span><span class="plain">)</span>
            <span class="functiontext">Extractor::run</span><span class="plain">(</span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_location</span><span class="plain">, </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;format_reference</span><span class="plain">,</span>
                <span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;letter_reference</span><span class="plain">, </span><span class="constant">SOURCE_ACTION</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> (</span><span class="identifier">tc</span><span class="plain">)?(</span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;test_me_detected</span><span class="plain">):</span><span class="constant">FALSE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Tester::extract_source_to_file is used in <a href="#SP1_1_1_2_3_2_4">&#167;1.1.1.2.3.2.4</a>.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Purging. </b>Tests can do quite a variety of things to the thread work area, so we'll
clean it out to factory-fresh contents.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Tester::purge_all_work_areas</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">n</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) </span><span class="functiontext">Tester::purge_work_area</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Tester::purge_work_area</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">) {</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Thread_Work_Area</span><span class="plain"> = </span><span class="functiontext">Scheduler::work_area</span><span class="plain">(</span><span class="identifier">n</span><span class="plain">);</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Example_materials</span><span class="plain"> =</span>
            <span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">Thread_Work_Area</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Example.materials"</span><span class="plain">);</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Example_inform</span><span class="plain"> =</span>
            <span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">Thread_Work_Area</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Example.inform"</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Remove text files from the work area</span> <span class="cwebmacronumber">3.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Remove miscellaneous files from the materials</span> <span class="cwebmacronumber">3.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Clean out the project, too</span> <span class="cwebmacronumber">3.3</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Tester::purge_all_work_areas is used in 1/mn (<a href="1-mn.html#SP1_4">&#167;1.4</a>).</p>

<p class="endnote">The function Tester::purge_work_area is used in <a href="#SP1_1">&#167;1.1</a>.</p>

<p class="inwebparagraph"><a id="SP3_1"></a><b>&#167;3.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Remove text files from the work area</span> <span class="cwebmacronumber">3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"cd "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_path</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">Thread_Work_Area</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"; rm -f *.txt"</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP3_2"></a><b>&#167;3.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Remove miscellaneous files from the materials</span> <span class="cwebmacronumber">3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"find "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_path</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">Example_materials</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">" -mindepth 1 -delete"</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP3_3"></a><b>&#167;3.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Clean out the project, too</span> <span class="cwebmacronumber">3.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">)</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"cd "</span><span class="plain">);</span>
        <span class="functiontext">Shell::quote_path</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="identifier">Example_inform</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">, </span><span class="string">"; rm -f Build/*.*; rm -f Index/Details/*.*;  rm -f Index/*.*"</span><span class="plain">);</span>
        <span class="functiontext">Shell::run</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">COMMAND</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>When we want a filename, we don't want it quoted.
</p>


<pre class="display">
    <span class="reserved">filename</span><span class="plain"> *</span><span class="functiontext">Tester::extract_as_filename</span><span class="plain">(</span><span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">, </span><span class="reserved">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">) {</span>
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Str::get_first_char</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">) == </span><span class="constant">SHELL_QUOTE_CHARACTER</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="functiontext">Str::get_last_char</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">) == </span><span class="constant">SHELL_QUOTE_CHARACTER</span><span class="plain">)) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">L</span><span class="plain"> = </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=1; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">L</span><span class="plain">-1; </span><span class="identifier">i</span><span class="plain">++)</span>
                <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">));</span>
            <span class="identifier">F</span><span class="plain"> = </span><span class="functiontext">Filenames::from_text</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">F</span><span class="plain"> = </span><span class="functiontext">Filenames::from_text</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">F</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="reserved">pathname</span><span class="plain"> *</span><span class="functiontext">Tester::extract_as_pathname</span><span class="plain">(</span><span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">, </span><span class="reserved">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">) {</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Str::get_first_char</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">) == </span><span class="constant">SHELL_QUOTE_CHARACTER</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="functiontext">Str::get_last_char</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">) == </span><span class="constant">SHELL_QUOTE_CHARACTER</span><span class="plain">)) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">L</span><span class="plain"> = </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=1; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">L</span><span class="plain">-1; </span><span class="identifier">i</span><span class="plain">++)</span>
                <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">));</span>
            <span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">P</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Tester::extract_as_filename is used in <a href="#SP1_1_1_2_3_2_1_1">&#167;1.1.1.2.3.2.1.1</a>, <a href="#SP1_1_1_2_3_2_3">&#167;1.1.1.2.3.2.3</a>, <a href="#SP1_1_1_2_3_2_4">&#167;1.1.1.2.3.2.4</a>, <a href="#SP1_1_1_2_3_2_5">&#167;1.1.1.2.3.2.5</a>, <a href="#SP1_1_1_2_3_2_6">&#167;1.1.1.2.3.2.6</a>, <a href="#SP1_1_1_2_3_2_7">&#167;1.1.1.2.3.2.7</a>, <a href="#SP1_1_1_2_3_2_8">&#167;1.1.1.2.3.2.8</a>.</p>

<p class="endnote">The function Tester::extract_as_pathname is used in <a href="#SP1_1_1_2_3_2_9">&#167;1.1.1.2.3.2.9</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Token expansion. </b>At run-time, the contents of a token usually need to be expanded before they
can be used; the result will depend on what test case is being run through
the recipe, which is why this isn't done at compile time.
</p>

<p class="inwebparagraph">Expansion is the process of replacing variables like <code class="display"><span class="extract">$PATH</span></code> with their
values. We have two versions of this. Simple expansion, as follows, does
just that and no more. Note that the <code class="display"><span class="extract">$$</span></code> notation is meaningful only for
filenames in the settings file, not for local variables.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">, </span><span class="reserved">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">) {</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">original</span><span class="plain"> = </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;token_text</span><span class="plain">;</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">VARIABLES</span><span class="plain">, </span><span class="string">"From %S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">original</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">);</span>
        <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="identifier">original</span><span class="plain">);</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*)$$(%i+)(%c*)"</span><span class="plain">)) {</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain"> = </span><span class="functiontext">Globals::to_filename</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">F</span><span class="plain">) {</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="string">"%f"</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="functiontext">Errors::with_text</span><span class="plain">(</span><span class="string">"no such setting as %S"</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="string">"(novalue)"</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[2]);</span>
        <span class="plain">}</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*)$(%i+)(%c*)"</span><span class="plain">)) {</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">dv</span><span class="plain"> = </span><span class="functiontext">Dictionaries::get_text</span><span class="plain">(</span><span class="identifier">D</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">dv</span><span class="plain">) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">dv</span><span class="plain">);</span>
            <span class="reserved">else</span><span class="plain"> {</span>
                <span class="functiontext">Errors::with_text</span><span class="plain">(</span><span class="string">"no such variable as %S"</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="string">"(novalue)"</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">unsubstituted</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[2]);</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">unsubstituted</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">VARIABLES</span><span class="plain">, </span><span class="string">"To %S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">unsubstituted</span><span class="plain">);</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Tester::expand is used in <a href="#SP1_1_1_2_3_1">&#167;1.1.1.2.3.1</a>, <a href="#SP1_1_1_2_3_2_2">&#167;1.1.1.2.3.2.2</a>, <a href="#SP1_1_1_2_3_2_4">&#167;1.1.1.2.3.2.4</a>, <a href="#SP4">&#167;4</a>, <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>Quote expansion is similar, but treats the text as something which needs
to end up in quotation marks so that the shell will treat it as a single
lexical token.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Tester::quote_expand</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">, </span><span class="reserved">dictionary</span><span class="plain"> *</span><span class="identifier">D</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">);</span>

        <span class="functiontext">Tester::expand</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;token_indirects_to_file</span><span class="plain">) </span>&lt;<span class="cwebmacro">Expand token from file</span> <span class="cwebmacronumber">6.3</span>&gt;
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;token_quoted</span><span class="plain"> == </span><span class="constant">NOT_APPLICABLE</span><span class="plain">) </span>&lt;<span class="cwebmacro">Expand token from text</span> <span class="cwebmacronumber">6.2</span>&gt;
        <span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">Apply quotation marks as needed</span> <span class="cwebmacronumber">6.1</span>&gt;<span class="plain">;</span>

        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Tester::quote_expand is used in <a href="#SP1_1_1_2_3_2_1">&#167;1.1.1.2.3.2.1</a>, <a href="#SP1_1_1_2_3_2_2">&#167;1.1.1.2.3.2.2</a>, <a href="#SP6_2">&#167;6.2</a>, <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP6_1"></a><b>&#167;6.1.  </b>Note the manoeuvre to avoid trouble with shell redirection: <code class="display"><span class="extract">&gt;'Fred'</span></code> is
a legal redirection, but <code class="display"><span class="extract">'&gt;Fred'</span></code> is not; and <code class="display"><span class="extract">2&gt;&amp;1</span></code> joins standard errors
to standard output, but <code class="display"><span class="extract">2&gt;'&amp;1'</span></code> sends errors to a file literally called <code class="display"><span class="extract">&amp;1</span></code>.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Apply quotation marks as needed</span> <span class="cwebmacronumber">6.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">quoted</span><span class="plain">);</span>
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = </span><span class="functiontext">Str::get_first_char</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">n</span><span class="plain"> = </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;token_quoted</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">c</span><span class="plain"> == </span><span class="character">'&gt;'</span><span class="plain">) || (</span><span class="identifier">c</span><span class="plain"> == </span><span class="character">'&lt;'</span><span class="plain">)) { </span><span class="identifier">PUT</span><span class="plain">(</span><span class="identifier">c</span><span class="plain">); </span><span class="functiontext">Str::delete_first_character</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">); }</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Characters::isdigit</span><span class="plain">(</span><span class="identifier">c</span><span class="plain">)) &amp;&amp; (</span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">, 1) == </span><span class="character">'&gt;'</span><span class="plain">)) {</span>
            <span class="identifier">PUT</span><span class="plain">(</span><span class="identifier">c</span><span class="plain">); </span><span class="identifier">PUT</span><span class="plain">(</span><span class="character">'&gt;'</span><span class="plain">);</span>
            <span class="functiontext">Str::delete_first_character</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">);</span>
            <span class="functiontext">Str::delete_first_character</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">, 0) == </span><span class="character">'&amp;'</span><span class="plain">) </span><span class="identifier">n</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain"> != </span><span class="constant">FALSE</span><span class="plain">) </span><span class="functiontext">Shell::plain_text</span><span class="plain">(</span><span class="identifier">quoted</span><span class="plain">, </span><span class="identifier">unquoted</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="functiontext">Shell::quote_text</span><span class="plain">(</span><span class="identifier">quoted</span><span class="plain">, </span><span class="identifier">unquoted</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">quoted</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">quoted</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_2"></a><b>&#167;6.2.  </b>This is what happens to backticked tokens: they're retokenised and each is
individually quote-expanded.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Expand token from text</span> <span class="cwebmacronumber">6.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">recipe_token</span><span class="plain">);</span>
        <span class="functiontext">Delia::tokenise</span><span class="plain">(</span><span class="identifier">L</span><span class="plain">, </span><span class="identifier">unquoted</span><span class="plain">);</span>
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">ET</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> = 0;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">ET</span><span class="plain">, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain">++ &gt; 0) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" "</span><span class="plain">);</span>
            <span class="functiontext">Tester::quote_expand</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">ET</span><span class="plain">, </span><span class="identifier">D</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_3"></a><b>&#167;6.3.  </b>Expanding from a file is similar, but more work; we need to read the file
in, one line at a time. (Each line is expanded.)
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Expand token from file</span> <span class="cwebmacronumber">6.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain"> = </span><span class="functiontext">Filenames::from_text</span><span class="plain">(</span><span class="identifier">unquoted</span><span class="plain">);</span>
        <span class="reserved">token_expand_state</span><span class="plain"> </span><span class="identifier">T</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="element">.expand_to</span><span class="plain"> = </span><span class="identifier">OUT</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="element">.expand_from</span><span class="plain"> = </span><span class="identifier">D</span><span class="plain">;</span>
        <span class="functiontext">TextFiles::read</span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open file of recipe line arguments"</span><span class="plain">,</span>
            <span class="constant">TRUE</span><span class="plain">, &amp;</span><span class="functiontext">Tester::read_tokens</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">T</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b>...which makes use of:
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">token_expand_state</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">expand_to</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">dictionary</span><span class="plain"> *</span><span class="identifier">expand_from</span><span class="plain">;</span>
    <span class="plain">} </span><span class="reserved">token_expand_state</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Tester::read_tokens</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line_text</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">vTES</span><span class="plain">) {</span>
        <span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">recipe_token</span><span class="plain">);</span>
        <span class="functiontext">Delia::tokenise</span><span class="plain">(</span><span class="identifier">L</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
        <span class="reserved">token_expand_state</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain"> = (</span><span class="reserved">token_expand_state</span><span class="plain"> *) </span><span class="identifier">vTES</span><span class="plain">;</span>
        <span class="reserved">recipe_token</span><span class="plain"> *</span><span class="identifier">RT</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> = 0;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">RT</span><span class="plain">, </span><span class="reserved">recipe_token</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain">++ &gt; 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;expand_to</span><span class="plain">, </span><span class="string">" "</span><span class="plain">);</span>
            <span class="functiontext">Tester::quote_expand</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;expand_to</span><span class="plain">, </span><span class="identifier">RT</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;expand_from</span><span class="plain">);</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Tester::read_tokens is used in <a href="#SP6_3">&#167;6.3</a>.</p>

<p class="endnote">The structure token_expand_state is private to this section.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="4-tdc.html">Back to 'The Delia Compiler'</a></li><li><i>(This section ends Chapter 4: Recipes.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

