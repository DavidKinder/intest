<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>The Historian</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../index.html">Sources</a></h1>
<ul><li><a href="index.html"><span class="selectedlink">intest</span></a></li>
</ul><h2>Foundation Module</h2><ul>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>
</ul><h2>External</h2><ul>
<li><a href="https://github.com/ganelson/intest">github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="../../../inweb/docs/index.html">inweb</a></li>
<li><a href="../../../inform/docs/index.html">inform</a></li>

</ul>
		</nav>
		<main role="main">
		
<!--Weave of 'The Historian' generated by 7-->
<ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">intest</a></li><li><a href="index.html#2">Chapter 2: Test Cases and Instructions</a></li><li><b>The Historian</b></li></ul><p class="purpose">To preserve a recent command history on disc.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. History storage</a></li><li><a href="#SP4">&#167;4. Research</a></li><li><a href="#SP5">&#167;5. Reading history</a></li><li><a href="#SP6">&#167;6. Writing history</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. History storage. </b>Recall that the history file records two things: past commands, such as <code class="display"><span class="extract">?2</span></code>,
stored in memory thus. The "epoch" is a number representing when this was;
for <code class="display"><span class="extract">?2</span></code>, it would be 2.
</p>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">historic_moment</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">epoch</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">token_list</span><span class="plain">; </span><span class="comment"> of <code class="display"><span class="extract">text_stream</span></code></span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">historic_moment</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure historic_moment is private to this section.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b></p>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">present_epoch</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
    <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">present_moment</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::create_present_moment<button class="popup" onclick="togglePopup('usagePopup36')">...<span class="popuptext" id="usagePopup36">Usage of <b>Historian::create_present_moment</b>:<br><a href="#SP4">&#167;4</a></span></button></span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">argc</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> **</span><span class="identifier">argv</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">argc</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">historic_moment</span><span class="plain">);</span>
            <span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">epoch</span><span class="plain"> = </span><span class="identifier">present_epoch</span><span class="plain">;</span>
            <span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">token_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain">);</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="identifier">c</span><span class="plain">&lt;</span><span class="identifier">argc</span><span class="plain">; </span><span class="identifier">c</span><span class="plain">++) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">argv</span><span class="plain">[</span><span class="identifier">c</span><span class="plain">]);</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">token_list</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="identifier">present_moment</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>...and preset cases, such as <code class="display"><span class="extract">1</span></code>, stored as follows. The Historian is
notified of any failed tests by the Tester.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_PRESET_CASES</span><span class="plain"> </span><span class="constant">99</span>
</pre>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_preset_cases</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="constant">MAX_PRESET_CASES</span><span class="plain"> + </span><span class="constant">1</span><span class="plain">];</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::notify_failure_count<button class="popup" onclick="togglePopup('usagePopup37')">...<span class="popuptext" id="usagePopup37">Usage of <b>Historian::notify_failure_count</b>:<br>The Scheduler - <a href="3-ts.html#SP9_4_2">&#167;9.4.2</a></span></button></span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain">) {</span>
        <span class="identifier">no_preset_cases</span><span class="plain"> = </span><span class="identifier">f</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::notify_failure<button class="popup" onclick="togglePopup('usagePopup38')">...<span class="popuptext" id="usagePopup38">Usage of <b>Historian::notify_failure</b>:<br>The Scheduler - <a href="3-ts.html#SP9_4_2">&#167;9.4.2</a></span></button></span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">p</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">f</span><span class="plain"> &lt;= </span><span class="constant">MAX_PRESET_CASES</span><span class="plain">) </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">] = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">p</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Research. </b>The historian runs in two phases. "Research" involves reading the history
file in, then performing substitution on the command. "Writing up" involves
writing the updated history file back again. One happens at the start of
Intest's run, the other at the end.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::research<button class="popup" onclick="togglePopup('usagePopup39')">...<span class="popuptext" id="usagePopup39">Usage of <b>Historian::research</b>:<br>Main - <a href="1-mn.html#SP1">&#167;1</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">H</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> *</span><span class="identifier">argc</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> ***</span><span class="identifier">argv</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">display_mode</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">epoch_to_repeat</span><span class="plain"> = -1;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">expands</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Detect a ? or ?N request</span> <span class="cwebmacronumber">4.1</span>&gt;<span class="plain">;</span>
        <span class="functiontext"><a href="#SP5">Historian::read_history_file</a></span><span class="plain">(</span><span class="identifier">H</span><span class="plain">, </span><span class="identifier">display_mode</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Complete a ? request</span> <span class="cwebmacronumber">4.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Complete a ?N request</span> <span class="cwebmacronumber">4.3</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Substitute preset case numbers</span> <span class="cwebmacronumber">4.4</span>&gt;<span class="plain">;</span>
        <span class="functiontext"><a href="#SP2">Historian::create_present_moment</a></span><span class="plain">(*</span><span class="identifier">argc</span><span class="plain">, *</span><span class="identifier">argv</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">expands</span><span class="plain">) { </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Expanded to: "</span><span class="plain">); </span><span class="functiontext"><a href="#SP6">Historian::write_command</a></span><span class="plain">(</span><span class="constant">STDOUT</span><span class="plain">, </span><span class="identifier">present_moment</span><span class="plain">); }</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4_1"></a><b>&#167;4.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Detect a ? or ?N request</span> <span class="cwebmacronumber">4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (*</span><span class="identifier">argc</span><span class="plain"> == </span><span class="constant">2</span><span class="plain">) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">first_word</span><span class="plain"> = (*</span><span class="identifier">argv</span><span class="plain">)[1];</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">first_word</span><span class="plain">, </span><span class="constant">0</span><span class="plain">) == </span><span class="character">'?'</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">first_word</span><span class="plain">) == </span><span class="constant">1</span><span class="plain">) </span><span class="identifier">display_mode</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="identifier">epoch_to_repeat</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP7">Str::atoi</a></span><span class="plain">(</span><span class="identifier">first_word</span><span class="plain">, </span><span class="constant">1</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_2"></a><b>&#167;4.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Complete a ? request</span> <span class="cwebmacronumber">4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">display_mode</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_preset_cases</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">)</span>
                <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">f</span><span class="plain"> &lt; </span><span class="identifier">no_preset_cases</span><span class="plain">; </span><span class="identifier">f</span><span class="plain">++) {</span>
                    <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"%d = %S"</span><span class="plain">, </span><span class="identifier">f</span><span class="plain">+1, </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">]);</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">f</span><span class="plain"> &lt; </span><span class="identifier">no_preset_cases</span><span class="plain">-1) </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"; "</span><span class="plain">);</span>
                    <span class="reserved">else</span><span class="plain"> </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"\n"</span><span class="plain">);</span>
                <span class="plain">}</span>
            <span class="plain">*</span><span class="identifier">argc</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_3"></a><b>&#167;4.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Complete a ?N request</span> <span class="cwebmacronumber">4.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">to_repeat</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (*</span><span class="identifier">argc</span><span class="plain"> == </span><span class="constant">1</span><span class="plain">) </span><span class="identifier">to_repeat</span><span class="plain"> = </span><span class="identifier">present_moment</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">epoch_to_repeat</span><span class="plain"> != -1) {</span>
            <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">hm</span><span class="plain">, </span><span class="reserved">historic_moment</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">epoch</span><span class="plain"> == </span><span class="identifier">epoch_to_repeat</span><span class="plain">)</span>
                    <span class="identifier">to_repeat</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">to_repeat</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
                <span class="functiontext"><a href="3-em.html#SP2">Errors::fatal</a></span><span class="plain">(</span><span class="string">"no previous command with that number (try '?')"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">to_repeat</span><span class="plain">) {</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Repeating: "</span><span class="plain">); </span><span class="functiontext"><a href="#SP6">Historian::write_command</a></span><span class="plain">(</span><span class="constant">STDOUT</span><span class="plain">, </span><span class="identifier">to_repeat</span><span class="plain">);</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">to_repeat</span><span class="plain">-&gt;</span><span class="element">token_list</span><span class="plain">) </span><span class="identifier">c</span><span class="plain">++;</span>
            <span class="plain">*</span><span class="identifier">argv</span><span class="plain"> = </span><span class="functiontext"><a href="2-mmr.html#SP25">Memory::I7_calloc</a></span><span class="plain">(</span><span class="identifier">c</span><span class="plain">+1, </span><span class="reserved">sizeof</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *), </span><span class="constant">COMMAND_HISTORY_MREASON</span><span class="plain">);</span>
            <span class="plain">*</span><span class="identifier">argc</span><span class="plain"> = </span><span class="identifier">c</span><span class="plain">+1;</span>
            <span class="identifier">c</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; (*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">c</span><span class="plain">++] = </span><span class="functiontext"><a href="4-sm.html#SP4">Str::new_from_ISO_string</a></span><span class="plain">(</span><span class="string">"intest"</span><span class="plain">);</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">to_repeat</span><span class="plain">-&gt;</span><span class="element">token_list</span><span class="plain">)</span>
                <span class="plain">(*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">c</span><span class="plain">++] = </span><span class="identifier">tok</span><span class="plain">;</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_4"></a><b>&#167;4.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute preset case numbers</span> <span class="cwebmacronumber">4.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=1; </span><span class="identifier">i</span><span class="plain">&lt;*</span><span class="identifier">argc</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, (*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">i</span><span class="plain">], </span><span class="identifier">L</span><span class="string">"%d+"</span><span class="plain">))</span>
                <span class="identifier">expands</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">expands</span><span class="plain">) {</span>
            <span class="reserved">text_stream</span><span class="plain"> **</span><span class="identifier">new_argv</span><span class="plain"> =</span>
                <span class="functiontext"><a href="2-mmr.html#SP25">Memory::I7_calloc</a></span><span class="plain">(*</span><span class="identifier">argc</span><span class="plain">, </span><span class="reserved">sizeof</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *), </span><span class="constant">COMMAND_HISTORY_MREASON</span><span class="plain">);</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;*</span><span class="identifier">argc</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">p</span><span class="plain"> = (*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">i</span><span class="plain">];</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain">&gt;0) &amp;&amp; (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">p</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%d+"</span><span class="plain">))) {</span>
                    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP7">Str::atoi</a></span><span class="plain">(</span><span class="identifier">p</span><span class="plain">, </span><span class="constant">0</span><span class="plain">);</span>
                    <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">f</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">f</span><span class="plain"> &lt;= </span><span class="identifier">no_preset_cases</span><span class="plain">))</span>
                        <span class="identifier">new_argv</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">] = </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">-1];</span>
                    <span class="reserved">else</span>
                        <span class="functiontext"><a href="3-em.html#SP2">Errors::fatal_with_text</a></span><span class="plain">(</span><span class="string">"no test case of that number (try '?'): %S"</span><span class="plain">, </span><span class="identifier">p</span><span class="plain">);</span>
                <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">new_argv</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">] = </span><span class="identifier">p</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="plain">*</span><span class="identifier">argv</span><span class="plain"> = </span><span class="identifier">new_argv</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Reading history. </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::read_history_file<button class="popup" onclick="togglePopup('usagePopup40')">...<span class="popuptext" id="usagePopup40">Usage of <b>Historian::read_history_file</b>:<br><a href="#SP4">&#167;4</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">H</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">display_mode</span><span class="plain">) {</span>
        <span class="functiontext"><a href="4-tf.html#SP5">TextFiles::read</a></span><span class="plain">(</span><span class="identifier">H</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, &amp;</span><span class="functiontext"><a href="#SP5">Historian::read</a></span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">display_mode</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::read<button class="popup" onclick="togglePopup('usagePopup41')">...<span class="popuptext" id="usagePopup41">Usage of <b>Historian::read</b>:<br>none</span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line_text</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">dmp</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">display_mode</span><span class="plain"> = *((</span><span class="reserved">int</span><span class="plain"> *) </span><span class="identifier">dmp</span><span class="plain">);</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%?(%d+). (%c*)"</span><span class="plain">)) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">);</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
            <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1]);</span>

            <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">historic_moment</span><span class="plain">);</span>
            <span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">epoch</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP7">Str::atoi</a></span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">, </span><span class="constant">0</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">epoch</span><span class="plain"> &gt;= </span><span class="identifier">present_epoch</span><span class="plain">) </span><span class="identifier">present_epoch</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">epoch</span><span class="plain"> + </span><span class="constant">1</span><span class="plain">;</span>
            <span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">token_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain">);</span>
            <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">command_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%C+) *(%c*)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain"> = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">token_list</span><span class="plain">);</span>
                <span class="functiontext"><a href="4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1]);</span>
            <span class="plain">}</span>
            <span class="identifier">present_moment</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">display_mode</span><span class="plain">) </span><span class="functiontext"><a href="#SP6">Historian::write_command</a></span><span class="plain">(</span><span class="constant">STDOUT</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%d+) = *(%c*)"</span><span class="plain">))</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_preset_cases</span><span class="plain"> &lt; </span><span class="constant">MAX_PRESET_CASES</span><span class="plain">)</span>
                <span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">no_preset_cases</span><span class="plain">++] = </span><span class="functiontext"><a href="4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1]);</span>
        <span class="functiontext"><a href="4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. Writing history. </b></p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_HISTORICAL_RECORD</span><span class="plain"> </span><span class="constant">20</span>
</pre>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::write_up<button class="popup" onclick="togglePopup('usagePopup42')">...<span class="popuptext" id="usagePopup42">Usage of <b>Historian::write_up</b>:<br>Main - <a href="1-mn.html#SP1">&#167;1</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">H</span><span class="plain">) {</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">TO</span><span class="plain"> = &amp;</span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">H</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">recorded_time</span><span class="plain"> = </span><span class="identifier">NUMBER_CREATED</span><span class="plain">(</span><span class="reserved">historic_moment</span><span class="plain">) - </span><span class="constant">MAX_HISTORICAL_RECORD</span><span class="plain">;</span>
        <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">hm</span><span class="plain">, </span><span class="reserved">historic_moment</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">allocation_id</span><span class="plain"> &gt;= </span><span class="identifier">recorded_time</span><span class="plain">)</span>
                <span class="functiontext"><a href="#SP6">Historian::write_command</a></span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">);</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">f</span><span class="plain"> &lt; </span><span class="identifier">no_preset_cases</span><span class="plain">; </span><span class="identifier">f</span><span class="plain">++)</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="string">"%d = %S\n"</span><span class="plain">, </span><span class="identifier">f</span><span class="plain">+1, </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">]);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::write_command<button class="popup" onclick="togglePopup('usagePopup43')">...<span class="popuptext" id="usagePopup43">Usage of <b>Historian::write_command</b>:<br><a href="#SP4">&#167;4</a>, <a href="#SP4_3">&#167;4.3</a>, <a href="#SP5">&#167;5</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain">) {</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"?%d."</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">epoch</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-&gt;</span><span class="element">token_list</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" %S"</span><span class="plain">, </span><span class="identifier">tok</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\n"</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="2-act.html">Back to 'Actions'</a></li><li><a href="2-te.html">Continue with 'The Extractor'</a></li></ul><hr class="tocbar">
<!--End of weave-->
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
		</main>
	</body>
</html>

