<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>2/act</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '2/th' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">intest 2.0</a></li><li><a href="index.html#2">Chapter 2: Test Cases and Instructions</a></li><li><b>The Historian</b></li></ul><p class="purpose">To preserve a recent command history on disc.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. History storage</a></li><li><a href="#SP4">&#167;4. Research</a></li><li><a href="#SP5">&#167;5. Reading history</a></li><li><a href="#SP6">&#167;6. Writing history</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. History storage. </b>Recall that the history file records two things: past commands, such as <code class="display"><span class="extract">?2</span></code>,
stored in memory thus. The "epoch" is a number representing when this was;
for <code class="display"><span class="extract">?2</span></code>, it would be 2.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">historic_moment</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">epoch</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">token_list</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">text_stream</span></code></span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">historic_moment</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure historic_moment is private to this section.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b></p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">present_epoch</span><span class="plain"> = 1;</span>
    <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">present_moment</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::create_present_moment</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">argc</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> **</span><span class="identifier">argv</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">argc</span><span class="plain"> &gt; 0) {</span>
            <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">historic_moment</span><span class="plain">);</span>
            <span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;epoch</span><span class="plain"> = </span><span class="identifier">present_epoch</span><span class="plain">;</span>
            <span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;token_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain">);</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = 1; </span><span class="identifier">c</span><span class="plain">&lt;</span><span class="identifier">argc</span><span class="plain">; </span><span class="identifier">c</span><span class="plain">++) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">argv</span><span class="plain">[</span><span class="identifier">c</span><span class="plain">]);</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;token_list</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="identifier">present_moment</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Historian::create_present_moment is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>...and preset cases, such as <code class="display"><span class="extract">1</span></code>, stored as follows. The Historian is
notified of any failed tests by the Tester.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_PRESET_CASES</span><span class="plain"> 99</span>
</pre>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_preset_cases</span><span class="plain"> = 0;</span>
    <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="constant">MAX_PRESET_CASES</span><span class="plain"> + 1];</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::notify_failure_count</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain">) {</span>
        <span class="identifier">no_preset_cases</span><span class="plain"> = </span><span class="identifier">f</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::notify_failure</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">p</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">f</span><span class="plain"> &lt;= </span><span class="constant">MAX_PRESET_CASES</span><span class="plain">) </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">] = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">p</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Historian::notify_failure_count is used in 3/ts (<a href="3-ts.html#SP9_4_2">&#167;9.4.2</a>).</p>

<p class="endnote">The function Historian::notify_failure is used in 3/ts (<a href="3-ts.html#SP9_4_2">&#167;9.4.2</a>).</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Research. </b>The historian runs in two phases. "Research" involves reading the history
file in, then performing substitution on the command. "Writing up" involves
writing the updated history file back again. One happens at the start of
Intest's run, the other at the end.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::research</span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">H</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> *</span><span class="identifier">argc</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> ***</span><span class="identifier">argv</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">display_mode</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">epoch_to_repeat</span><span class="plain"> = -1;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">expands</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Detect a ? or ?N request</span> <span class="cwebmacronumber">4.1</span>&gt;<span class="plain">;</span>
        <span class="functiontext">Historian::read_history_file</span><span class="plain">(</span><span class="identifier">H</span><span class="plain">, </span><span class="identifier">display_mode</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Complete a ? request</span> <span class="cwebmacronumber">4.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Complete a ?N request</span> <span class="cwebmacronumber">4.3</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Substitute preset case numbers</span> <span class="cwebmacronumber">4.4</span>&gt;<span class="plain">;</span>
        <span class="functiontext">Historian::create_present_moment</span><span class="plain">(*</span><span class="identifier">argc</span><span class="plain">, *</span><span class="identifier">argv</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">expands</span><span class="plain">) { </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Expanded to: "</span><span class="plain">); </span><span class="functiontext">Historian::write_command</span><span class="plain">(</span><span class="constant">STDOUT</span><span class="plain">, </span><span class="identifier">present_moment</span><span class="plain">); }</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Historian::research is used in 1/mn (<a href="1-mn.html#SP1">&#167;1</a>).</p>

<p class="inwebparagraph"><a id="SP4_1"></a><b>&#167;4.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Detect a ? or ?N request</span> <span class="cwebmacronumber">4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (*</span><span class="identifier">argc</span><span class="plain"> == 2) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">first_word</span><span class="plain"> = (*</span><span class="identifier">argv</span><span class="plain">)[1];</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">first_word</span><span class="plain">, 0) == </span><span class="character">'?'</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">first_word</span><span class="plain">) == 1) </span><span class="identifier">display_mode</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="identifier">epoch_to_repeat</span><span class="plain"> = </span><span class="functiontext">Str::atoi</span><span class="plain">(</span><span class="identifier">first_word</span><span class="plain">, 1);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_2"></a><b>&#167;4.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Complete a ? request</span> <span class="cwebmacronumber">4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">display_mode</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_preset_cases</span><span class="plain"> &gt; 0)</span>
                <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain"> = 0; </span><span class="identifier">f</span><span class="plain"> &lt; </span><span class="identifier">no_preset_cases</span><span class="plain">; </span><span class="identifier">f</span><span class="plain">++) {</span>
                    <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"%d = %S"</span><span class="plain">, </span><span class="identifier">f</span><span class="plain">+1, </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">]);</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">f</span><span class="plain"> &lt; </span><span class="identifier">no_preset_cases</span><span class="plain">-1) </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"; "</span><span class="plain">);</span>
                    <span class="reserved">else</span><span class="plain"> </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
                <span class="plain">}</span>
            <span class="plain">*</span><span class="identifier">argc</span><span class="plain"> = 1;</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_3"></a><b>&#167;4.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Complete a ?N request</span> <span class="cwebmacronumber">4.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">to_repeat</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (*</span><span class="identifier">argc</span><span class="plain"> == 1) </span><span class="identifier">to_repeat</span><span class="plain"> = </span><span class="identifier">present_moment</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">epoch_to_repeat</span><span class="plain"> != -1) {</span>
            <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">hm</span><span class="plain">, </span><span class="reserved">historic_moment</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;epoch</span><span class="plain"> == </span><span class="identifier">epoch_to_repeat</span><span class="plain">)</span>
                    <span class="identifier">to_repeat</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">to_repeat</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
                <span class="functiontext">Errors::fatal</span><span class="plain">(</span><span class="string">"no previous command with that number (try '?')"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">to_repeat</span><span class="plain">) {</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Repeating: "</span><span class="plain">); </span><span class="functiontext">Historian::write_command</span><span class="plain">(</span><span class="constant">STDOUT</span><span class="plain">, </span><span class="identifier">to_repeat</span><span class="plain">);</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = 0;</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">to_repeat</span><span class="plain">-</span><span class="element">&gt;token_list</span><span class="plain">) </span><span class="identifier">c</span><span class="plain">++;</span>
            <span class="plain">*</span><span class="identifier">argv</span><span class="plain"> = </span><span class="functiontext">Memory::I7_calloc</span><span class="plain">(</span><span class="identifier">c</span><span class="plain">+1, </span><span class="reserved">sizeof</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *), </span><span class="constant">COMMAND_HISTORY_MREASON</span><span class="plain">);</span>
            <span class="plain">*</span><span class="identifier">argc</span><span class="plain"> = </span><span class="identifier">c</span><span class="plain">+1;</span>
            <span class="identifier">c</span><span class="plain"> = 0; (*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">c</span><span class="plain">++] = </span><span class="functiontext">Str::new_from_ISO_string</span><span class="plain">(</span><span class="string">"intest"</span><span class="plain">);</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">to_repeat</span><span class="plain">-</span><span class="element">&gt;token_list</span><span class="plain">)</span>
                <span class="plain">(*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">c</span><span class="plain">++] = </span><span class="identifier">tok</span><span class="plain">;</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_4"></a><b>&#167;4.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Substitute preset case numbers</span> <span class="cwebmacronumber">4.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=1; </span><span class="identifier">i</span><span class="plain">&lt;*</span><span class="identifier">argc</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, (*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">i</span><span class="plain">], </span><span class="identifier">L</span><span class="string">"%d+"</span><span class="plain">))</span>
                <span class="identifier">expands</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">expands</span><span class="plain">) {</span>
            <span class="reserved">text_stream</span><span class="plain"> **</span><span class="identifier">new_argv</span><span class="plain"> =</span>
                <span class="functiontext">Memory::I7_calloc</span><span class="plain">(*</span><span class="identifier">argc</span><span class="plain">, </span><span class="reserved">sizeof</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *), </span><span class="constant">COMMAND_HISTORY_MREASON</span><span class="plain">);</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;*</span><span class="identifier">argc</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">p</span><span class="plain"> = (*</span><span class="identifier">argv</span><span class="plain">)[</span><span class="identifier">i</span><span class="plain">];</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain">&gt;0) &amp;&amp; (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">p</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%d+"</span><span class="plain">))) {</span>
                    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain"> = </span><span class="functiontext">Str::atoi</span><span class="plain">(</span><span class="identifier">p</span><span class="plain">, 0);</span>
                    <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">f</span><span class="plain"> &gt; 0) &amp;&amp; (</span><span class="identifier">f</span><span class="plain"> &lt;= </span><span class="identifier">no_preset_cases</span><span class="plain">))</span>
                        <span class="identifier">new_argv</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">] = </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">-1];</span>
                    <span class="reserved">else</span>
                        <span class="functiontext">Errors::fatal_with_text</span><span class="plain">(</span><span class="string">"no test case of that number (try '?'): %S"</span><span class="plain">, </span><span class="identifier">p</span><span class="plain">);</span>
                <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">new_argv</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">] = </span><span class="identifier">p</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="plain">*</span><span class="identifier">argv</span><span class="plain"> = </span><span class="identifier">new_argv</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Reading history. </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::read_history_file</span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">H</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">display_mode</span><span class="plain">) {</span>
        <span class="functiontext">TextFiles::read</span><span class="plain">(</span><span class="identifier">H</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, &amp;</span><span class="functiontext">Historian::read</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">display_mode</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::read</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line_text</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">dmp</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">display_mode</span><span class="plain"> = *((</span><span class="reserved">int</span><span class="plain"> *) </span><span class="identifier">dmp</span><span class="plain">);</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%?(%d+). (%c*)"</span><span class="plain">)) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">);</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>

            <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">historic_moment</span><span class="plain">);</span>
            <span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;epoch</span><span class="plain"> = </span><span class="functiontext">Str::atoi</span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">, 0);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;epoch</span><span class="plain"> &gt;= </span><span class="identifier">present_epoch</span><span class="plain">) </span><span class="identifier">present_epoch</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;epoch</span><span class="plain"> + 1;</span>
            <span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;token_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain">);</span>
            <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">command_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%C+) *(%c*)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;token_list</span><span class="plain">);</span>
                <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
            <span class="plain">}</span>
            <span class="identifier">present_moment</span><span class="plain"> = </span><span class="identifier">hm</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">display_mode</span><span class="plain">) </span><span class="functiontext">Historian::write_command</span><span class="plain">(</span><span class="constant">STDOUT</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">epoch_text</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">command_text</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%d+) = *(%c*)"</span><span class="plain">))</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_preset_cases</span><span class="plain"> &lt; </span><span class="constant">MAX_PRESET_CASES</span><span class="plain">)</span>
                <span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">no_preset_cases</span><span class="plain">++] = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]);</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Historian::read_history_file is used in <a href="#SP4">&#167;4</a>.</p>

<p class="endnote">The function Historian::read appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. Writing history. </b></p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_HISTORICAL_RECORD</span><span class="plain"> 20</span>
</pre>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::write_up</span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">H</span><span class="plain">) {</span>
        <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">TO</span><span class="plain"> = &amp;</span><span class="identifier">TO_struct</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">STREAM_OPEN_TO_FILE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">H</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">recorded_time</span><span class="plain"> = </span><span class="identifier">NUMBER_CREATED</span><span class="plain">(</span><span class="reserved">historic_moment</span><span class="plain">) - </span><span class="constant">MAX_HISTORICAL_RECORD</span><span class="plain">;</span>
        <span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">hm</span><span class="plain">, </span><span class="reserved">historic_moment</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;allocation_id</span><span class="plain"> &gt;= </span><span class="identifier">recorded_time</span><span class="plain">)</span>
                <span class="functiontext">Historian::write_command</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">);</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain"> = 0; </span><span class="identifier">f</span><span class="plain"> &lt; </span><span class="identifier">no_preset_cases</span><span class="plain">; </span><span class="identifier">f</span><span class="plain">++)</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">, </span><span class="string">"%d = %S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">f</span><span class="plain">+1, </span><span class="identifier">preset_cases</span><span class="plain">[</span><span class="identifier">f</span><span class="plain">]);</span>
        <span class="identifier">STREAM_CLOSE</span><span class="plain">(</span><span class="identifier">TO</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Historian::write_command</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">historic_moment</span><span class="plain"> *</span><span class="identifier">hm</span><span class="plain">) {</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"?%d."</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;epoch</span><span class="plain">);</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tok</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">tok</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain">, </span><span class="identifier">hm</span><span class="plain">-</span><span class="element">&gt;token_list</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" %S"</span><span class="plain">, </span><span class="identifier">tok</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Historian::write_up is used in 1/mn (<a href="1-mn.html#SP1">&#167;1</a>).</p>

<p class="endnote">The function Historian::write_command is used in <a href="#SP4">&#167;4</a>, <a href="#SP4_3">&#167;4.3</a>, <a href="#SP5">&#167;5</a>.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="2-act.html">Back to 'Actions'</a></li><li><a href="2-te.html">Continue with 'The Extractor'</a></li></ul><hr class="tocbar">
<!--End of weave: 203 lines from a web of 15277-->
	</body>
</html>

