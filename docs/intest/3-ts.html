<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>2/te</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../webs.html">Sources</a></h1>
<ul>
<li><a href="../intest/index.html">intest</a></li>
</ul>
<h2>Foundation</h2>
<ul>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>
</ul>


		</nav>
		<main role="main">
		
<!--Weave of '3/ts' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">Source</a></li><li><a href="index.html">intest 2.0</a></li><li><a href="index.html#3">Chapter 3: Performing Tests</a></li><li><b>The Scheduler</b></li></ul><p class="purpose">To queue and then distribute the load of tests.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Starting</a></li><li><a href="#SP2">&#167;2. Threads and their slots</a></li><li><a href="#SP7">&#167;7. Scheduling</a></li><li><a href="#SP9">&#167;9. Distributing</a></li><li><a href="#SP10">&#167;10. Work threads begin here</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Starting. </b>At startup, we're told the maximum number of tests we are allowed to conduct
simultaneously.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_THREADS</span><span class="plain"> 256</span>
    <span class="definitionkeyword">define</span> <span class="constant">TRACE_THREADING</span><span class="plain"> </span><span class="constant">FALSE</span><span class="plain"> </span>    <span class="comment">change this for debugging, if you really must</span>
</pre>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">use_threads</span><span class="plain"> = 1;</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::start</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">threads_available</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">use_threads</span><span class="plain"> &gt; </span><span class="constant">MAX_THREADS</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"too high a thread count"</span><span class="plain">);</span>
        <span class="identifier">use_threads</span><span class="plain"> = </span><span class="identifier">threads_available</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Scheduler::start is used in 2/act (<a href="2-act.html#SP7">&#167;7</a>).</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Threads and their slots. </b>There are going to be up to <code class="display"><span class="extract">MAX_THREADS</span></code> "work threads" at any one time,
performing the actual tests; together with Intest's main thread, which will
allocate test cases to them and collate the results. The main thread will
usually be asleep while they work, waking every second to see what has
happened since last time.
</p>

<p class="inwebparagraph">The simplest option would simply be to divide the tests up equally into
<code class="display"><span class="extract">MAX_THREADS</span></code> piles, then start that many work threads, and tell them to
get on with it. This however is inefficient in practice because some tests
take longer than others, so that towards the end of the test run some work
threads would be standing idle, having completed their assignments, while
others &mdash; perhaps even just one &mdash; were still working. That means many of
the processor cores idling towards the end of the run, which is wasteful.
</p>

<p class="inwebparagraph">Instead, then, we keep track of <code class="display"><span class="extract">MAX_THREADS</span></code> "thread slots". Intest's main
thread will give each slot a small pile of cases to work on, starting a work
thread for each slot to perform those cases. The size of this small pile of
cases is called the <code class="display"><span class="extract">QUANTUM</span></code>. When a work thread runs out of things to do,
Intest notices this and gives it some more. (To be more precise, the main
thread stops the original work thread and starts another in the same slot.)
</p>

<p class="inwebparagraph">It is not obvious what the best <code class="display"><span class="extract">QUANTUM</span></code> value is. A lower <code class="display"><span class="extract">QUANTUM</span></code> increases
the likelihood that all processor cores will be fully occupied right to the
end of the testing run, which minimises the time taken. But it also increases
the amount of time lost due to latency on the main thread &mdash; that is, the
fact that the main thread, which wakes only every second, can never react
more quickly than that. If the <code class="display"><span class="extract">QUANTUM</span></code> is just 1 and a single test takes
a single core 0.1s to run, then every core will be idle for 0.9s out of
every second.
</p>

<p class="inwebparagraph">Experience suggests 16 is a good <code class="display"><span class="extract">QUANTUM</span></code> for typical Inform test runs, and
since Inform is our main customer, we'll choose that. If there are 2000 cases
to get through, and 16 thread slots, each thread slot will get through an
average of 125 cases, but it will do it with a succession of about 8 threads
running one after the other. In all, there will have been about 128 test
threads in existence, but only 16 at any one time. Time lost due to latency
then amounts to about 4 seconds per core, times the number of cores: i.e., to
4 seconds in all. (4 because an average of 0.5s is lost each time a thread
finishes, and 8 threads run on each core over the test time.)
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">QUANTUM</span><span class="plain"> 16</span>
</pre>
<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b></p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">NO_THREAD</span><span class="plain"> 1       </span>    <span class="comment">this slot has no thread running</span>
    <span class="definitionkeyword">define</span> <span class="constant">WORKING_THREAD</span><span class="plain"> 2  </span>    <span class="comment">this slot has a thread which hasn't finished work</span>
    <span class="definitionkeyword">define</span> <span class="constant">IDLE_THREAD</span><span class="plain"> 3     </span>    <span class="comment">this slot has a thread which has finished and is idle</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">thread_slot</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">availability</span><span class="plain">; </span>    <span class="comment">one of the three <code class="display"><span class="extract">*_THREAD</span></code> values above</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">slot_log_name</span><span class="plain">; </span>    <span class="comment">local-to-this-slot debugging log name</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">split_log</span><span class="plain">; </span>    <span class="comment">local-to-this-slot debugging log</span>
        <span class="identifier">foundation_thread</span><span class="plain"> </span><span class="identifier">work_thread</span><span class="plain">; </span>    <span class="comment">has no valid contents if <code class="display"><span class="extract">NO_THREAD</span></code></span>
        <span class="identifier">foundation_thread_attributes</span><span class="plain"> </span><span class="identifier">attributes</span><span class="plain">; </span>    <span class="comment">similarly</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">sandbox</span><span class="plain">; </span>    <span class="comment">a safe area for threads in this slot to create files</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">;</span>
    <span class="plain">} </span><span class="reserved">thread_slot</span><span class="plain">;</span>

    <span class="reserved">thread_slot</span><span class="plain"> </span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="constant">MAX_THREADS</span><span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure thread_slot is accessed in 4/tt and here.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>Each thread slot is provided with its own sandbox directory in the file
system, where it can if it wishes create files. These are subdirectories
called <code class="display"><span class="extract">T0</span></code>, <code class="display"><span class="extract">T1</span></code>, ... in the directory pointed to by the global variable
<code class="display"><span class="extract">$$workspace</span></code>. (Note: if you change this, be sure to make a matching change
to the Skein-reading code.)
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::initialise_slots</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = 0; </span><span class="identifier">s</span><span class="plain"> &lt; </span><span class="identifier">use_threads</span><span class="plain">; </span><span class="identifier">s</span><span class="plain">++) {</span>
            <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.counter</span><span class="plain"> = </span><span class="identifier">s</span><span class="plain">;</span>
            <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> = </span><span class="constant">NO_THREAD</span><span class="plain">;</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">FNAME</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">FNAME</span><span class="plain">, </span><span class="string">"debug-log-thread-%d.txt"</span><span class="plain">, </span><span class="identifier">s</span><span class="plain">);</span>
            <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">Thread_Work_Area</span><span class="plain"> = </span><span class="functiontext">Scheduler::work_area</span><span class="plain">(</span><span class="identifier">s</span><span class="plain">);</span>
            <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.slot_log_name</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">Thread_Work_Area</span><span class="plain">, </span><span class="identifier">FNAME</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">FNAME</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">use_threads</span><span class="plain"> &gt; 0) </span><span class="functiontext">Scheduler::work_area</span><span class="plain">(0);</span>
    <span class="plain">}</span>

    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sandboxes_made</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
    <span class="reserved">pathname</span><span class="plain"> *</span><span class="functiontext">Scheduler::work_area</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">s</span><span class="plain">&lt;0) || (</span><span class="identifier">s</span><span class="plain">&gt;=</span><span class="identifier">use_threads</span><span class="plain">)) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"thread slot out of range"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sandboxes_made</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) {</span>
            <span class="identifier">sandboxes_made</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">t</span><span class="plain"> = 0; </span><span class="identifier">t</span><span class="plain"> &lt; </span><span class="identifier">use_threads</span><span class="plain">; </span><span class="identifier">t</span><span class="plain">++) {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">TN</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">TN</span><span class="plain">, </span><span class="string">"T%d"</span><span class="plain">, </span><span class="identifier">t</span><span class="plain">);</span>
                <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">workspace</span><span class="plain"> = </span><span class="functiontext">Globals::to_pathname</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"workspace"</span><span class="plain">);</span>
                <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">t</span><span class="plain">]</span><span class="element">.sandbox</span><span class="plain"> = </span><span class="functiontext">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">workspace</span><span class="plain">, </span><span class="identifier">TN</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">TN</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.sandbox</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Scheduler::initialise_slots is used in <a href="#SP9">&#167;9</a>.</p>

<p class="endnote">The function Scheduler::work_area is used in 4/tt (<a href="4-tt.html#SP1_1">&#167;1.1</a>, <a href="4-tt.html#SP3">&#167;3</a>).</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b>This is the only place in Intest where we invoke the dark magic of pthread
library calls. The main Intest thread will call <code class="display"><span class="extract">pthread_create</span></code> to
call a function, always <code class="display"><span class="extract">Scheduler::perform_work</span></code>, on a new thread.
When that function "returns", however, its thread does not cease to exist.
That happens only when the main Intest thread calls <code class="display"><span class="extract">pthread_join</span></code> on it.
"Create" and "join" are, in effect, pthread jargon for "start" and "stop".
</p>

<p class="inwebparagraph">We clearly need some way for a work thread to signal back when it is
finished, as otherwise there will be no way for the main thread to know when
it is safe to join it. We do that with the <code class="display"><span class="extract">availability</span></code> field in the slot
structure: when the working thread has done all its work, that thread sets
<code class="display"><span class="extract">availability</span></code> to <code class="display"><span class="extract">IDLE_THREAD</span></code>. It then becomes quiescent. Once every second
the main thread looks to see if any slots have become idle, and if so, it
then joins their threads.
</p>

<p class="inwebparagraph">As elegant as the Unix pthread model is, it's unfortunate that we are
expected to specify explicitly what stack size to allocate our work threads.
We will simply choose a Very Big Number and hope for the best.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">STACK_SIZE_PER_WORK_THREAD</span><span class="plain"> 0</span><span class="identifier">x8000000</span>
</pre>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::start_work_on_slot</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> != </span><span class="constant">NO_THREAD</span><span class="plain">)</span>
            <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"tried to start second thread in same slot"</span><span class="plain">);</span>
        <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> = </span><span class="constant">WORKING_THREAD</span><span class="plain">;</span>
        <span class="functiontext">Platform::init_thread</span><span class="plain">(&amp;</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.attributes</span><span class="plain">, </span><span class="constant">STACK_SIZE_PER_WORK_THREAD</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="constant">TRACE_THREADING</span><span class="plain">) {</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"Work on slot %d: "</span><span class="plain">, </span><span class="identifier">s</span><span class="plain">);</span>
            <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">,</span><span class="reserved"> test</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;allocated_to</span><span class="plain"> == </span><span class="identifier">s</span><span class="plain">) {</span>
                    <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"T%d:%S "</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;allocation_id</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain">-</span><span class="element">&gt;test_case_name</span><span class="plain">);</span>
                <span class="plain">}</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">rc</span><span class="plain"> = </span><span class="functiontext">Platform::create_thread</span><span class="plain">(&amp;(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.work_thread</span><span class="plain">),</span>
            <span class="plain">&amp;(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.attributes</span><span class="plain">),</span>
            <span class="functiontext">Scheduler::perform_work</span><span class="plain">,</span>
            <span class="plain">(</span><span class="reserved">void</span><span class="plain"> *) &amp;(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.counter</span><span class="plain">));</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rc</span><span class="plain"> == </span><span class="identifier">EAGAIN</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"thread failed EAGAIN"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rc</span><span class="plain"> == </span><span class="identifier">EINVAL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"thread failed EINVAL"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rc</span><span class="plain"> == </span><span class="identifier">EPERM</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"thread failed EPERM"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rc</span><span class="plain"> != 0) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"thread failed"</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::stop_work_on_slot</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">rc</span><span class="plain"> = </span><span class="functiontext">Platform::join_thread</span><span class="plain">(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.work_thread</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rc</span><span class="plain"> != 0) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"thread failed to join"</span><span class="plain">);</span>
        <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> = </span><span class="constant">NO_THREAD</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">size_t</span><span class="plain"> </span><span class="functiontext">Scheduler::stack_size</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext">Platform::get_thread_stack_size</span><span class="plain">(&amp;(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.attributes</span><span class="plain">));</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Scheduler::start_work_on_slot is used in <a href="#SP9_3_1_2">&#167;9.3.1.2</a>.</p>

<p class="endnote">The function Scheduler::stop_work_on_slot is used in <a href="#SP6">&#167;6</a>.</p>

<p class="endnote">The function Scheduler::stack_size is used in <a href="#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::stop_work_on_idle_slots</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = 0; </span><span class="identifier">s</span><span class="plain"> &lt; </span><span class="identifier">use_threads</span><span class="plain">; </span><span class="identifier">s</span><span class="plain">++)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> == </span><span class="constant">IDLE_THREAD</span><span class="plain">)</span>
                <span class="functiontext">Scheduler::stop_work_on_slot</span><span class="plain">(</span><span class="identifier">s</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::stop_work_on_all_slots</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = 0; </span><span class="identifier">s</span><span class="plain"> &lt; </span><span class="identifier">use_threads</span><span class="plain">; </span><span class="identifier">s</span><span class="plain">++)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> != </span><span class="constant">NO_THREAD</span><span class="plain">)</span>
                <span class="functiontext">Scheduler::stop_work_on_slot</span><span class="plain">(</span><span class="identifier">s</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Scheduler::stop_work_on_idle_slots is used in <a href="#SP9_3">&#167;9.3</a>.</p>

<p class="endnote">The function Scheduler::stop_work_on_all_slots is used in <a href="#SP9_3">&#167;9.3</a>.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7. Scheduling. </b>The scheduler completes one of the following structures for each test
performed: it's a form holding what to do and what the results were. For
now, scheduling consists of creating the structure with the results left
blank.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">NO_SLOT_AS_YET</span><span class="plain"> -1</span>
    <span class="definitionkeyword">define</span> <span class="constant">DONE_AND_NO_LONGER_NEEDS_SLOT</span><span class="plain"> -2</span>
</pre>
<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8.  </b></p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct test</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">test_case</span><span class="plain"> *</span><span class="identifier">to_be_tested</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">action_type</span><span class="plain">; </span>    <span class="comment">for example, <code class="display"><span class="extract">TEST_ACTION</span></code> or <code class="display"><span class="extract">BLESS_ACTION</span></code></span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">redirect</span><span class="plain">; </span>    <span class="comment">where to redirect console output</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">allocated_to</span><span class="plain">; </span>    <span class="comment">an index into <code class="display"><span class="extract">thread_slots</span></code>, or else one of the values above</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">passed</span><span class="plain">; </span>    <span class="comment">or <code class="display"><span class="extract">NOT_APPLICABLE</span></code> if not yet run</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">full_results</span><span class="plain">;</span>
        <span class="reserved">struct test</span><span class="plain"> *</span><span class="identifier">previous_completed_test</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">}</span><span class="reserved"> test</span><span class="plain">;</span>


    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::schedule</span><span class="plain">(</span><span class="reserved">test_case</span><span class="plain"> *</span><span class="identifier">tc</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">redirect</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">test_action</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">tc</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"no test case"</span><span class="plain">);</span>
        <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="reserved">(test</span><span class="plain">);</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain"> = </span><span class="identifier">tc</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;redirect</span><span class="plain"> = </span><span class="identifier">redirect</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;allocated_to</span><span class="plain"> = </span><span class="constant">NO_SLOT_AS_YET</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;passed</span><span class="plain"> = </span><span class="constant">NOT_APPLICABLE</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;action_type</span><span class="plain"> = </span><span class="identifier">test_action</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;full_results</span><span class="plain"> = </span><span class="functiontext">Str::new_with_capacity</span><span class="plain">(20480);</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;previous_completed_test</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Scheduler::schedule is used in 2/act (<a href="2-act.html#SP9_2">&#167;9.2</a>).</p>

<p class="endnote">The structure test is accessed in 2/act and here.</p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Distributing. </b>We will maintain a reverse linked list which holds the tests in the sequence
in which they completed &mdash; almost certainly out of their original scheduling
order, and sometimes drastically so. <code class="display"><span class="extract">last_completed_test</span></code> is always the
most recent.
</p>


<pre class="display">
    <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">last_completed_test</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">splitting_logs</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Scheduler::test</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">NUMBER_CREATED</span><span class="reserved">(test</span><span class="plain">) == 0) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="functiontext">Scheduler::initialise_slots</span><span class="plain">();</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">main_DL</span><span class="plain"> = </span><span class="identifier">DL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Log::aspect_switched_on</span><span class="plain">(</span><span class="constant">TESTER_DA</span><span class="plain">)) </span><span class="identifier">splitting_logs</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">splitting_logs</span><span class="plain">) </span>&lt;<span class="cwebmacro">Split the debugging log into forks per thread</span> <span class="cwebmacronumber">9.1</span>&gt;<span class="plain">;</span>
        <span class="identifier">time_t</span><span class="plain"> </span><span class="identifier">time_at_start</span><span class="plain"> = </span><span class="identifier">time</span><span class="plain">(0);</span>
        &lt;<span class="cwebmacro">Allocate and run the tests</span> <span class="cwebmacronumber">9.3</span>&gt;<span class="plain">;</span>
        <span class="identifier">time_t</span><span class="plain"> </span><span class="identifier">duration</span><span class="plain"> = </span><span class="identifier">time</span><span class="plain">(0) - </span><span class="identifier">time_at_start</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">splitting_logs</span><span class="plain">) </span>&lt;<span class="cwebmacro">Unsplit the debugging log</span> <span class="cwebmacronumber">9.2</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">splitting_logs</span><span class="plain">) </span><span class="identifier">splitting_logs</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Write results banner</span> <span class="cwebmacronumber">9.4</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Scheduler::test is used in 2/act (<a href="2-act.html#SP7">&#167;7</a>).</p>

<p class="inwebparagraph"><a id="SP9_1"></a><b>&#167;9.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Split the debugging log into forks per thread</span> <span class="cwebmacronumber">9.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"Splitting into independent debugging logs per thread here\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="functiontext">Log::close</span><span class="plain">();</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = 0; </span><span class="identifier">s</span><span class="plain"> &lt; </span><span class="identifier">use_threads</span><span class="plain">; </span><span class="identifier">s</span><span class="plain">++) {</span>
            <span class="functiontext">Log::open_alternative</span><span class="plain">(</span>
                <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.slot_log_name</span><span class="plain">, &amp;(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.split_log</span><span class="plain">));</span>
            <span class="identifier">LOG</span><span class="plain">(</span><span class="string">"This log belongs to thread %d\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">s</span><span class="plain">);</span>
            <span class="identifier">DL</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_2"></a><b>&#167;9.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Unsplit the debugging log</span> <span class="cwebmacronumber">9.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = 0; </span><span class="identifier">s</span><span class="plain"> &lt; </span><span class="identifier">use_threads</span><span class="plain">; </span><span class="identifier">s</span><span class="plain">++)</span>
            <span class="functiontext">Streams::close</span><span class="plain">(&amp;(</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.split_log</span><span class="plain">));</span>
        <span class="identifier">DL</span><span class="plain"> = </span><span class="identifier">main_DL</span><span class="plain">;</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TESTER</span><span class="plain">, </span><span class="string">"Back to a single debugging log here\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_3"></a><b>&#167;9.3.  </b>The loop here, which of course runs on the main thread, sleeps for 1 second
with each iteration.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Allocate and run the tests</span> <span class="cwebmacronumber">9.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">last_completed_test</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">line_complete</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">, </span><span class="identifier">current_wildcard</span><span class="plain"> = </span><span class="constant">ALL_WILDCARD</span><span class="plain">;</span>
        <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">next_to_report</span><span class="plain"> = </span><span class="identifier">FIRST_OBJECT</span><span class="reserved">(test</span><span class="plain">);</span>
        <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">next_test_to_allocate</span><span class="plain"> = </span><span class="identifier">next_to_report</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">number_still_to_allocate</span><span class="plain"> = </span><span class="identifier">NUMBER_CREATED</span><span class="reserved">(test</span><span class="plain">);</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="identifier">next_to_report</span><span class="plain">) {</span>
            <span class="identifier">STREAM_FLUSH</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
            <span class="functiontext">Scheduler::stop_work_on_idle_slots</span><span class="plain">();</span>
            &lt;<span class="cwebmacro">Allocate next few tests</span> <span class="cwebmacronumber">9.3.1</span>&gt;<span class="plain">;</span>
            &lt;<span class="cwebmacro">Gather up recent reports</span> <span class="cwebmacronumber">9.3.2</span>&gt;<span class="plain">;</span>
            <span class="functiontext">Platform::sleep</span><span class="plain">(1);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">line_complete</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) { </span><span class="identifier">line_complete</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); }</span>
        <span class="functiontext">Scheduler::stop_work_on_all_slots</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_1"></a><b>&#167;9.3.1.  </b>We make a list of all thread slots currently standing idle, and then
allocate them each a roughly equal number of the test cases not yet
allocated to any slot; but we stop when they have <code class="display"><span class="extract">QUANTUM</span></code> number of
cases to look at.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Allocate next few tests</span> <span class="cwebmacronumber">9.3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">free_slot_list</span><span class="plain">[</span><span class="constant">MAX_THREADS</span><span class="plain">], </span><span class="identifier">given_over</span><span class="plain">[</span><span class="constant">MAX_THREADS</span><span class="plain">];</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">threads_free</span><span class="plain"> = 0;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = 0; </span><span class="identifier">s</span><span class="plain"> &lt; </span><span class="identifier">use_threads</span><span class="plain">; </span><span class="identifier">s</span><span class="plain">++) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> == </span><span class="constant">NO_THREAD</span><span class="plain">) {</span>
                <span class="identifier">free_slot_list</span><span class="plain">[</span><span class="identifier">threads_free</span><span class="plain">] = </span><span class="identifier">s</span><span class="plain">;</span>
                <span class="identifier">given_over</span><span class="plain">[</span><span class="identifier">threads_free</span><span class="plain">++] = 0;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">threads_free</span><span class="plain"> &gt; 0) &amp;&amp; (</span><span class="identifier">number_still_to_allocate</span><span class="plain"> &gt; 0)) {</span>
            &lt;<span class="cwebmacro">Give each free slot up to QUANTUM-many test cases to work on</span> <span class="cwebmacronumber">9.3.1.1</span>&gt;<span class="plain">;</span>
            &lt;<span class="cwebmacro">For each slot which which was given any, start a work thread</span> <span class="cwebmacronumber">9.3.1.2</span>&gt;<span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="constant">TRACE_THREADING</span><span class="plain">) </span><span class="identifier">printf</span><span class="plain">(</span><span class="string">"Still to allocate: %d\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">number_still_to_allocate</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3">&#167;9.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_1_1"></a><b>&#167;9.3.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Give each free slot up to QUANTUM-many test cases to work on</span> <span class="cwebmacronumber">9.3.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = 0;</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="identifier">next_test_to_allocate</span><span class="plain">) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = </span><span class="identifier">free_slot_list</span><span class="plain">[</span><span class="identifier">c</span><span class="plain"> % </span><span class="identifier">threads_free</span><span class="plain">];</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">given_over</span><span class="plain">[</span><span class="identifier">c</span><span class="plain"> % </span><span class="identifier">threads_free</span><span class="plain">] &gt;= </span><span class="constant">QUANTUM</span><span class="plain">) </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="identifier">next_test_to_allocate</span><span class="plain">-</span><span class="element">&gt;allocated_to</span><span class="plain"> = </span><span class="identifier">s</span><span class="plain">;</span>
            <span class="identifier">given_over</span><span class="plain">[</span><span class="identifier">c</span><span class="plain"> % </span><span class="identifier">threads_free</span><span class="plain">]++;</span>
            <span class="identifier">number_still_to_allocate</span><span class="plain">--; </span><span class="identifier">c</span><span class="plain">++;</span>
            <span class="identifier">next_test_to_allocate</span><span class="plain"> = </span><span class="identifier">NEXT_OBJECT</span><span class="plain">(</span><span class="identifier">next_test_to_allocate</span><span class="plain">,</span><span class="reserved"> test</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3_1">&#167;9.3.1</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_1_2"></a><b>&#167;9.3.1.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">For each slot which which was given any, start a work thread</span> <span class="cwebmacronumber">9.3.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = 0; </span><span class="identifier">c</span><span class="plain"> &lt; </span><span class="identifier">threads_free</span><span class="plain">; </span><span class="identifier">c</span><span class="plain">++)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">given_over</span><span class="plain">[</span><span class="identifier">c</span><span class="plain">] &gt; 0) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="constant">TRACE_THREADING</span><span class="plain">)</span>
                    <span class="identifier">printf</span><span class="plain">(</span><span class="string">"starting work thread on slot %d to perform %d tests\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                        <span class="identifier">free_slot_list</span><span class="plain">[</span><span class="identifier">c</span><span class="plain">], </span><span class="identifier">given_over</span><span class="plain">[</span><span class="identifier">c</span><span class="plain">]);</span>
                <span class="functiontext">Scheduler::start_work_on_slot</span><span class="plain">(</span><span class="identifier">free_slot_list</span><span class="plain">[</span><span class="identifier">c</span><span class="plain">]);</span>
            <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3_1">&#167;9.3.1</a>.</p>

<p class="inwebparagraph"><a id="SP9_3_2"></a><b>&#167;9.3.2.  </b>The only purpose of the following is to print something to the terminal so
that the user has some comforting evidence that work is going on. This is
where Intest's familiar chains of bracketed case numbers are printed:
</p>

<p class="inwebparagraph"></p>


<pre class="display">
        <span class="plain">inter -&gt; cases: [1] [2] [3] [4] [5] [6] [7] (8) [9] [10] -11- [12] [13]</span>
</pre>

<p class="inwebparagraph">Note that they are grouped by "wildcard", in effect, by their case type.
The symbols placed either side of the case number, loosely called its
"brackets", are chosen by the Tester on the basis of the test's outcome.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Gather up recent reports</span> <span class="cwebmacronumber">9.3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">while</span><span class="plain"> ((</span><span class="identifier">next_to_report</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="identifier">next_to_report</span><span class="plain">-</span><span class="element">&gt;allocated_to</span><span class="plain"> == </span><span class="constant">DONE_AND_NO_LONGER_NEEDS_SLOT</span><span class="plain">)) {</span>
            <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain"> = </span><span class="identifier">next_to_report</span><span class="plain">;</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">w</span><span class="plain"> = </span><span class="functiontext">Actions::which_wildcard</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">w</span><span class="plain"> != </span><span class="identifier">current_wildcard</span><span class="plain">) {</span>
                <span class="identifier">current_wildcard</span><span class="plain"> = </span><span class="identifier">w</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">line_complete</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) { </span><span class="identifier">line_complete</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); }</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%p -&gt; %s: "</span><span class="plain">, </span><span class="identifier">home_project</span><span class="plain">, </span><span class="functiontext">Actions::name_of_wildcard</span><span class="plain">(</span><span class="identifier">w</span><span class="plain">));</span>
                <span class="identifier">line_complete</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;passed</span><span class="plain">) {</span>
                <span class="identifier">line_complete</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%c%d%c "</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain">-</span><span class="element">&gt;left_bracket</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;allocation_id</span><span class="plain"> + 1,</span>
                    <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain">-&gt;</span><span class="identifier">right_bracket</span><span class="plain">);</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">line_complete</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) { </span><span class="identifier">line_complete</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">; </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); }</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;full_results</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="identifier">next_to_report</span><span class="plain"> = </span><span class="identifier">NEXT_OBJECT</span><span class="plain">(</span><span class="identifier">next_to_report</span><span class="plain">,</span><span class="reserved"> test</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">STREAM_FLUSH</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_3">&#167;9.3</a>.</p>

<p class="inwebparagraph"><a id="SP9_4"></a><b>&#167;9.4.  </b>And, now the hurly-burly's done: now the battle's lost and won. We need to
print out the summary of what happened, e.g.:
</p>

<p class="inwebparagraph"></p>


<pre class="display">
        <span class="plain">All 27 tests succeeded (time taken 0:02, 16 simultaneous threads)</span>
</pre>

<p class="inwebparagraph">The "bottom line" text here is "All 27 tests succeeded".
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Write results banner</span> <span class="cwebmacronumber">9.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">successes</span><span class="plain"> = 0, </span><span class="identifier">failures</span><span class="plain"> = 0;</span>
        <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">,</span><span class="reserved"> test</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;passed</span><span class="plain"> == </span><span class="constant">TRUE</span><span class="plain">) </span><span class="identifier">successes</span><span class="plain">++;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;passed</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) </span><span class="identifier">failures</span><span class="plain">++;</span>
        <span class="plain">}</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> = </span><span class="identifier">use_threads</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain"> &gt; </span><span class="identifier">successes</span><span class="plain"> + </span><span class="identifier">failures</span><span class="plain">) </span><span class="identifier">N</span><span class="plain"> = </span><span class="identifier">successes</span><span class="plain"> + </span><span class="identifier">failures</span><span class="plain">;</span>

        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">And the bottom line is...</span> <span class="cwebmacronumber">9.4.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">failures</span><span class="plain"> &gt; 0) </span>&lt;<span class="cwebmacro">Recite our failures</span> <span class="cwebmacronumber">9.4.2</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">successes</span><span class="plain"> + </span><span class="identifier">failures</span><span class="plain"> &gt;= 10)</span>
            <span class="functiontext">Platform::notification</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, (</span><span class="identifier">failures</span><span class="plain"> == 0)?</span><span class="constant">TRUE</span><span class="plain">:</span><span class="constant">FALSE</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_4_1"></a><b>&#167;9.4.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">And the bottom line is...</span> <span class="cwebmacronumber">9.4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">successes</span><span class="plain"> + </span><span class="identifier">failures</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> 1:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">successes</span><span class="plain"> == 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"Failed"</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"Succeeded"</span><span class="plain">);</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> 2:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">successes</span><span class="plain"> == 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"Both tests failed"</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">failures</span><span class="plain"> == 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"Both tests succeeded"</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"%d test succeeded but %d failed"</span><span class="plain">, </span><span class="identifier">successes</span><span class="plain">, </span><span class="identifier">failures</span><span class="plain">);</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">default</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">successes</span><span class="plain"> == 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"All %d tests failed"</span><span class="plain">, </span><span class="identifier">failures</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">failures</span><span class="plain"> == 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"All %d tests succeeded"</span><span class="plain">, </span><span class="identifier">successes</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">bottom_line</span><span class="plain">, </span><span class="string">"%d test%s succeeded but %d failed"</span><span class="plain">,</span>
                    <span class="identifier">successes</span><span class="plain">, (</span><span class="identifier">successes</span><span class="plain">==1)?</span><span class="string">""</span><span class="plain">:</span><span class="string">"s"</span><span class="plain">, </span><span class="identifier">failures</span><span class="plain">);</span>
                <span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"  %S (time taken %d:%02d"</span><span class="plain">,</span>
            <span class="identifier">bottom_line</span><span class="plain">, ((</span><span class="reserved">int</span><span class="plain">) </span><span class="identifier">duration</span><span class="plain">)/60, ((</span><span class="reserved">int</span><span class="plain">) </span><span class="identifier">duration</span><span class="plain">)%60);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain"> &gt; 1) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">", %d simultaneous thread%s"</span><span class="plain">, </span><span class="identifier">N</span><span class="plain">, (</span><span class="identifier">N</span><span class="plain">==1)?</span><span class="string">""</span><span class="plain">:</span><span class="string">"s"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">")\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_4">&#167;9.4</a>.</p>

<p class="inwebparagraph"><a id="SP9_4_2"></a><b>&#167;9.4.2.  </b>This does more than simply print the names of test cases which failed: it
also tells the Historian to give them numbered shortcut names in future.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Recite our failures</span> <span class="cwebmacronumber">9.4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Failed:"</span><span class="plain">);</span>
        <span class="functiontext">Historian::notify_failure_count</span><span class="plain">(</span><span class="identifier">failures</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">f</span><span class="plain"> = 0;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">,</span><span class="reserved"> test</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;passed</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) {</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">" %d=%S"</span><span class="plain">, </span><span class="identifier">f</span><span class="plain">+1, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain">-</span><span class="element">&gt;test_case_name</span><span class="plain">);</span>
                <span class="functiontext">Historian::notify_failure</span><span class="plain">(</span><span class="identifier">f</span><span class="plain">++, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain">-</span><span class="element">&gt;test_case_name</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9_4">&#167;9.4</a>.</p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10. Work threads begin here. </b>When a work thread is created, this is its function. The one argument is a
pointer to an integer, which tells us which slot number we are running in.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> *</span><span class="functiontext">Scheduler::perform_work</span><span class="plain">(</span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">argument</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> = *((</span><span class="reserved">int</span><span class="plain"> *) </span><span class="identifier">argument</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Log::aspect_switched_on</span><span class="plain">(</span><span class="constant">TESTER_DA</span><span class="plain">))</span>
            <span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Thread in slot %d has stack size %08x\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                <span class="identifier">s</span><span class="plain">, </span><span class="functiontext">Scheduler::stack_size</span><span class="plain">(</span><span class="identifier">s</span><span class="plain">));</span>
        <span class="reserved">test</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">,</span><span class="reserved"> test</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;allocated_to</span><span class="plain"> == </span><span class="identifier">s</span><span class="plain">) {</span>
                <span class="reserved">int</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> = </span><span class="functiontext">Tester::test</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;full_results</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;to_be_tested</span><span class="plain">,</span>
                    <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;allocation_id</span><span class="plain"> + 1, </span><span class="identifier">s</span><span class="plain">, </span><span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;action_type</span><span class="plain">);</span>
                &lt;<span class="cwebmacro">Mark test T as completed</span> <span class="cwebmacronumber">10.1</span>&gt;<span class="plain">;</span>
            <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="constant">TRACE_THREADING</span><span class="plain">) </span><span class="identifier">printf</span><span class="plain">(</span><span class="string">"(Thread in slot %d has finished.)\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">s</span><span class="plain">);</span>
        <span class="identifier">thread_slots</span><span class="plain">[</span><span class="identifier">s</span><span class="plain">]</span><span class="element">.availability</span><span class="plain"> = </span><span class="constant">IDLE_THREAD</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Scheduler::perform_work is used in <a href="#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP10_1"></a><b>&#167;10.1.  </b>The mutex here is needed because there is just one global reverse linked
list of completed texts: if two threads were simultaneously changing the
value of <code class="display"><span class="extract">last_completed_test</span></code>, disaster would befall us. This is so
unlikely to happen that the mutex here is about like taking insurance out
against asteroid impacts, but still, one likes to be safe.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Mark test T as completed</span> <span class="cwebmacronumber">10.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;passed</span><span class="plain"> = </span><span class="identifier">result</span><span class="plain">;</span>
        <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;allocated_to</span><span class="plain"> = </span><span class="constant">DONE_AND_NO_LONGER_NEEDS_SLOT</span><span class="plain">;</span>

        <span class="identifier">CREATE_MUTEX</span><span class="plain">(</span><span class="identifier">mutex</span><span class="plain">);</span>
        <span class="identifier">LOCK_MUTEX</span><span class="plain">(</span><span class="identifier">mutex</span><span class="plain">);</span>
            <span class="identifier">T</span><span class="plain">-</span><span class="element">&gt;previous_completed_test</span><span class="plain"> = </span><span class="identifier">last_completed_test</span><span class="plain">;</span>
            <span class="identifier">last_completed_test</span><span class="plain"> = </span><span class="identifier">T</span><span class="plain">;</span>
        <span class="identifier">UNLOCK_MUTEX</span><span class="plain">(</span><span class="identifier">mutex</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP10">&#167;10</a>.</p>

<hr class="tocbar">
<ul class="toc"><li><i>(This section begins Chapter 3: Performing Tests.)</i></li><li><a href="3-th.html">Continue with 'The Hasher'</a></li></ul><hr class="tocbar">
<!--End of weave-->
		</main>
	</body>
</html>

