<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>The Scheduler</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-assets/Intest.png" height=72">
</a></h1>
<ul><li><a href="index.html"><span class="selectedlink">intest</span></a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/intest"><img src="../docs-assets/github.png" height=18> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="../../../inweb/docs/index.html">inweb</a></li>
<li><a href="../../../inform/docs/index.html">inform</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'The Scheduler' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">intest</a></li><li><a href="index.html#3">Chapter 3: Performing Tests</a></li><li><b>The Scheduler</b></li></ul></div>
<p class="purpose">To queue and then distribute the load of tests.</p>

<ul class="toc"><li><a href="3-ts.html#SP1">&#167;1. Starting</a></li><li><a href="3-ts.html#SP2">&#167;2. Threads and their slots</a></li><li><a href="3-ts.html#SP7">&#167;7. Scheduling</a></li><li><a href="3-ts.html#SP9">&#167;9. Distributing</a></li><li><a href="3-ts.html#SP10">&#167;10. Work threads begin here</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. Starting. </b>At startup, we're told the maximum number of tests we are allowed to conduct
simultaneously.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">MAX_THREADS</span><span class="plain-syntax"> </span><span class="constant-syntax">256</span>
<span class="definition-keyword">define</span> <span class="constant-syntax">TRACE_THREADING</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax"> </span><span class="comment-syntax"> change this for debugging, if you really must</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax"> = </span><span class="constant-syntax">1</span><span class="plain-syntax">;</span>
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::start</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="function-syntax">Scheduler::start</span></span>:<br/>Actions - <a href="2-act.html#SP7">&#167;7</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">threads_available</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">use_threads</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">MAX_THREADS</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"too high a thread count"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax"> = </span><span class="identifier-syntax">threads_available</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. Threads and their slots. </b>There are going to be up to <span class="extract"><span class="extract-syntax">MAX_THREADS</span></span> "work threads" at any one time,
performing the actual tests; together with Intest's main thread, which will
allocate test cases to them and collate the results. The main thread will
usually be asleep while they work, waking every second to see what has
happened since last time.
</p>

<p class="commentary">The simplest option would simply be to divide the tests up equally into
<span class="extract"><span class="extract-syntax">MAX_THREADS</span></span> piles, then start that many work threads, and tell them to
get on with it. This however is inefficient in practice because some tests
take longer than others, so that towards the end of the test run some work
threads would be standing idle, having completed their assignments, while
others &mdash; perhaps even just one &mdash; were still working. That means many of
the processor cores idling towards the end of the run, which is wasteful.
</p>

<p class="commentary">Instead, then, we keep track of <span class="extract"><span class="extract-syntax">MAX_THREADS</span></span> "thread slots". Intest's main
thread will give each slot a small pile of cases to work on, starting a work
thread for each slot to perform those cases. The size of this small pile of
cases is called the <span class="extract"><span class="extract-syntax">QUANTUM</span></span>. When a work thread runs out of things to do,
Intest notices this and gives it some more. (To be more precise, the main
thread stops the original work thread and starts another in the same slot.)
</p>

<p class="commentary">It is not obvious what the best <span class="extract"><span class="extract-syntax">QUANTUM</span></span> value is. A lower <span class="extract"><span class="extract-syntax">QUANTUM</span></span> increases
the likelihood that all processor cores will be fully occupied right to the
end of the testing run, which minimises the time taken. But it also increases
the amount of time lost due to latency on the main thread &mdash; that is, the
fact that the main thread, which wakes only every second, can never react
more quickly than that. If the <span class="extract"><span class="extract-syntax">QUANTUM</span></span> is just 1 and a single test takes
a single core 0.1s to run, then every core will be idle for 0.9s out of
every second.
</p>

<p class="commentary">Experience suggests 16 is a good <span class="extract"><span class="extract-syntax">QUANTUM</span></span> for typical Inform test runs, and
since Inform is our main customer, we'll choose that. If there are 2000 cases
to get through, and 16 thread slots, each thread slot will get through an
average of 125 cases, but it will do it with a succession of about 8 threads
running one after the other. In all, there will have been about 128 test
threads in existence, but only 16 at any one time. Time lost due to latency
then amounts to about 4 seconds per core, times the number of cores: i.e., to
4 seconds in all. (4 because an average of 0.5s is lost each time a thread
finishes, and 8 threads run on each core over the test time.)
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">QUANTUM</span><span class="plain-syntax"> </span><span class="constant-syntax">16</span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3.  </b></p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">NO_THREAD</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">       </span><span class="comment-syntax"> this slot has no thread running</span>
<span class="definition-keyword">define</span> <span class="constant-syntax">WORKING_THREAD</span><span class="plain-syntax"> </span><span class="constant-syntax">2</span><span class="plain-syntax">  </span><span class="comment-syntax"> this slot has a thread which hasn't finished work</span>
<span class="definition-keyword">define</span> <span class="constant-syntax">IDLE_THREAD</span><span class="plain-syntax"> </span><span class="constant-syntax">3</span><span class="plain-syntax">     </span><span class="comment-syntax"> this slot has a thread which has finished and is idle</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">thread_slot</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">availability</span><span class="plain-syntax">; </span><span class="comment-syntax"> one of the three </span><span class="extract"><span class="extract-syntax">*_THREAD</span></span><span class="comment-syntax"> values above</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">filename</span><span class="plain-syntax"> *</span><span class="identifier-syntax">slot_log_name</span><span class="plain-syntax">; </span><span class="comment-syntax"> local-to-this-slot debugging log name</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> </span><span class="identifier-syntax">split_log</span><span class="plain-syntax">; </span><span class="comment-syntax"> local-to-this-slot debugging log</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">foundation_thread</span><span class="plain-syntax"> </span><span class="identifier-syntax">work_thread</span><span class="plain-syntax">; </span><span class="comment-syntax"> has no valid contents if </span><span class="extract"><span class="extract-syntax">NO_THREAD</span></span>
<span class="plain-syntax">    </span><span class="identifier-syntax">foundation_thread_attributes</span><span class="plain-syntax"> </span><span class="identifier-syntax">attributes</span><span class="plain-syntax">; </span><span class="comment-syntax"> similarly</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">pathname</span><span class="plain-syntax"> *</span><span class="identifier-syntax">sandbox</span><span class="plain-syntax">; </span><span class="comment-syntax"> a safe area for threads in this slot to create files</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">counter</span><span class="plain-syntax">;</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">thread_slot</span><span class="plain-syntax">;</span>

<span class="reserved-syntax">thread_slot</span><span class="plain-syntax"> </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="constant-syntax">MAX_THREADS</span><span class="plain-syntax">];</span>
</pre>
<ul class="endnotetexts"><li>The structure thread_slot is accessed in 4/tt and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4.  </b>Each thread slot is provided with its own sandbox directory in the file
system, where it can if it wishes create files. These are subdirectories
called <span class="extract"><span class="extract-syntax">T0</span></span>, <span class="extract"><span class="extract-syntax">T1</span></span>, ... in the directory pointed to by the global variable
<span class="extract"><span class="extract-syntax">$$workspace</span></span>. (Note: if you change this, be sure to make a matching change
to the Skein-reading code.)
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::initialise_slots</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="function-syntax">Scheduler::initialise_slots</span></span>:<br/><a href="3-ts.html#SP9">&#167;9</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">void</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">counter</span><span class="plain-syntax"> = </span><span class="identifier-syntax">s</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> = </span><span class="constant-syntax">NO_THREAD</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">FNAME</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">FNAME</span><span class="plain-syntax">, </span><span class="string-syntax">"debug-log-thread-%d.txt"</span><span class="plain-syntax">, </span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">pathname</span><span class="plain-syntax"> *</span><span class="identifier-syntax">Thread_Work_Area</span><span class="plain-syntax"> = </span><a href="3-ts.html#SP4" class="function-link"><span class="function-syntax">Scheduler::work_area</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">slot_log_name</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/3-fln.html#SP2" class="function-link"><span class="function-syntax">Filenames::in</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">Thread_Work_Area</span><span class="plain-syntax">, </span><span class="identifier-syntax">FNAME</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">FNAME</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">use_threads</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><a href="3-ts.html#SP4" class="function-link"><span class="function-syntax">Scheduler::work_area</span></a><span class="plain-syntax">(0);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">sandboxes_made</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="reserved-syntax">pathname</span><span class="plain-syntax"> *</span><span class="function-syntax">Scheduler::work_area</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="function-syntax">Scheduler::work_area</span></span>:<br/>The Tester - <a href="4-tt.html#SP1_1">&#167;1.1</a>, <a href="4-tt.html#SP3">&#167;3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">s</span><span class="plain-syntax">&lt;0) || (</span><span class="identifier-syntax">s</span><span class="plain-syntax">&gt;=</span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">)) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"thread slot out of range"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">sandboxes_made</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">sandboxes_made</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">t</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">t</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">; </span><span class="identifier-syntax">t</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">TN</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">TN</span><span class="plain-syntax">, </span><span class="string-syntax">"T%d"</span><span class="plain-syntax">, </span><span class="identifier-syntax">t</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">pathname</span><span class="plain-syntax"> *</span><span class="identifier-syntax">workspace</span><span class="plain-syntax"> = </span><a href="2-gv.html#SP5" class="function-link"><span class="function-syntax">Globals::to_pathname</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">I</span><span class="string-syntax">"workspace"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">t</span><span class="plain-syntax">].</span><span class="element-syntax">sandbox</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/3-pth.html#SP4" class="function-link"><span class="function-syntax">Pathnames::down</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">workspace</span><span class="plain-syntax">, </span><span class="identifier-syntax">TN</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">TN</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">sandbox</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5.  </b>This is the only place in Intest where we invoke the dark magic of pthread
library calls. The main Intest thread will call <span class="extract"><span class="extract-syntax">pthread_create</span></span> to
call a function, always <span class="extract"><span class="extract-syntax">Scheduler::perform_work</span></span>, on a new thread.
When that function "returns", however, its thread does not cease to exist.
That happens only when the main Intest thread calls <span class="extract"><span class="extract-syntax">pthread_join</span></span> on it.
"Create" and "join" are, in effect, pthread jargon for "start" and "stop".
</p>

<p class="commentary">We clearly need some way for a work thread to signal back when it is
finished, as otherwise there will be no way for the main thread to know when
it is safe to join it. We do that with the <span class="extract"><span class="extract-syntax">availability</span></span> field in the slot
structure: when the working thread has done all its work, that thread sets
<span class="extract"><span class="extract-syntax">availability</span></span> to <span class="extract"><span class="extract-syntax">IDLE_THREAD</span></span>. It then becomes quiescent. Once every second
the main thread looks to see if any slots have become idle, and if so, it
then joins their threads.
</p>

<p class="commentary">As elegant as the Unix pthread model is, it's unfortunate that we are
expected to specify explicitly what stack size to allocate our work threads.
We will simply choose a Very Big Number and hope for the best.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">STACK_SIZE_PER_WORK_THREAD</span><span class="plain-syntax"> </span><span class="constant-syntax">0x8000000</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::start_work_on_slot</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="function-syntax">Scheduler::start_work_on_slot</span></span>:<br/><a href="3-ts.html#SP9_3_1_2">&#167;9.3.1.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> != </span><span class="constant-syntax">NO_THREAD</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"tried to start second thread in same slot"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> = </span><span class="constant-syntax">WORKING_THREAD</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><a href="../../../inweb/docs/foundation-module/1-wp.html#SP15" class="function-link"><span class="function-syntax">Platform::init_thread</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">attributes</span><span class="plain-syntax">, </span><span class="constant-syntax">STACK_SIZE_PER_WORK_THREAD</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="constant-syntax">TRACE_THREADING</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"Work on slot %d: "</span><span class="plain-syntax">, </span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">T</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOOP_OVER</span><span class="plain-syntax">(</span><span class="identifier-syntax">T</span><span class="plain-syntax">, </span><span class="reserved-syntax">test</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocated_to</span><span class="plain-syntax"> == </span><span class="identifier-syntax">s</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"T%d:%S "</span><span class="plain-syntax">, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocation_id</span><span class="plain-syntax">, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">test_case_name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">PRINT</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">rc</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/1-wp.html#SP15" class="function-link"><span class="function-syntax">Platform::create_thread</span></a><span class="plain-syntax">(&amp;(</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">work_thread</span><span class="plain-syntax">),</span>
<span class="plain-syntax">        &amp;(</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">attributes</span><span class="plain-syntax">),</span>
<span class="plain-syntax">        </span><a href="3-ts.html#SP10" class="function-link"><span class="function-syntax">Scheduler::perform_work</span></a><span class="plain-syntax">,</span>
<span class="plain-syntax">        (</span><span class="reserved-syntax">void</span><span class="plain-syntax"> *) &amp;(</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">counter</span><span class="plain-syntax">));</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">rc</span><span class="plain-syntax"> == </span><span class="identifier-syntax">EAGAIN</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"thread failed EAGAIN"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">rc</span><span class="plain-syntax"> == </span><span class="identifier-syntax">EINVAL</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"thread failed EINVAL"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">rc</span><span class="plain-syntax"> == </span><span class="identifier-syntax">EPERM</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"thread failed EPERM"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">rc</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"thread failed"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::stop_work_on_slot</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="function-syntax">Scheduler::stop_work_on_slot</span></span>:<br/><a href="3-ts.html#SP6">&#167;6</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">rc</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/1-wp.html#SP15" class="function-link"><span class="function-syntax">Platform::join_thread</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">work_thread</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">rc</span><span class="plain-syntax"> != </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"thread failed to join"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> = </span><span class="constant-syntax">NO_THREAD</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="identifier-syntax">size_t</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::stack_size</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="function-syntax">Scheduler::stack_size</span></span>:<br/><a href="3-ts.html#SP10">&#167;10</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><a href="../../../inweb/docs/foundation-module/1-wp.html#SP15" class="function-link"><span class="function-syntax">Platform::get_thread_stack_size</span></a><span class="plain-syntax">(&amp;(</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">attributes</span><span class="plain-syntax">));</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6.  </b></p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::stop_work_on_idle_slots</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="function-syntax">Scheduler::stop_work_on_idle_slots</span></span>:<br/><a href="3-ts.html#SP9_3">&#167;9.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">void</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> == </span><span class="constant-syntax">IDLE_THREAD</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><a href="3-ts.html#SP5" class="function-link"><span class="function-syntax">Scheduler::stop_work_on_slot</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::stop_work_on_all_slots</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="function-syntax">Scheduler::stop_work_on_all_slots</span></span>:<br/><a href="3-ts.html#SP9_3">&#167;9.3</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">void</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> != </span><span class="constant-syntax">NO_THREAD</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><a href="3-ts.html#SP5" class="function-link"><span class="function-syntax">Scheduler::stop_work_on_slot</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. Scheduling. </b>The scheduler completes one of the following structures for each test
performed: it's a form holding what to do and what the results were. For
now, scheduling consists of creating the structure with the results left
blank.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">NO_SLOT_AS_YET</span><span class="plain-syntax"> -1</span>
<span class="definition-keyword">define</span> <span class="constant-syntax">DONE_AND_NO_LONGER_NEEDS_SLOT</span><span class="plain-syntax"> -2</span>
</pre>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8.  </b></p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">test</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">test_case</span><span class="plain-syntax"> *</span><span class="identifier-syntax">to_be_tested</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">action_type</span><span class="plain-syntax">; </span><span class="comment-syntax"> for example, </span><span class="extract"><span class="extract-syntax">TEST_ACTION</span></span><span class="comment-syntax"> or </span><span class="extract"><span class="extract-syntax">BLESS_ACTION</span></span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">filename</span><span class="plain-syntax"> *</span><span class="identifier-syntax">redirect</span><span class="plain-syntax">; </span><span class="comment-syntax"> where to redirect console output</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">allocated_to</span><span class="plain-syntax">; </span><span class="comment-syntax"> an index into </span><span class="extract"><span class="extract-syntax">thread_slots</span></span><span class="comment-syntax">, or else one of the values above</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">passed</span><span class="plain-syntax">; </span><span class="comment-syntax"> or </span><span class="extract"><span class="extract-syntax">NOT_APPLICABLE</span></span><span class="comment-syntax"> if not yet run</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">full_results</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">previous_completed_test</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="constant-syntax">CLASS_DEFINITION</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">test</span><span class="plain-syntax">;</span>


<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::schedule</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="function-syntax">Scheduler::schedule</span></span>:<br/>Actions - <a href="2-act.html#SP9_2">&#167;9.2</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">test_case</span><span class="plain-syntax"> *</span><span class="identifier-syntax">tc</span><span class="plain-syntax">, </span><span class="reserved-syntax">filename</span><span class="plain-syntax"> *</span><span class="identifier-syntax">redirect</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">test_action</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">tc</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"no test case"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">T</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">test</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax"> = </span><span class="identifier-syntax">tc</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">redirect</span><span class="plain-syntax"> = </span><span class="identifier-syntax">redirect</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocated_to</span><span class="plain-syntax"> = </span><span class="constant-syntax">NO_SLOT_AS_YET</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">passed</span><span class="plain-syntax"> = </span><span class="constant-syntax">NOT_APPLICABLE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">action_type</span><span class="plain-syntax"> = </span><span class="identifier-syntax">test_action</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">full_results</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new_with_capacity</span></a><span class="plain-syntax">(20480);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">previous_completed_test</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<ul class="endnotetexts"><li>The structure test is accessed in 2/act and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. Distributing. </b>We will maintain a reverse linked list which holds the tests in the sequence
in which they completed &mdash; almost certainly out of their original scheduling
order, and sometimes drastically so. <span class="extract"><span class="extract-syntax">last_completed_test</span></span> is always the
most recent.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">last_completed_test</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">splitting_logs</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Scheduler::test</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="function-syntax">Scheduler::test</span></span>:<br/>Actions - <a href="2-act.html#SP7">&#167;7</a></span></button><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">NUMBER_CREATED</span><span class="plain-syntax">(</span><span class="reserved-syntax">test</span><span class="plain-syntax">) == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><a href="3-ts.html#SP4" class="function-link"><span class="function-syntax">Scheduler::initialise_slots</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">main_DL</span><span class="plain-syntax"> = </span><span class="identifier-syntax">DL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/2-dl.html#SP7" class="function-link"><span class="function-syntax">Log::aspect_switched_on</span></a><span class="plain-syntax">(</span><span class="constant-syntax">TESTER_DA</span><span class="plain-syntax">)) </span><span class="identifier-syntax">splitting_logs</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">splitting_logs</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_1" class="named-paragraph-link"><span class="named-paragraph">Split the debugging log into forks per thread</span><span class="named-paragraph-number">9.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">time_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">time_at_start</span><span class="plain-syntax"> = </span><span class="identifier-syntax">time</span><span class="plain-syntax">(0);</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_3" class="named-paragraph-link"><span class="named-paragraph">Allocate and run the tests</span><span class="named-paragraph-number">9.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">time_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">duration</span><span class="plain-syntax"> = </span><span class="identifier-syntax">time</span><span class="plain-syntax">(0) - </span><span class="identifier-syntax">time_at_start</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">splitting_logs</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_2" class="named-paragraph-link"><span class="named-paragraph">Unsplit the debugging log</span><span class="named-paragraph-number">9.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">splitting_logs</span><span class="plain-syntax">) </span><span class="identifier-syntax">splitting_logs</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_4" class="named-paragraph-link"><span class="named-paragraph">Write results banner</span><span class="named-paragraph-number">9.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP9_1" class="paragraph-anchor"></a><b>&#167;9.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Split the debugging log into forks per thread</span><span class="named-paragraph-number">9.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">TESTER</span><span class="plain-syntax">, </span><span class="string-syntax">"Splitting into independent debugging logs per thread here\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="../../../inweb/docs/foundation-module/2-dl.html#SP5" class="function-link"><span class="function-syntax">Log::close</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><a href="../../../inweb/docs/foundation-module/2-dl.html#SP5" class="function-link"><span class="function-syntax">Log::open_alternative</span></a><span class="plain-syntax">(</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">slot_log_name</span><span class="plain-syntax">, &amp;(</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">split_log</span><span class="plain-syntax">));</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOG</span><span class="plain-syntax">(</span><span class="string-syntax">"This log belongs to thread %d\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">DL</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9">&#167;9</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_2" class="paragraph-anchor"></a><b>&#167;9.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Unsplit the debugging log</span><span class="named-paragraph-number">9.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><a href="../../../inweb/docs/foundation-module/2-str.html#SP34" class="function-link"><span class="function-syntax">Streams::close</span></a><span class="plain-syntax">(&amp;(</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">split_log</span><span class="plain-syntax">));</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DL</span><span class="plain-syntax"> = </span><span class="identifier-syntax">main_DL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">TESTER</span><span class="plain-syntax">, </span><span class="string-syntax">"Back to a single debugging log here\n"</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9">&#167;9</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_3" class="paragraph-anchor"></a><b>&#167;9.3.  </b>The loop here, which of course runs on the main thread, sleeps for 1 second
with each iteration.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Allocate and run the tests</span><span class="named-paragraph-number">9.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">last_completed_test</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">, </span><span class="identifier-syntax">current_wildcard</span><span class="plain-syntax"> = </span><span class="constant-syntax">ALL_WILDCARD</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax"> = </span><span class="identifier-syntax">FIRST_OBJECT</span><span class="plain-syntax">(</span><span class="reserved-syntax">test</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">next_test_to_allocate</span><span class="plain-syntax"> = </span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">number_still_to_allocate</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NUMBER_CREATED</span><span class="plain-syntax">(</span><span class="reserved-syntax">test</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">STREAM_FLUSH</span><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="3-ts.html#SP6" class="function-link"><span class="function-syntax">Scheduler::stop_work_on_idle_slots</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_3_1" class="named-paragraph-link"><span class="named-paragraph">Allocate next few tests</span><span class="named-paragraph-number">9.3.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_3_2" class="named-paragraph-link"><span class="named-paragraph">Gather up recent reports</span><span class="named-paragraph-number">9.3.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><a href="../../../inweb/docs/foundation-module/1-wp.html#SP11" class="function-link"><span class="function-syntax">Platform::sleep</span></a><span class="plain-syntax">(1);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) { </span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">; </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">); }</span>
<span class="plain-syntax">    </span><a href="3-ts.html#SP6" class="function-link"><span class="function-syntax">Scheduler::stop_work_on_all_slots</span></a><span class="plain-syntax">();</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9">&#167;9</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_3_1" class="paragraph-anchor"></a><b>&#167;9.3.1.  </b>We make a list of all thread slots currently standing idle, and then
allocate them each a roughly equal number of the test cases not yet
allocated to any slot; but we stop when they have <span class="extract"><span class="extract-syntax">QUANTUM</span></span> number of
cases to look at.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Allocate next few tests</span><span class="named-paragraph-number">9.3.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">free_slot_list</span><span class="plain-syntax">[</span><span class="constant-syntax">MAX_THREADS</span><span class="plain-syntax">], </span><span class="identifier-syntax">given_over</span><span class="plain-syntax">[</span><span class="constant-syntax">MAX_THREADS</span><span class="plain-syntax">];</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">threads_free</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">; </span><span class="identifier-syntax">s</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> == </span><span class="constant-syntax">NO_THREAD</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">free_slot_list</span><span class="plain-syntax">[</span><span class="identifier-syntax">threads_free</span><span class="plain-syntax">] = </span><span class="identifier-syntax">s</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">given_over</span><span class="plain-syntax">[</span><span class="identifier-syntax">threads_free</span><span class="plain-syntax">++] = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">threads_free</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">number_still_to_allocate</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_3_1_1" class="named-paragraph-link"><span class="named-paragraph">Give each free slot up to QUANTUM-many test cases to work on</span><span class="named-paragraph-number">9.3.1.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_3_1_2" class="named-paragraph-link"><span class="named-paragraph">For each slot which which was given any, start a work thread</span><span class="named-paragraph-number">9.3.1.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="constant-syntax">TRACE_THREADING</span><span class="plain-syntax">) </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"Still to allocate: %d\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">number_still_to_allocate</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9_3">&#167;9.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_3_1_1" class="paragraph-anchor"></a><b>&#167;9.3.1.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Give each free slot up to QUANTUM-many test cases to work on</span><span class="named-paragraph-number">9.3.1.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> (</span><span class="identifier-syntax">next_test_to_allocate</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = </span><span class="identifier-syntax">free_slot_list</span><span class="plain-syntax">[</span><span class="identifier-syntax">c</span><span class="plain-syntax"> % </span><span class="identifier-syntax">threads_free</span><span class="plain-syntax">];</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">given_over</span><span class="plain-syntax">[</span><span class="identifier-syntax">c</span><span class="plain-syntax"> % </span><span class="identifier-syntax">threads_free</span><span class="plain-syntax">] &gt;= </span><span class="constant-syntax">QUANTUM</span><span class="plain-syntax">) </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">next_test_to_allocate</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocated_to</span><span class="plain-syntax"> = </span><span class="identifier-syntax">s</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">given_over</span><span class="plain-syntax">[</span><span class="identifier-syntax">c</span><span class="plain-syntax"> % </span><span class="identifier-syntax">threads_free</span><span class="plain-syntax">]++;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">number_still_to_allocate</span><span class="plain-syntax">--; </span><span class="identifier-syntax">c</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">next_test_to_allocate</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NEXT_OBJECT</span><span class="plain-syntax">(</span><span class="identifier-syntax">next_test_to_allocate</span><span class="plain-syntax">, </span><span class="reserved-syntax">test</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9_3_1">&#167;9.3.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_3_1_2" class="paragraph-anchor"></a><b>&#167;9.3.1.2.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">For each slot which which was given any, start a work thread</span><span class="named-paragraph-number">9.3.1.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">threads_free</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">given_over</span><span class="plain-syntax">[</span><span class="identifier-syntax">c</span><span class="plain-syntax">] &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="constant-syntax">TRACE_THREADING</span><span class="plain-syntax">)</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"starting work thread on slot %d to perform %d tests\n"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">free_slot_list</span><span class="plain-syntax">[</span><span class="identifier-syntax">c</span><span class="plain-syntax">], </span><span class="identifier-syntax">given_over</span><span class="plain-syntax">[</span><span class="identifier-syntax">c</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">            </span><a href="3-ts.html#SP5" class="function-link"><span class="function-syntax">Scheduler::start_work_on_slot</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">free_slot_list</span><span class="plain-syntax">[</span><span class="identifier-syntax">c</span><span class="plain-syntax">]);</span>
<span class="plain-syntax">        }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9_3_1">&#167;9.3.1</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_3_2" class="paragraph-anchor"></a><b>&#167;9.3.2.  </b>The only purpose of the following is to print something to the terminal so
that the user has some comforting evidence that work is going on. This is
where Intest's familiar chains of bracketed case numbers are printed:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    inter -&gt; cases: [1] [2] [3] [4] [5] [6] [7] (8) [9] [10] -11- [12] [13]</span>
</pre>
<p class="commentary">Note that they are grouped by "wildcard", in effect, by their case type.
The symbols placed either side of the case number, loosely called its
"brackets", are chosen by the Tester on the basis of the test's outcome.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Gather up recent reports</span><span class="named-paragraph-number">9.3.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (</span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocated_to</span><span class="plain-syntax"> == </span><span class="constant-syntax">DONE_AND_NO_LONGER_NEEDS_SLOT</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">T</span><span class="plain-syntax"> = </span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">w</span><span class="plain-syntax"> = </span><a href="2-act.html#SP6" class="function-link"><span class="function-syntax">Actions::which_wildcard</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">w</span><span class="plain-syntax"> != </span><span class="identifier-syntax">current_wildcard</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">current_wildcard</span><span class="plain-syntax"> = </span><span class="identifier-syntax">w</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) { </span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">; </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">); }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%p -&gt; %s: "</span><span class="plain-syntax">, </span><span class="identifier-syntax">home_project</span><span class="plain-syntax">, </span><a href="2-act.html#SP6" class="function-link"><span class="function-syntax">Actions::name_of_wildcard</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">w</span><span class="plain-syntax">));</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">passed</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> = </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%c%d%c "</span><span class="plain-syntax">, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">left_bracket</span><span class="plain-syntax">, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocation_id</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">right_bracket</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        } </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) { </span><span class="identifier-syntax">line_complete</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">; </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">); }</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">full_results</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NEXT_OBJECT</span><span class="plain-syntax">(</span><span class="identifier-syntax">next_to_report</span><span class="plain-syntax">, </span><span class="reserved-syntax">test</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">STREAM_FLUSH</span><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9_3">&#167;9.3</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_4" class="paragraph-anchor"></a><b>&#167;9.4.  </b>And, now the hurly-burly's done: now the battle's lost and won. We need to
print out the summary of what happened, e.g.:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    All 27 tests succeeded (time taken 0:02, 16 simultaneous threads)</span>
</pre>
<p class="commentary">The "bottom line" text here is "All 27 tests succeeded".
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Write results banner</span><span class="named-paragraph-number">9.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">successes</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">, </span><span class="identifier-syntax">failures</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">T</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_OVER</span><span class="plain-syntax">(</span><span class="identifier-syntax">T</span><span class="plain-syntax">, </span><span class="reserved-syntax">test</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">passed</span><span class="plain-syntax"> == </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">) </span><span class="identifier-syntax">successes</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">passed</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) </span><span class="identifier-syntax">failures</span><span class="plain-syntax">++;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">N</span><span class="plain-syntax"> = </span><span class="identifier-syntax">use_threads</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">N</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">successes</span><span class="plain-syntax"> + </span><span class="identifier-syntax">failures</span><span class="plain-syntax">) </span><span class="identifier-syntax">N</span><span class="plain-syntax"> = </span><span class="identifier-syntax">successes</span><span class="plain-syntax"> + </span><span class="identifier-syntax">failures</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">TEMPORARY_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">)</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_4_1" class="named-paragraph-link"><span class="named-paragraph">And the bottom line is...</span><span class="named-paragraph-number">9.4.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">failures</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP9_4_2" class="named-paragraph-link"><span class="named-paragraph">Recite our failures</span><span class="named-paragraph-number">9.4.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">successes</span><span class="plain-syntax"> + </span><span class="identifier-syntax">failures</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">10</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><a href="../../../inweb/docs/foundation-module/1-wp.html#SP12" class="function-link"><span class="function-syntax">Platform::notification</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, (</span><span class="identifier-syntax">failures</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">)?</span><span class="identifier-syntax">TRUE:FALSE</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DISCARD_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">)</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9">&#167;9</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_4_1" class="paragraph-anchor"></a><b>&#167;9.4.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">And the bottom line is...</span><span class="named-paragraph-number">9.4.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">successes</span><span class="plain-syntax"> + </span><span class="identifier-syntax">failures</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span><span class="plain-syntax">:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">successes</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"Failed"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"Succeeded"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="constant-syntax">2</span><span class="plain-syntax">:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">successes</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"Both tests failed"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">failures</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"Both tests succeeded"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"%d test succeeded but %d failed"</span><span class="plain-syntax">, </span><span class="identifier-syntax">successes</span><span class="plain-syntax">, </span><span class="identifier-syntax">failures</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">default:</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">successes</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"All %d tests failed"</span><span class="plain-syntax">, </span><span class="identifier-syntax">failures</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">failures</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"All %d tests succeeded"</span><span class="plain-syntax">, </span><span class="identifier-syntax">successes</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE_TO</span><span class="plain-syntax">(</span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, </span><span class="string-syntax">"%d test%s succeeded but %d failed"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">successes</span><span class="plain-syntax">, (</span><span class="identifier-syntax">successes</span><span class="plain-syntax">==1)?</span><span class="string-syntax">""</span><span class="plain-syntax">:</span><span class="string-syntax">"s"</span><span class="plain-syntax">, </span><span class="identifier-syntax">failures</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"  %S (time taken %d:%02d"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">bottom_line</span><span class="plain-syntax">, ((</span><span class="reserved-syntax">int</span><span class="plain-syntax">) </span><span class="identifier-syntax">duration</span><span class="plain-syntax">)/60, ((</span><span class="reserved-syntax">int</span><span class="plain-syntax">) </span><span class="identifier-syntax">duration</span><span class="plain-syntax">)%60);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">N</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">1</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">", %d simultaneous thread%s"</span><span class="plain-syntax">, </span><span class="identifier-syntax">N</span><span class="plain-syntax">, (</span><span class="identifier-syntax">N</span><span class="plain-syntax">==1)?</span><span class="string-syntax">""</span><span class="plain-syntax">:</span><span class="string-syntax">"s"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">")\n"</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9_4">&#167;9.4</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9_4_2" class="paragraph-anchor"></a><b>&#167;9.4.2.  </b>This does more than simply print the names of test cases which failed: it
also tells the Historian to give them numbered shortcut names in future.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Recite our failures</span><span class="named-paragraph-number">9.4.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"Failed:"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><a href="2-th.html#SP3" class="function-link"><span class="function-syntax">Historian::notify_failure_count</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">failures</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">f</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_OVER</span><span class="plain-syntax">(</span><span class="identifier-syntax">T</span><span class="plain-syntax">, </span><span class="reserved-syntax">test</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">passed</span><span class="plain-syntax"> == </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">" %d=%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">f</span><span class="plain-syntax">+1, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">test_case_name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><a href="2-th.html#SP3" class="function-link"><span class="function-syntax">Historian::notify_failure</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">f</span><span class="plain-syntax">++, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">test_case_name</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP9_4">&#167;9.4</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. Work threads begin here. </b>When a work thread is created, this is its function. The one argument is a
pointer to an integer, which tells us which slot number we are running in.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> *</span><span class="function-syntax">Scheduler::perform_work</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="function-syntax">Scheduler::perform_work</span></span>:<br/><a href="3-ts.html#SP5">&#167;5</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">void</span><span class="plain-syntax"> *</span><span class="identifier-syntax">argument</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">s</span><span class="plain-syntax"> = *((</span><span class="reserved-syntax">int</span><span class="plain-syntax"> *) </span><span class="identifier-syntax">argument</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/2-dl.html#SP7" class="function-link"><span class="function-syntax">Log::aspect_switched_on</span></a><span class="plain-syntax">(</span><span class="constant-syntax">TESTER_DA</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOG</span><span class="plain-syntax">(</span><span class="string-syntax">"Thread in slot %d has stack size %08x\n"</span><span class="plain-syntax">,</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">s</span><span class="plain-syntax">, </span><a href="3-ts.html#SP5" class="function-link"><span class="function-syntax">Scheduler::stack_size</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">s</span><span class="plain-syntax">));</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">test</span><span class="plain-syntax"> *</span><span class="identifier-syntax">T</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_OVER</span><span class="plain-syntax">(</span><span class="identifier-syntax">T</span><span class="plain-syntax">, </span><span class="reserved-syntax">test</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocated_to</span><span class="plain-syntax"> == </span><span class="identifier-syntax">s</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">result</span><span class="plain-syntax"> = </span><a href="4-tt.html#SP1" class="function-link"><span class="function-syntax">Tester::test</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">full_results</span><span class="plain-syntax">, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">to_be_tested</span><span class="plain-syntax">,</span>
<span class="plain-syntax">                </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocation_id</span><span class="plain-syntax"> + </span><span class="constant-syntax">1</span><span class="plain-syntax">, </span><span class="identifier-syntax">s</span><span class="plain-syntax">, </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">action_type</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="named-paragraph-container code-font"><a href="3-ts.html#SP10_1" class="named-paragraph-link"><span class="named-paragraph">Mark test T as completed</span><span class="named-paragraph-number">10.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="constant-syntax">TRACE_THREADING</span><span class="plain-syntax">) </span><span class="identifier-syntax">printf</span><span class="plain-syntax">(</span><span class="string-syntax">"(Thread in slot %d has finished.)\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">s</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">thread_slots</span><span class="plain-syntax">[</span><span class="identifier-syntax">s</span><span class="plain-syntax">].</span><span class="element-syntax">availability</span><span class="plain-syntax"> = </span><span class="constant-syntax">IDLE_THREAD</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP10_1" class="paragraph-anchor"></a><b>&#167;10.1.  </b>The mutex here is needed because there is just one global reverse linked
list of completed texts: if two threads were simultaneously changing the
value of <span class="extract"><span class="extract-syntax">last_completed_test</span></span>, disaster would befall us. This is so
unlikely to happen that the mutex here is about like taking insurance out
against asteroid impacts, but still, one likes to be safe.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Mark test T as completed</span><span class="named-paragraph-number">10.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">passed</span><span class="plain-syntax"> = </span><span class="identifier-syntax">result</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">allocated_to</span><span class="plain-syntax"> = </span><span class="constant-syntax">DONE_AND_NO_LONGER_NEEDS_SLOT</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">CREATE_MUTEX</span><span class="plain-syntax">(</span><span class="identifier-syntax">mutex</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOCK_MUTEX</span><span class="plain-syntax">(</span><span class="identifier-syntax">mutex</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">T</span><span class="plain-syntax">-&gt;</span><span class="identifier-syntax">previous_completed_test</span><span class="plain-syntax"> = </span><span class="identifier-syntax">last_completed_test</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">last_completed_test</span><span class="plain-syntax"> = </span><span class="identifier-syntax">T</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">UNLOCK_MUTEX</span><span class="plain-syntax">(</span><span class="identifier-syntax">mutex</span><span class="plain-syntax">);</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-ts.html#SP10">&#167;10</a>.</li></ul>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="2-te.html">&#10094;</a></li><li class="progresschapter"><a href="M-iti.html">M</a></li><li class="progresschapter"><a href="P-htpw.html">P</a></li><li class="progresschapter"><a href="1-bsc.html">1</a></li><li class="progresschapter"><a href="2-rf.html">2</a></li><li class="progresscurrentchapter">3</li><li class="progresscurrent">ts</li><li class="progresssection"><a href="3-th.html">th</a></li><li class="progresssection"><a href="3-td.html">td</a></li><li class="progresssection"><a href="3-tr.html">tr</a></li><li class="progresssection"><a href="3-skn.html">skn</a></li><li class="progresschapter"><a href="4-tdc.html">4</a></li><li class="progressnext"><a href="3-th.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

