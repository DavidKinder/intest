<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>3/td</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '3/tr' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">intest 2.0</a></li><li><a href="index.html#3">Chapter 3: Performing Tests</a></li><li><b>The Reporter</b></li></ul><p class="purpose">To produce reports for use in the Inform user interface app.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. About reports</a></li><li><a href="#SP2">&#167;2. Report feature</a></li><li><a href="#SP4">&#167;4. Combine feature</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. About reports. </b>This whole section applies only for the non-standard use case where Intest
is running inside the Inform user interface app. A "report" is then an
HTML page summarising the results of testing, which that app can then display.
Reports are heavily tied to the standard recipe for testing Inform source,
when it's run through I7, then I6, then executed to obtain a transcript of
the resulting play. As a result, any individual test can fail in a set
number of ways:
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">I7_FAILED_OUTCOME</span><span class="plain"> 1 </span>    <span class="comment">I7 issued problem messages</span>
    <span class="definitionkeyword">define</span> <span class="constant">I6_FAILED_OUTCOME</span><span class="plain"> 2 </span>    <span class="comment">I6 issued error messages</span>
    <span class="definitionkeyword">define</span> <span class="constant">CURSED_OUTCOME</span><span class="plain"> 3 </span>    <span class="comment">where there's no ideal transcript to compare against</span>
    <span class="definitionkeyword">define</span> <span class="constant">WRONG_TRANSCRIPT_OUTCOME</span><span class="plain"> 4 </span>    <span class="comment">the actual transcript didn't match the ideal</span>
    <span class="definitionkeyword">define</span> <span class="constant">PERFECT_OUTCOME</span><span class="plain"> 5</span>
</pre>
<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Report feature. </b>The following implements the <code class="display"><span class="extract">-report</span></code> command line feature.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reporter::report_single</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">test_case</span><span class="plain"> *</span><span class="identifier">tc</span><span class="plain">, </span><span class="reserved">action_item</span><span class="plain"> *</span><span class="identifier">ai</span><span class="plain">) {</span>
        <span class="reserved">report_state</span><span class="plain"> </span><span class="identifier">rs</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Initialise the report state</span> <span class="cwebmacronumber">2.2</span>&gt;<span class="plain">;</span>
        <span class="functiontext">TextFiles::read</span><span class="plain">(</span><span class="identifier">rs</span><span class="element">.prototype_HTML_file</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open test report file"</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">,</span>
            <span class="plain">&amp;</span><span class="functiontext">Reporter::filter</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">rs</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reporter::report_single is used in 2/act (<a href="2-act.html#SP8_2">&#167;8.2</a>).</p>

<p class="inwebparagraph"><a id="SP2_1"></a><b>&#167;2.1.  </b></p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">report_state</span><span class="plain"> {</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">REPORT_TO</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">test_case</span><span class="plain"> </span><span class="reserved">*test</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">success_code</span><span class="plain">; </span>    <span class="comment">one of the <code class="display"><span class="extract">*_OUTCOME</span></code> constants above</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">turns_keyed</span><span class="plain">; </span>    <span class="comment">number of commands auto-entered from a TEST ME</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">prototype_HTML_file</span><span class="plain">; </span>    <span class="comment">ultimately from the app</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">relevant_node_ID</span><span class="plain">; </span>    <span class="comment">to provide in-app links to the Skein</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">stage</span><span class="plain">; </span>    <span class="comment">where we are in scanning the prototype</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">first_flag</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">last_flag</span><span class="plain">;</span>
        <span class="reserved">char</span><span class="plain"> </span><span class="identifier">test_case_letter</span><span class="plain">; </span>    <span class="comment">'A' to 'Z': for cases in an extension project</span>
    <span class="plain">} </span><span class="reserved">report_state</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure report_state is private to this section.</p>

<p class="inwebparagraph"><a id="SP2_2"></a><b>&#167;2.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Initialise the report state</span> <span class="cwebmacronumber">2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">rs</span><span class="element">.test</span><span class="plain"> = </span><span class="identifier">tc</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.success_code</span><span class="plain"> = </span><span class="identifier">ai</span><span class="plain">-</span><span class="element">&gt;assoc_number</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.turns_keyed</span><span class="plain"> = </span><span class="identifier">ai</span><span class="plain">-</span><span class="element">&gt;assoc_number2</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.prototype_HTML_file</span><span class="plain"> = </span><span class="identifier">ai</span><span class="plain">-</span><span class="element">&gt;assoc_file1</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.relevant_node_ID</span><span class="plain"> = </span><span class="identifier">ai</span><span class="plain">-</span><span class="element">&gt;assoc_text</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.stage</span><span class="plain"> = 1;</span>
        <span class="identifier">rs</span><span class="element">.first_flag</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.last_flag</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.REPORT_TO</span><span class="plain"> = </span><span class="identifier">OUT</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;letter_reference</span><span class="plain"> &gt;= 1)</span>
            <span class="identifier">rs</span><span class="element">.test_case_letter</span><span class="plain"> = (</span><span class="reserved">char</span><span class="plain">) (((</span><span class="reserved">int</span><span class="plain">) </span><span class="character">'A'</span><span class="plain">) + </span><span class="identifier">tc</span><span class="plain">-</span><span class="element">&gt;letter_reference</span><span class="plain"> - 1);</span>
        <span class="reserved">else</span>
            <span class="identifier">rs</span><span class="element">.test_case_letter</span><span class="plain"> = 0;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2">&#167;2</a>.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>So, then, the following filter is run line by line on a prototype HTML file
nominated by the UI app. We will splice in our report.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reporter::filter</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line_text</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">vrs</span><span class="plain">) {</span>
        <span class="reserved">report_state</span><span class="plain"> *</span><span class="identifier">rs</span><span class="plain"> = </span><span class="identifier">vrs</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;REPORT_TO</span><span class="plain">;</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--CONTENT BEGINS--&gt;"</span><span class="plain">)) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;!--INTEST REPORT BEGINS--&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 2;</span>
        <span class="plain">}</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--BANNER BEGINS--&gt;"</span><span class="plain">)) </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 3;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--HEADING BEGINS--&gt;"</span><span class="plain">)) {</span>
            <span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 4;</span>
            &lt;<span class="cwebmacro">Insert test report header</span> <span class="cwebmacronumber">3.1</span>&gt;<span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--HEADING ENDS--&gt;"</span><span class="plain">)) </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 5;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--BANNER ENDS--&gt;"</span><span class="plain">)) </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 6;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--PROBLEMS BEGIN--&gt;"</span><span class="plain">)) {</span>
            <span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 7;</span>
            &lt;<span class="cwebmacro">Insert additional material</span> <span class="cwebmacronumber">3.2</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--PROBLEMS END--&gt;"</span><span class="plain">)) </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 8;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" &lt;!--CONTENT ENDS--&gt;"</span><span class="plain">)) {</span>
            <span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 9;</span>
            &lt;<span class="cwebmacro">Insert test report footer</span> <span class="cwebmacronumber">3.3</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;!--INTEST REPORT ENDS--&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 1) || (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 2) || (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 3) ||</span>
                <span class="plain">(</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 5) || (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 9) ||</span>
                    <span class="plain">((</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 7) &amp;&amp; (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain"> == </span><span class="constant">I7_FAILED_OUTCOME</span><span class="plain">)) ||</span>
                    <span class="plain">((</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 7) &amp;&amp; (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain"> == </span><span class="constant">I6_FAILED_OUTCOME</span><span class="plain">))</span>
                <span class="plain">)</span>
                &lt;<span class="cwebmacro">Filter existing report, adjusting links</span> <span class="cwebmacronumber">3.4</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reporter::filter is used in <a href="#SP2">&#167;2</a>.</p>

<p class="inwebparagraph"><a id="SP3_1"></a><b>&#167;3.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Insert test report header</span> <span class="cwebmacronumber">3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain"> == </span><span class="constant">PERFECT_OUTCOME</span><span class="plain">) || (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain"> == </span><span class="constant">CURSED_OUTCOME</span><span class="plain">))</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;div class=\</span><span class="plain">"</span><span class="string">headingboxSucceeded\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="reserved">else</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;div class=\</span><span class="plain">"</span><span class="string">headingboxFailed\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;div class=\</span><span class="plain">"</span><span class="string">headingtext\</span><span class="plain">"</span><span class="string">&gt;"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Example "</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;test_case_letter</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%c: "</span><span class="plain">, </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;test_case_letter</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&amp;#8216;%S&amp;#8217;: "</span><span class="plain">, </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;test</span><span class="plain">-</span><span class="element">&gt;test_case_title</span><span class="plain">);</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">WRONG_TRANSCRIPT_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Failed"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">PERFECT_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Succeeded"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CURSED_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Partly Succeeded"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">default</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Couldn't Test"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/div&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;div class=\</span><span class="plain">"</span><span class="string">headingrubric\</span><span class="plain">"</span><span class="string">&gt;"</span><span class="plain">);</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">I7_FAILED_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Problem messages meant it wouldn't translate"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">I6_FAILED_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Translated but failed to compile in Inform 6"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CURSED_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Translated but has no blessed transcript to check against"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">WRONG_TRANSCRIPT_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Translated but produced the wrong transcript"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">PERFECT_OUTCOME</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Translated and produced the correct transcript"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/div&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/div&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP3_2"></a><b>&#167;3.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Insert additional material</span> <span class="cwebmacronumber">3.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;p class=\</span><span class="plain">"</span><span class="string">tightin1\</span><span class="plain">"</span><span class="string">&gt;&amp;nbsp;"</span>
            <span class="string">"&lt;a href=\</span><span class="plain">"</span><span class="string">source:story.ni"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;test_case_letter</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"?case=%c"</span><span class="plain">, </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;test_case_letter</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"#line1\</span><span class="plain">"</span><span class="string">&gt;&lt;img border=0 src=inform:/doc_images/Reveal.png&gt;&lt;/a&gt; "</span>
            <span class="string">"Source text"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain"> != </span><span class="constant">I6_FAILED_OUTCOME</span><span class="plain">) &amp;&amp; (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain"> != </span><span class="constant">I7_FAILED_OUTCOME</span><span class="plain">)) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&amp;nbsp;&amp;bull;"</span><span class="plain">);</span>
            &lt;<span class="cwebmacro">Insert link to transcript</span> <span class="cwebmacronumber">3.2.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Transcript of play (%d turn%s)"</span><span class="plain">,</span>
                <span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain">, (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain"> == 1)?</span><span class="string">""</span><span class="plain">:</span><span class="string">"s"</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;br&gt;&amp;nbsp;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/p&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;success_code</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CURSED_OUTCOME</span><span class="plain">:</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;p class=\</span><span class="plain">"</span><span class="string">in2\</span><span class="plain">"</span><span class="string">&gt;This translated fine, so "</span>
                    <span class="string">"I could play it. "</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain"> &gt; 0)</span>
                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"I automatically typed in %d command%s extracted from the "</span>
                        <span class="string">"TEST ME in the source. "</span><span class="plain">,</span>
                        <span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain">, (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain"> == 1)?</span><span class="string">""</span><span class="plain">:</span><span class="string">"s"</span><span class="plain">);</span>
                <span class="reserved">else</span>
                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"The source text didn't have a TEST ME included, so I didn't "</span>
                        <span class="string">"type any commands into it. "</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"(Click"</span><span class="plain">);</span>
                &lt;<span class="cwebmacro">Insert link to transcript</span> <span class="cwebmacronumber">3.2.1</span>&gt;<span class="plain">;</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"to see.)&lt;/p&gt;"</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;p class=\</span><span class="plain">"</span><span class="string">in2\</span><span class="plain">"</span><span class="string">&gt;But I didn't know what to "</span>
                    <span class="string">"check the transcript against, so I can't say whether it's "</span>
                    <span class="string">"correct. Take a look: if it's right, 'bless' the transcript "</span>
                    <span class="string">"with the tick icons. I will then use that on future tests.&lt;/p&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">WRONG_TRANSCRIPT_OUTCOME</span><span class="plain">:</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;p class=\</span><span class="plain">"</span><span class="string">in2\</span><span class="plain">"</span><span class="string">&gt;This translated fine, so "</span>
                    <span class="string">"I could play it. "</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain"> &gt; 0)</span>
                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"(I automatically typed in %d command%s extracted from the "</span>
                        <span class="string">"TEST ME in the source.) "</span><span class="plain">,</span>
                        <span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain">, (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;turns_keyed</span><span class="plain"> == 1)?</span><span class="string">""</span><span class="plain">:</span><span class="string">"s"</span><span class="plain">);</span>
                <span class="reserved">else</span>
                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"(The source text didn't have a TEST ME included, so I didn't "</span>
                        <span class="string">"type any commands into it.) "</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"But the resulting text didn't match the "</span>
                    <span class="string">"'blessed' version. (Click"</span><span class="plain">);</span>
                &lt;<span class="cwebmacro">Insert link to transcript</span> <span class="cwebmacronumber">3.2.1</span>&gt;<span class="plain">;</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"to see what went wrong.)&lt;/p&gt;"</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;p class=\</span><span class="plain">"</span><span class="string">in2\</span><span class="plain">"</span><span class="string">&gt;If you intended this, you "</span>
                    <span class="string">"can 'bless' the new version as better, and I'll compare against "</span>
                    <span class="string">"that in future tests. But if it's just plain wrong, I can't help: "</span>
                    <span class="string">"you have some work to do on the source.&lt;/p&gt;"</span><span class="plain">);</span>
                <span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP3_2_1"></a><b>&#167;3.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Insert link to transcript</span> <span class="cwebmacronumber">3.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&amp;nbsp;&lt;a href='skein:%S"</span><span class="plain">, </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;relevant_node_ID</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;test_case_letter</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"?case=%c"</span><span class="plain">, </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;test_case_letter</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"'&gt;&lt;img border=0 src=inform:/doc_images/Transcript.png&gt;&lt;/a&gt;&amp;nbsp;"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3_2">&#167;3.2</a> (three times).</p>

<p class="inwebparagraph"><a id="SP3_3"></a><b>&#167;3.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Insert test report footer</span> <span class="cwebmacronumber">3.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;p&gt;&lt;/p&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP3_4"></a><b>&#167;3.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Filter existing report, adjusting links</span> <span class="cwebmacronumber">3.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Combine feature. </b>The following implements the <code class="display"><span class="extract">-combine</span></code> command line feature. Essentially it
takes a batch of reports made by <code class="display"><span class="extract">-report</span></code> and merges them together.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reporter::combine</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">base_filename</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain"> = 1; </span><span class="identifier">i</span><span class="plain"> &lt;= </span><span class="identifier">count</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="reserved">report_state</span><span class="plain"> </span><span class="identifier">rs</span><span class="plain">;</span>
            &lt;<span class="cwebmacro">Initialise the report state for combination</span> <span class="cwebmacronumber">4.1</span>&gt;<span class="plain">;</span>
            <span class="functiontext">TextFiles::read</span><span class="plain">(</span><span class="identifier">rs</span><span class="element">.prototype_HTML_file</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open test report file"</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">,</span>
                <span class="plain">&amp;</span><span class="functiontext">Reporter::combine_filter</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">rs</span><span class="plain">);</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reporter::combine is used in 2/act (<a href="2-act.html#SP8_2">&#167;8.2</a>).</p>

<p class="inwebparagraph"><a id="SP4_1"></a><b>&#167;4.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Initialise the report state for combination</span> <span class="cwebmacronumber">4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">rs</span><span class="element">.test</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.success_code</span><span class="plain"> = -1;</span>
        <span class="reserved">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Filenames::get_path_to</span><span class="plain">(</span><span class="identifier">base_filename</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">NEWLEAF</span><span class="plain">);</span>
        <span class="functiontext">Filenames::write_unextended_leafname</span><span class="plain">(</span><span class="identifier">NEWLEAF</span><span class="plain">, </span><span class="identifier">base_filename</span><span class="plain">);</span>
        <span class="functiontext">Str::truncate</span><span class="plain">(</span><span class="identifier">NEWLEAF</span><span class="plain">, 16);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">NEWLEAF</span><span class="plain">, </span><span class="string">"-%d.html"</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">);</span>
        <span class="identifier">rs</span><span class="element">.prototype_HTML_file</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">NEWLEAF</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">NEWLEAF</span><span class="plain">);</span>
        <span class="identifier">rs</span><span class="element">.relevant_node_ID</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.first_flag</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.last_flag</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain"> == 1) </span><span class="identifier">rs</span><span class="element">.first_flag</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain"> == </span><span class="identifier">count</span><span class="plain">) </span><span class="identifier">rs</span><span class="element">.last_flag</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.stage</span><span class="plain"> = 1;</span>
        <span class="identifier">rs</span><span class="element">.REPORT_TO</span><span class="plain"> = </span><span class="identifier">OUT</span><span class="plain">;</span>
        <span class="identifier">rs</span><span class="element">.test_case_letter</span><span class="plain"> = (</span><span class="reserved">char</span><span class="plain">) (((</span><span class="reserved">int</span><span class="plain">) </span><span class="character">'A'</span><span class="plain">) + </span><span class="identifier">i</span><span class="plain"> - 1);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Reporter::combine_filter</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line_text</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">vrs</span><span class="plain">) {</span>
        <span class="reserved">report_state</span><span class="plain"> *</span><span class="identifier">rs</span><span class="plain"> = </span><span class="identifier">vrs</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;REPORT_TO</span><span class="plain">;</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;!--INTEST REPORT BEGINS--&gt;"</span><span class="plain">)) </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 2;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;!--INTEST REPORT ENDS--&gt;"</span><span class="plain">)) </span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> = 3;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (((</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 1) &amp;&amp; (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;first_flag</span><span class="plain">)) || ((</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 3) &amp;&amp; (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;last_flag</span><span class="plain">)))</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rs</span><span class="plain">-</span><span class="element">&gt;stage</span><span class="plain"> == 2) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Reporter::combine_filter is used in <a href="#SP4">&#167;4</a>.</p>

<!--End of weave: 247 lines from a web of 15150-->
	</body>
</html>

