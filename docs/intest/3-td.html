<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>The Differ</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-assets/Intest.png" height=72">
</a></h1>
<ul><li><a href="index.html"><span class="selectedlink">intest</span></a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/intest"><img src="../docs-assets/github.png" height=18> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="../../../inweb/docs/index.html">inweb</a></li>
<li><a href="../../../inform/docs/index.html">inform</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'The Differ' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">intest</a></li><li><a href="index.html#3">Chapter 3: Performing Tests</a></li><li><b>The Differ</b></li></ul></div>
<p class="purpose">To provide text matching in the style of the Unix tool diff.</p>

<ul class="toc"><li><a href="3-td.html#SP3">&#167;3. Edit lists</a></li><li><a href="3-td.html#SP6">&#167;6. The diff algorithm</a></li><li><a href="3-td.html#SP10">&#167;10. Printing results</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1"></a><b>&#167;1.  </b>Our task is to take two strings, "ideal" and "actual", and return a
fairly minimal, fairly legible sequence of edits which would turn ideal
into actual. We won't use Myers's algorithm because it's overkill for the
text sizes we have here, and because we want to pay more attention to
word boundaries so as to produce human-readable results; the running
time below is worst-case quadratic in the number of words scanned, but
plenty fast enough for IF transcript use in practice.
</p>

<p class="commentary">We represent the series of edits as a linked list of <span class="extract"><span class="extract-syntax">edit</span></span> structures,
and although these are not uniquely defined (the same comparison can
be represented in more than one way as a linked list of edits), we
do guarantee that the returned list will be empty if and only if the
ideal string has safely matched the actual one. As we'll see, this
is not quite as simple as saying that they hold the same text, because
some minor discrepancies are allowed.
</p>

<p class="commentary">Our main routine, then, will return (a pointer to) the following structure.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">diff_results</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">ideal</span><span class="plain-syntax">; </span><span class="comment-syntax"> record a copy of the question as well as the answer</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">actual</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">edits</span><span class="plain-syntax">; </span><span class="comment-syntax"> of </span><span class="extract"><span class="extract-syntax">edit</span></span>
<span class="plain-syntax">    </span><span class="constant-syntax">MEMORY_MANAGEMENT</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">diff_results</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>The structure diff_results is accessed in 3/skn and here.</li></ul>
<p class="commentary firstcommentary"><a id="SP2"></a><b>&#167;2.  </b>Each edit consists of a nonempty chunk of text to be deleted, preserved
or inserted:
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">DELETE_EDIT</span><span class="plain-syntax"> -1</span>
<span class="definition-keyword">define</span> <span class="constant-syntax">PRESERVE_EDIT</span><span class="plain-syntax"> </span><span class="constant-syntax">0</span>
<span class="definition-keyword">define</span> <span class="constant-syntax">INSERT_EDIT</span><span class="plain-syntax"> </span><span class="constant-syntax">1</span>
</pre>
<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">typedef</span><span class="plain-syntax"> </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">struct</span><span class="plain-syntax"> </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">fragment</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">form_of_edit</span><span class="plain-syntax">; </span><span class="comment-syntax"> one of the </span><span class="extract"><span class="extract-syntax">*_EDIT</span></span><span class="comment-syntax"> values</span>
<span class="plain-syntax">    </span><span class="constant-syntax">MEMORY_MANAGEMENT</span>
<span class="plain-syntax">} </span><span class="reserved-syntax">edit</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>The structure edit is private to this section.</li></ul>
<p class="commentary firstcommentary"><a id="SP3"></a><b>&#167;3. Edit lists. </b>We start with some boring routines to handle linked lists of edits in general.
First, creating a single new edit:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="function-syntax">Differ::new_edit</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="function-syntax">Differ::new_edit</span></span>:<br/><a href="3-td.html#SP7_1">&#167;7.1</a>, <a href="3-td.html#SP8_1">&#167;8.1</a>, <a href="3-td.html#SP8_2">&#167;8.2</a>, <a href="3-td.html#SP8_3">&#167;8.3</a>, <a href="3-td.html#SP8_4">&#167;8.4</a>, <a href="3-td.html#SP8_5">&#167;8.5</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">from</span><span class="plain-syntax">, </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">to</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">form</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">edit</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP2" class="function-link"><span class="function-syntax">Str::new</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::substr</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax">, </span><span class="identifier-syntax">from</span><span class="plain-syntax">, </span><span class="identifier-syntax">to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">form_of_edit</span><span class="plain-syntax"> = </span><span class="identifier-syntax">form</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">E</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP4"></a><b>&#167;4.  </b>Since we're not going to do any patching, the only thing we do with edit
lists is to print them out. The octal character values here represent ASCII
escape (27) followed by standard terminal emulation codes on Unix shells for
coloured text: deletions are in red, insertions in green.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">results_colouring</span><span class="plain-syntax"> = </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::set_colour_usage</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="function-syntax">Differ::set_colour_usage</span></span>:<br/>Main - <a href="1-mn.html#SP1_4">&#167;1.4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">state</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">results_colouring</span><span class="plain-syntax"> = </span><span class="identifier-syntax">state</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::print_edit_list</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="function-syntax">Differ::print_edit_list</span></span>:<br/><a href="3-td.html#SP8_4">&#167;8.4</a>, <a href="3-td.html#SP10">&#167;10</a></span></button><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">L</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">original</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">L</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">original</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">L</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">form_of_edit</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DELETE_EDIT:</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">results_colouring</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\033[31m"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;deleted:"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">results_colouring</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\033[0m"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&gt;"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">PRESERVE_EDIT:</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">INSERT_EDIT:</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">results_colouring</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\033[32m"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;inserted:"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%S"</span><span class="plain-syntax">, </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">results_colouring</span><span class="plain-syntax">) </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"\033[0m"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&gt;"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5"></a><b>&#167;5.  </b>Now for basically the same thing in HTML, using CSS spans instead of terminal
colours:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::print_edit_list_as_HTML</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="function-syntax">Differ::print_edit_list_as_HTML</span></span>:<br/><a href="3-td.html#SP10">&#167;10</a></span></button><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">L</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">original</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;html&gt;\n&lt;body&gt;\n&lt;p class=\"node\"&gt;\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">L</span><span class="plain-syntax"> == </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">) </span><a href="3-td.html#SP5" class="function-link"><span class="function-syntax">Differ::print_fragment_as_HTML</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">original</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">else</span><span class="plain-syntax"> {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">L</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">form_of_edit</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">DELETE_EDIT:</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;span class=\"deletion\"&gt;"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><a href="3-td.html#SP5" class="function-link"><span class="function-syntax">Differ::print_fragment_as_HTML</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;/span&gt;"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">PRESERVE_EDIT:</span>
<span class="plain-syntax">                    </span><a href="3-td.html#SP5" class="function-link"><span class="function-syntax">Differ::print_fragment_as_HTML</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="identifier-syntax">INSERT_EDIT:</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;span class=\"insertion\"&gt;"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><a href="3-td.html#SP5" class="function-link"><span class="function-syntax">Differ::print_fragment_as_HTML</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">fragment</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;/span&gt;"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::print_fragment_as_HTML</span><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">original</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_THROUGH_TEXT</span><span class="plain-syntax">(</span><span class="identifier-syntax">pos</span><span class="plain-syntax">, </span><span class="identifier-syntax">original</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">pos</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">switch</span><span class="plain-syntax"> (</span><span class="identifier-syntax">c</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="character-syntax">'&lt;'</span><span class="plain-syntax">: </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&amp;lt;"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="character-syntax">'&gt;'</span><span class="plain-syntax">: </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&amp;gt;"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">case</span><span class="plain-syntax"> </span><span class="character-syntax">'&amp;'</span><span class="plain-syntax">: </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"&amp;amp;"</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">default:</span><span class="plain-syntax"> </span><span class="identifier-syntax">WRITE</span><span class="plain-syntax">(</span><span class="string-syntax">"%c"</span><span class="plain-syntax">, </span><span class="identifier-syntax">c</span><span class="plain-syntax">); </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP6"></a><b>&#167;6. The diff algorithm. </b>We do this in the simplest way possible. This outer routine, which is not
recursively called, sets up the returned structure and sends it back.
</p>

<p class="commentary">Note that a sequence of edits with no insertions or deletions means the
match was in fact perfect, and is converted to the null edit list.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">diff_results</span><span class="plain-syntax"> *</span><span class="function-syntax">Differ::diff</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="function-syntax">Differ::diff</span></span>:<br/>Skeins - <a href="3-skn.html#SP10_1_1">&#167;10.1.1</a>, <a href="3-skn.html#SP11">&#167;11</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">ideal</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">actual</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">diff_results</span><span class="plain-syntax"> *</span><span class="identifier-syntax">DR</span><span class="plain-syntax"> = </span><span class="identifier-syntax">CREATE</span><span class="plain-syntax">(</span><span class="reserved-syntax">diff_results</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DR</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">ideal</span><span class="plain-syntax"> = </span><span class="identifier-syntax">ideal</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DR</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">actual</span><span class="plain-syntax"> = </span><span class="identifier-syntax">actual</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"Differ:\nA = %S\nB = %S\n"</span><span class="plain-syntax">, </span><span class="identifier-syntax">ideal</span><span class="plain-syntax">, </span><span class="identifier-syntax">actual</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DR</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">edits</span><span class="plain-syntax"> = </span><a href="3-td.html#SP7" class="function-link"><span class="function-syntax">Differ::diff_outer</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">ideal</span><span class="plain-syntax">, </span><span class="identifier-syntax">actual</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOOP_OVER_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">DR</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">edits</span><span class="plain-syntax">)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">E</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">form_of_edit</span><span class="plain-syntax"> != </span><span class="constant-syntax">PRESERVE_EDIT</span><span class="plain-syntax">)</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">DR</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">DR</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">edits</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NEW_LINKED_LIST</span><span class="plain-syntax">(</span><span class="reserved-syntax">edit</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">DR</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP7"></a><b>&#167;7.  </b>The first level down simply starts the recursion, though it checks for
version lines first.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="function-syntax">Differ::diff_outer</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="function-syntax">Differ::diff_outer</span></span>:<br/><a href="3-td.html#SP6">&#167;6</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">B</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">edits</span><span class="plain-syntax"> = </span><span class="identifier-syntax">NEW_LINKED_LIST</span><span class="plain-syntax">(</span><span class="reserved-syntax">edit</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_from</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP10" class="function-link"><span class="function-syntax">Str::start</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_to</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP10" class="function-link"><span class="function-syntax">Str::end</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_from</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP10" class="function-link"><span class="function-syntax">Str::start</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_to</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP10" class="function-link"><span class="function-syntax">Str::end</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B</span><span class="plain-syntax">);</span>

<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-td.html#SP7_1" class="named-paragraph-link"><span class="named-paragraph">If both texts contain the Inform banner version line, diff around that</span><span class="named-paragraph-number">7.1</span></a></span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><a href="3-td.html#SP8" class="function-link"><span class="function-syntax">Differ::diff_inner</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">edits</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP7_1"></a><b>&#167;7.1.  </b>Any correctly formed I7 banner matches any other; this ensures that
transcripts of the same interaction, taken from builds on different days or
with different compiler versions, continue to match.
</p>

<p class="commentary">If text A (as we call the ideal version) and text B (the actual) both contain
I7 banners, we split them into before, then the banner, then after. The result
then consists of a diff of the before-texts, followed by preserving the actual
banner, followed by a diff of the after-texts.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">If both texts contain the Inform banner version line, diff around that</span><span class="named-paragraph-number">7.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">match_results</span><span class="plain-syntax"> </span><span class="identifier-syntax">mr</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9" class="function-link"><span class="function-syntax">Regexp::create_mr</span></a><span class="plain-syntax">();</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">wchar_t</span><span class="plain-syntax"> *</span><span class="identifier-syntax">template</span><span class="plain-syntax"> = </span><span class="identifier-syntax">L</span><span class="string-syntax">"(%c*?)(Release %d+ / Serial number %d+ / "</span>
<span class="plain-syntax">        </span><span class="string-syntax">"Inform 7 build %c%c%c%c %cI6%c+?%c+?SD)%c*"</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10" class="function-link"><span class="function-syntax">Regexp::match</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">, </span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">template</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_ver</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">mr</span><span class="plain-syntax">.</span><span class="element-syntax">exp</span><span class="plain-syntax">[0])); </span><span class="comment-syntax"> at the R in "Release"</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_post</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_ver</span><span class="plain-syntax">, </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">mr</span><span class="plain-syntax">.</span><span class="element-syntax">exp</span><span class="plain-syntax">[1])); </span><span class="comment-syntax"> after version line ends</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10" class="function-link"><span class="function-syntax">Regexp::match</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">, </span><span class="identifier-syntax">B</span><span class="plain-syntax">, </span><span class="identifier-syntax">template</span><span class="plain-syntax">)) {</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_ver</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">mr</span><span class="plain-syntax">.</span><span class="element-syntax">exp</span><span class="plain-syntax">[0]));</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_post</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_ver</span><span class="plain-syntax">, </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8" class="function-link"><span class="function-syntax">Str::len</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">mr</span><span class="plain-syntax">.</span><span class="element-syntax">exp</span><span class="plain-syntax">[1]));</span>

<span class="plain-syntax">            </span><a href="3-td.html#SP8" class="function-link"><span class="function-syntax">Differ::diff_inner</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_ver</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_ver</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_ver</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_post</span><span class="plain-syntax">, </span><span class="constant-syntax">PRESERVE_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><a href="3-td.html#SP8" class="function-link"><span class="function-syntax">Differ::diff_inner</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_post</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_post</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9" class="function-link"><span class="function-syntax">Regexp::dispose_of</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">);</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="identifier-syntax">edits</span><span class="plain-syntax">;</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9" class="function-link"><span class="function-syntax">Regexp::dispose_of</span></a><span class="plain-syntax">(&amp;</span><span class="identifier-syntax">mr</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-td.html#SP7">&#167;7</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8"></a><b>&#167;8.  </b>The second level is at last recursive.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::diff_inner</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="function-syntax">Differ::diff_inner</span></span>:<br/><a href="3-td.html#SP7">&#167;7</a>, <a href="3-td.html#SP7_1">&#167;7.1</a>, <a href="3-td.html#SP8_2">&#167;8.2</a>, <a href="3-td.html#SP8_3">&#167;8.3</a>, <a href="3-td.html#SP8_4">&#167;8.4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">linked_list</span><span class="plain-syntax"> *</span><span class="identifier-syntax">edits</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">,</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_len</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_len</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">A_len</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">B_len</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">)) </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">A_len</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"A text negative"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">B_len</span><span class="plain-syntax"> &lt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"B text negative"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"Differ (recursion):\nA (%d chars) = "</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_len</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/2-dl.html#SP7" class="function-link"><span class="function-syntax">Log::aspect_switched_on</span></a><span class="plain-syntax">(</span><span class="constant-syntax">DIFFER_DA</span><span class="plain-syntax">)) </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::substr</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">DL</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"\nB (%d chars) = "</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_len</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/2-dl.html#SP7" class="function-link"><span class="function-syntax">Log::aspect_switched_on</span></a><span class="plain-syntax">(</span><span class="constant-syntax">DIFFER_DA</span><span class="plain-syntax">)) </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP26" class="function-link"><span class="function-syntax">Str::substr</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">DL</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-td.html#SP8_1" class="named-paragraph-link"><span class="named-paragraph">If A is empty B must be inserted, if B is empty A must be deleted</span><span class="named-paragraph-number">8.1</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-td.html#SP8_2" class="named-paragraph-link"><span class="named-paragraph">Any common prefix can be preserved</span><span class="named-paragraph-number">8.2</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-td.html#SP8_3" class="named-paragraph-link"><span class="named-paragraph">Any common suffix can be preserved</span><span class="named-paragraph-number">8.3</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-td.html#SP8_4" class="named-paragraph-link"><span class="named-paragraph">Splice around the longest common substring</span><span class="named-paragraph-number">8.4</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="named-paragraph-container code-font"><a href="3-td.html#SP8_5" class="named-paragraph-link"><span class="named-paragraph">If all else fails we can always just delete A and insert B</span><span class="named-paragraph-number">8.5</span></a></span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP8_1"></a><b>&#167;8.1.  </b><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">If A is empty B must be inserted, if B is empty A must be deleted</span><span class="named-paragraph-number">8.1</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">A_len</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">, </span><span class="constant-syntax">INSERT_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">B_len</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">, </span><span class="constant-syntax">DELETE_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-td.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_2"></a><b>&#167;8.2.  </b>We look for the longest common prefix consisting of a sequence of entire
words, or at any rate, ending at a word boundary (in both texts).
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Any common prefix can be preserved</span><span class="named-paragraph-number">8.2</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax"> = </span><span class="identifier-syntax">A_from</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax"> = </span><span class="identifier-syntax">B_from</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">) &lt; </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_to</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">            (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax">) &lt; </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_to</span><span class="plain-syntax">));</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::forward</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">),</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::forward</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">) != </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax">))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"Common prefix size %d\n"</span><span class="plain-syntax">, </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">));</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> roll backwards until we're at a word boundary between the prefix and the rest</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (!</span><a href="3-td.html#SP9" class="function-link"><span class="function-syntax">Differ::boundary</span></a><span class="plain-syntax">(</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">)), </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">)))) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"After rollback, prefix size %d\n"</span><span class="plain-syntax">, </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">));</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> if there's anything left, mark it as common text and recurse to move past it</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">, </span><span class="constant-syntax">PRESERVE_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="3-td.html#SP8" class="function-link"><span class="function-syntax">Differ::diff_inner</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_after_prefix</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_after_prefix</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-td.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_3"></a><b>&#167;8.3.  </b>Similarly, we're only interested in a common suffix going back to the start
of a whole word.
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Any common suffix can be preserved</span><span class="named-paragraph-number">8.3</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax"> = </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax"> = </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (; (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">) &gt; </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">)) &amp;&amp;</span>
<span class="plain-syntax">        (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax">) &gt; </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::index</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_from</span><span class="plain-syntax">));</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">),</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax">))</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">)) != </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax">)))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">break</span><span class="plain-syntax">;</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> roll forwards until we're at a word boundary between the front and the suffix</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">        (!</span><a href="3-td.html#SP9" class="function-link"><span class="function-syntax">Differ::boundary</span></a><span class="plain-syntax">(</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::back</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">)), </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">)))) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::forward</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::forward</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    }</span>

<span class="plain-syntax">    </span><span class="comment-syntax"> if there's anything left, mark it as common text and recurse to move back past it</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::width_between</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">) &gt; </span><span class="constant-syntax">0</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><a href="3-td.html#SP8" class="function-link"><span class="function-syntax">Differ::diff_inner</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_suffix</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_suffix</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">, </span><span class="constant-syntax">PRESERVE_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-td.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_4"></a><b>&#167;8.4.  </b>In the typical use case most of the strings will now be gone, and this is
where the algorithm goes quadratic. We're going to look for the longest
common substring between A and B, provided it occurs at word boundaries,
and is not trivially short. If we find this, we'll recurse to diff the
text before the substring, then preserve the substring, then recurse to
diff the text afterwards.
</p>

<pre class="definitions code-font"><span class="definition-keyword">define</span> <span class="constant-syntax">MINIMUM_SPLICE_WORTH_BOTHERING_WITH</span><span class="plain-syntax"> </span><span class="constant-syntax">5</span>
<span class="definition-keyword">define</span> <span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">n</span><span class="plain-syntax">) </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13" class="function-link"><span class="function-syntax">Str::get</span></a><span class="plain-syntax">(</span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">##</span><span class="identifier-syntax">_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">n</span><span class="plain-syntax">))</span>
</pre>
<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">Splice around the longest common substring</span><span class="named-paragraph-number">8.4</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">max_i</span><span class="plain-syntax"> = -1, </span><span class="identifier-syntax">max_j</span><span class="plain-syntax"> = -1, </span><span class="identifier-syntax">max_len</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">i</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">A_len</span><span class="plain-syntax">; </span><span class="identifier-syntax">i</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">i</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) || (</span><a href="3-td.html#SP9" class="function-link"><span class="function-syntax">Differ::boundary</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">-1), </span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">))))</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">j</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; </span><span class="identifier-syntax">j</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">B_len</span><span class="plain-syntax">; </span><span class="identifier-syntax">j</span><span class="plain-syntax">++)</span>
<span class="plain-syntax">                </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">j</span><span class="plain-syntax"> == </span><span class="constant-syntax">0</span><span class="plain-syntax">) || (</span><a href="3-td.html#SP9" class="function-link"><span class="function-syntax">Differ::boundary</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">B</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">-1), </span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">B</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">)))) {</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">k</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="identifier-syntax">k</span><span class="plain-syntax"> = </span><span class="constant-syntax">0</span><span class="plain-syntax">; (</span><span class="identifier-syntax">i</span><span class="plain-syntax">+</span><span class="identifier-syntax">k</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">A_len</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">j</span><span class="plain-syntax">+</span><span class="identifier-syntax">k</span><span class="plain-syntax"> &lt; </span><span class="identifier-syntax">B_len</span><span class="plain-syntax">) &amp;&amp; (</span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+</span><span class="identifier-syntax">k</span><span class="plain-syntax">) == </span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">B</span><span class="plain-syntax">, </span><span class="identifier-syntax">j</span><span class="plain-syntax">+</span><span class="identifier-syntax">k</span><span class="plain-syntax">)); </span><span class="identifier-syntax">k</span><span class="plain-syntax">++) ;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">while</span><span class="plain-syntax"> ((</span><span class="identifier-syntax">k</span><span class="plain-syntax"> &gt; </span><span class="constant-syntax">MINIMUM_SPLICE_WORTH_BOTHERING_WITH</span><span class="plain-syntax">) &amp;&amp;</span>
<span class="plain-syntax">                        (!(</span><a href="3-td.html#SP9" class="function-link"><span class="function-syntax">Differ::boundary</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+</span><span class="identifier-syntax">k</span><span class="plain-syntax">-1), </span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">i</span><span class="plain-syntax">+</span><span class="identifier-syntax">k</span><span class="plain-syntax">))))) </span><span class="identifier-syntax">k</span><span class="plain-syntax">--;</span>
<span class="plain-syntax">                    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">k</span><span class="plain-syntax"> &gt; </span><span class="identifier-syntax">max_len</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">                        </span><span class="identifier-syntax">max_len</span><span class="plain-syntax"> = </span><span class="identifier-syntax">k</span><span class="plain-syntax">; </span><span class="identifier-syntax">max_i</span><span class="plain-syntax"> = </span><span class="identifier-syntax">i</span><span class="plain-syntax">; </span><span class="identifier-syntax">max_j</span><span class="plain-syntax"> = </span><span class="identifier-syntax">j</span><span class="plain-syntax">;</span>
<span class="plain-syntax">                    }</span>
<span class="plain-syntax">                }</span>

<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">max_len</span><span class="plain-syntax"> &gt;= </span><span class="constant-syntax">MINIMUM_SPLICE_WORTH_BOTHERING_WITH</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"substring: "</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">for</span><span class="plain-syntax"> (</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax">=0; </span><span class="identifier-syntax">c</span><span class="plain-syntax">&lt;</span><span class="identifier-syntax">max_len</span><span class="plain-syntax">; </span><span class="identifier-syntax">c</span><span class="plain-syntax">++) {</span>
<span class="plain-syntax">            </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"%c"</span><span class="plain-syntax">, </span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_i</span><span class="plain-syntax">+</span><span class="identifier-syntax">c</span><span class="plain-syntax">));</span>
<span class="plain-syntax">            </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">A</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_i</span><span class="plain-syntax">+</span><span class="identifier-syntax">c</span><span class="plain-syntax">) != </span><span class="identifier-syntax">SPCHAR</span><span class="plain-syntax">(</span><span class="identifier-syntax">B</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_j</span><span class="plain-syntax">+</span><span class="identifier-syntax">c</span><span class="plain-syntax">)) </span><span class="identifier-syntax">internal_error</span><span class="plain-syntax">(</span><span class="string-syntax">"oops"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        }</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"\n---\n"</span><span class="plain-syntax">);</span>

<span class="plain-syntax">        </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_splice</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_i</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_splice</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_j</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">A_post</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_splice</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_len</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">string_position</span><span class="plain-syntax"> </span><span class="identifier-syntax">B_post</span><span class="plain-syntax"> = </span><a href="../../../inweb/docs/foundation-module/4-sm.html#SP11" class="function-link"><span class="function-syntax">Str::plus</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_splice</span><span class="plain-syntax">, </span><span class="identifier-syntax">max_len</span><span class="plain-syntax">);</span>

<span class="plain-syntax">        </span><a href="3-td.html#SP8" class="function-link"><span class="function-syntax">Differ::diff_inner</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_splice</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_splice</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_splice</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_post</span><span class="plain-syntax">, </span><span class="constant-syntax">PRESERVE_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><a href="3-td.html#SP8" class="function-link"><span class="function-syntax">Differ::diff_inner</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_post</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_post</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">if</span><span class="plain-syntax"> (</span><a href="../../../inweb/docs/foundation-module/2-dl.html#SP7" class="function-link"><span class="function-syntax">Log::aspect_switched_on</span></a><span class="plain-syntax">(</span><span class="constant-syntax">DIFFER_DA</span><span class="plain-syntax">)) </span><a href="3-td.html#SP4" class="function-link"><span class="function-syntax">Differ::print_edit_list</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">DL</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">NULL</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="identifier-syntax">LOGIF</span><span class="plain-syntax">(</span><span class="identifier-syntax">DIFFER</span><span class="plain-syntax">, </span><span class="string-syntax">"\n---\n"</span><span class="plain-syntax">);</span>
<span class="plain-syntax">        </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    }</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-td.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP8_5"></a><b>&#167;8.5.  </b>If we can't find any good substring, all we can usefully do is say that
the text has entirely changed, and we display this as cleanly as possible:
</p>

<p class="commentary"><span class="named-paragraph-container code-font"><span class="named-paragraph-defn">If all else fails we can always just delete A and insert B</span><span class="named-paragraph-number">8.5</span></span><span class="comment-syntax"> =</span>
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="plain-syntax">    </span><span class="reserved-syntax">edit</span><span class="plain-syntax"> *</span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">A_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">A_to</span><span class="plain-syntax">, </span><span class="constant-syntax">DELETE_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">E</span><span class="plain-syntax"> = </span><a href="3-td.html#SP3" class="function-link"><span class="function-syntax">Differ::new_edit</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">B_from</span><span class="plain-syntax">, </span><span class="identifier-syntax">B_to</span><span class="plain-syntax">, </span><span class="constant-syntax">INSERT_EDIT</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="identifier-syntax">ADD_TO_LINKED_LIST</span><span class="plain-syntax">(</span><span class="identifier-syntax">E</span><span class="plain-syntax">, </span><span class="reserved-syntax">edit</span><span class="plain-syntax">, </span><span class="identifier-syntax">edits</span><span class="plain-syntax">);</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax">;</span>
</pre>
<ul class="endnotetexts"><li>This code is used in <a href="3-td.html#SP8">&#167;8</a>.</li></ul>
<p class="commentary firstcommentary"><a id="SP9"></a><b>&#167;9.  </b>This was the definition of "word boundary" used, where these are expected
to be adjacent characters (in either direction). For best results, we want
a version of <span class="extract"><span class="extract-syntax">isalpha</span></span> which respects Unicode, or else the above algorithm
will sometimes show edits mid-word at accented letters.
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::boundary</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="function-syntax">Differ::boundary</span></span>:<br/><a href="3-td.html#SP8_2">&#167;8.2</a>, <a href="3-td.html#SP8_3">&#167;8.3</a>, <a href="3-td.html#SP8_4">&#167;8.4</a></span></button><span class="plain-syntax">(</span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">c</span><span class="plain-syntax">, </span><span class="reserved-syntax">int</span><span class="plain-syntax"> </span><span class="identifier-syntax">d</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">if</span><span class="plain-syntax"> ((</span><a href="../../../inweb/docs/foundation-module/4-chr.html#SP1" class="function-link"><span class="function-syntax">Characters::isalpha</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">c</span><span class="plain-syntax">)) &amp;&amp; (</span><a href="../../../inweb/docs/foundation-module/4-chr.html#SP1" class="function-link"><span class="function-syntax">Characters::isalpha</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">d</span><span class="plain-syntax">))) </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">FALSE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">    </span><span class="reserved-syntax">return</span><span class="plain-syntax"> </span><span class="constant-syntax">TRUE</span><span class="plain-syntax">;</span>
<span class="plain-syntax">}</span>
</pre>
<p class="commentary firstcommentary"><a id="SP10"></a><b>&#167;10. Printing results. </b>That's all except to provide some routines for printing out what we found:
</p>

<pre class="displayed-code all-displayed-code code-font">
<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::print_results</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="function-syntax">Differ::print_results</span></span>:<br/>Skeins - <a href="3-skn.html#SP10_1_1">&#167;10.1.1</a></span></button><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">diff_results</span><span class="plain-syntax"> *</span><span class="identifier-syntax">DR</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">original</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><a href="3-td.html#SP4" class="function-link"><span class="function-syntax">Differ::print_edit_list</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">DR</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">original</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>

<span class="reserved-syntax">void</span><span class="plain-syntax"> </span><span class="function-syntax">Differ::print_results_as_HTML</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="function-syntax">Differ::print_results_as_HTML</span></span>:<br/>Skeins - <a href="3-skn.html#SP11">&#167;11</a></span></button><span class="plain-syntax">(</span><span class="constant-syntax">OUTPUT_STREAM</span><span class="plain-syntax">, </span><span class="reserved-syntax">diff_results</span><span class="plain-syntax"> *</span><span class="identifier-syntax">DR</span><span class="plain-syntax">, </span><span class="reserved-syntax">text_stream</span><span class="plain-syntax"> *</span><span class="identifier-syntax">original</span><span class="plain-syntax">) {</span>
<span class="plain-syntax">    </span><a href="3-td.html#SP5" class="function-link"><span class="function-syntax">Differ::print_edit_list_as_HTML</span></a><span class="plain-syntax">(</span><span class="identifier-syntax">OUT</span><span class="plain-syntax">, </span><span class="identifier-syntax">DR</span><span class="plain-syntax">-&gt;</span><span class="element-syntax">edits</span><span class="plain-syntax">, </span><span class="identifier-syntax">original</span><span class="plain-syntax">);</span>
<span class="plain-syntax">}</span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="3-th.html">&#10094;</a></li><li class="progresschapter"><a href="M-iti.html">M</a></li><li class="progresschapter"><a href="P-htpw.html">P</a></li><li class="progresschapter"><a href="1-bsc.html">1</a></li><li class="progresschapter"><a href="2-rf.html">2</a></li><li class="progresscurrentchapter">3</li><li class="progresssection"><a href="3-ts.html">ts</a></li><li class="progresssection"><a href="3-th.html">th</a></li><li class="progresscurrent">td</li><li class="progresssection"><a href="3-tr.html">tr</a></li><li class="progresssection"><a href="3-skn.html">skn</a></li><li class="progresschapter"><a href="4-tdc.html">4</a></li><li class="progressnext"><a href="3-tr.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

