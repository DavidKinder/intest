<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>3/th</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '3/td' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">intest 2.0</a></li><li><a href="index.html#3">Chapter 3: Performing Tests</a></li><li><b>The Differ</b></li></ul><p class="purpose">To provide text matching in the style of the Unix tool diff.</p>

<ul class="toc"><li><a href="#SP3">&#167;3. Edit lists</a></li><li><a href="#SP6">&#167;6. The diff algorithm</a></li><li><a href="#SP10">&#167;10. Printing results</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b>Our task is to take two strings, "ideal" and "actual", and return a
fairly minimal, fairly legible sequence of edits which would turn ideal
into actual. We won't use Myers's algorithm because it's overkill for the
text sizes we have here, and because we want to pay more attention to
word boundaries so as to produce human-readable results; the running
time below is worst-case quadratic in the number of words scanned, but
plenty fast enough for IF transcript use in practice.
</p>

<p class="inwebparagraph">We represent the series of edits as a linked list of <code class="display"><span class="extract">edit</span></code> structures,
and although these are not uniquely defined (the same comparison can
be represented in more than one way as a linked list of edits), we
do guarantee that the returned list will be empty if and only if the
ideal string has safely matched the actual one. As we'll see, this
is not quite as simple as saying that they hold the same text, because
some minor discrepancies are allowed.
</p>

<p class="inwebparagraph">Our main routine, then, will return (a pointer to) the following structure.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">diff_results</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">ideal</span><span class="plain">; </span>    <span class="comment">record a copy of the question as well as the answer</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">actual</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">edits</span><span class="plain">; </span>    <span class="comment">of <code class="display"><span class="extract">edit</span></code></span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">diff_results</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure diff_results is accessed in 3/skn and here.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>Each edit consists of a nonempty chunk of text to be deleted, preserved
or inserted:
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">DELETE_EDIT</span><span class="plain"> -1</span>
    <span class="definitionkeyword">define</span> <span class="constant">PRESERVE_EDIT</span><span class="plain"> 0</span>
    <span class="definitionkeyword">define</span> <span class="constant">INSERT_EDIT</span><span class="plain"> 1</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">edit</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">fragment</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">form_of_edit</span><span class="plain">; </span>    <span class="comment">one of the <code class="display"><span class="extract">*_EDIT</span></code> values</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">edit</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure edit is private to this section.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Edit lists. </b>We start with some boring routines to handle linked lists of edits in general.
First, creating a single new edit:
</p>


<pre class="display">
    <span class="reserved">edit</span><span class="plain"> *</span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">from</span><span class="plain">, </span><span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">to</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">form</span><span class="plain">) {</span>
        <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">edit</span><span class="plain">);</span>
        <span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>
        <span class="functiontext">Str::substr</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain">, </span><span class="identifier">from</span><span class="plain">, </span><span class="identifier">to</span><span class="plain">);</span>
        <span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;form_of_edit</span><span class="plain"> = </span><span class="identifier">form</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">E</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::new_edit is used in <a href="#SP7_1">&#167;7.1</a>, <a href="#SP8_1">&#167;8.1</a>, <a href="#SP8_2">&#167;8.2</a>, <a href="#SP8_3">&#167;8.3</a>, <a href="#SP8_4">&#167;8.4</a>, <a href="#SP8_5">&#167;8.5</a>.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>Since we're not going to do any patching, the only thing we do with edit
lists is to print them out. The octal character values here represent ASCII
escape (27) followed by standard terminal emulation codes on Unix shells for
coloured text: deletions are in red, insertions in green.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">results_colouring</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Differ::set_colour_usage</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">state</span><span class="plain">) {</span>
        <span class="identifier">results_colouring</span><span class="plain"> = </span><span class="identifier">state</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Differ::print_edit_list</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">original</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">original</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">)</span>
                <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;form_of_edit</span><span class="plain">) {</span>
                    <span class="reserved">case</span><span class="plain"> </span><span class="constant">DELETE_EDIT</span><span class="plain">:</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">results_colouring</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">0</span><span class="string">33[31m"</span><span class="plain">);</span>
                        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;deleted:"</span><span class="plain">);</span>
                        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain">);</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">results_colouring</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">0</span><span class="string">33[0m"</span><span class="plain">);</span>
                        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&gt;"</span><span class="plain">);</span>
                        <span class="reserved">break</span><span class="plain">;</span>
                    <span class="reserved">case</span><span class="plain"> </span><span class="constant">PRESERVE_EDIT</span><span class="plain">:</span>
                        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain">);</span>
                        <span class="reserved">break</span><span class="plain">;</span>
                    <span class="reserved">case</span><span class="plain"> </span><span class="constant">INSERT_EDIT</span><span class="plain">:</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">results_colouring</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">0</span><span class="string">33[32m"</span><span class="plain">);</span>
                        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;inserted:"</span><span class="plain">);</span>
                        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain">);</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">results_colouring</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">0</span><span class="string">33[0m"</span><span class="plain">);</span>
                        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&gt;"</span><span class="plain">);</span>
                        <span class="reserved">break</span><span class="plain">;</span>
                <span class="plain">}</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::set_colour_usage is used in 1/mn (<a href="1-mn.html#SP1_4">&#167;1.4</a>).</p>

<p class="endnote">The function Differ::print_edit_list is used in <a href="#SP8_4">&#167;8.4</a>, <a href="#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b>Now for basically the same thing in HTML, using CSS spans instead of terminal
colours:
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Differ::print_edit_list_as_HTML</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">original</span><span class="plain">) {</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;html&gt;\</span><span class="plain">n</span><span class="string">&lt;body&gt;\</span><span class="plain">n</span><span class="string">&lt;p class=\</span><span class="plain">"</span><span class="string">node\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="functiontext">Differ::print_fragment_as_HTML</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">original</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">)</span>
                <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;form_of_edit</span><span class="plain">) {</span>
                    <span class="reserved">case</span><span class="plain"> </span><span class="constant">DELETE_EDIT</span><span class="plain">:</span>
                        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;span class=\</span><span class="plain">"</span><span class="string">deletion\</span><span class="plain">"</span><span class="string">&gt;"</span><span class="plain">);</span>
                        <span class="functiontext">Differ::print_fragment_as_HTML</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain">);</span>
                        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/span&gt;"</span><span class="plain">);</span>
                        <span class="reserved">break</span><span class="plain">;</span>
                    <span class="reserved">case</span><span class="plain"> </span><span class="constant">PRESERVE_EDIT</span><span class="plain">:</span>
                        <span class="functiontext">Differ::print_fragment_as_HTML</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain">);</span>
                        <span class="reserved">break</span><span class="plain">;</span>
                    <span class="reserved">case</span><span class="plain"> </span><span class="constant">INSERT_EDIT</span><span class="plain">:</span>
                        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;span class=\</span><span class="plain">"</span><span class="string">insertion\</span><span class="plain">"</span><span class="string">&gt;"</span><span class="plain">);</span>
                        <span class="functiontext">Differ::print_fragment_as_HTML</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;fragment</span><span class="plain">);</span>
                        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/span&gt;"</span><span class="plain">);</span>
                        <span class="reserved">break</span><span class="plain">;</span>
                <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/p&gt;\</span><span class="plain">n</span><span class="string">&lt;/body&gt;\</span><span class="plain">n</span><span class="string">&lt;/html&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Differ::print_fragment_as_HTML</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">original</span><span class="plain">) {</span>
        <span class="identifier">LOOP_THROUGH_TEXT</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">, </span><span class="identifier">original</span><span class="plain">) {</span>
            <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = </span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">);</span>
            <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">c</span><span class="plain">) {</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="character">'&lt;'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&amp;lt;"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="character">'&gt;'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&amp;gt;"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="character">'&amp;'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&amp;amp;"</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">default</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%c"</span><span class="plain">, </span><span class="identifier">c</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::print_edit_list_as_HTML is used in <a href="#SP10">&#167;10</a>.</p>

<p class="endnote">The function Differ::print_fragment_as_HTML appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. The diff algorithm. </b>We do this in the simplest way possible. This outer routine, which is not
recursively called, sets up the returned structure and sends it back.
</p>

<p class="inwebparagraph">Note that a sequence of edits with no insertions or deletions means the
match was in fact perfect, and is converted to the null edit list.
</p>


<pre class="display">
    <span class="reserved">diff_results</span><span class="plain"> *</span><span class="functiontext">Differ::diff</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">ideal</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">actual</span><span class="plain">) {</span>
        <span class="reserved">diff_results</span><span class="plain"> *</span><span class="identifier">DR</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">diff_results</span><span class="plain">);</span>
        <span class="identifier">DR</span><span class="plain">-</span><span class="element">&gt;ideal</span><span class="plain"> = </span><span class="identifier">ideal</span><span class="plain">;</span>
        <span class="identifier">DR</span><span class="plain">-</span><span class="element">&gt;actual</span><span class="plain"> = </span><span class="identifier">actual</span><span class="plain">;</span>

        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"Differ:\</span><span class="plain">n</span><span class="string">A = %S\</span><span class="plain">n</span><span class="string">B = %S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">ideal</span><span class="plain">, </span><span class="identifier">actual</span><span class="plain">);</span>
        <span class="identifier">DR</span><span class="plain">-</span><span class="element">&gt;edits</span><span class="plain"> = </span><span class="functiontext">Differ::diff_outer</span><span class="plain">(</span><span class="identifier">ideal</span><span class="plain">, </span><span class="identifier">actual</span><span class="plain">);</span>

        <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">DR</span><span class="plain">-</span><span class="element">&gt;edits</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain">-</span><span class="element">&gt;form_of_edit</span><span class="plain"> != </span><span class="constant">PRESERVE_EDIT</span><span class="plain">)</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">DR</span><span class="plain">;</span>
        <span class="identifier">DR</span><span class="plain">-</span><span class="element">&gt;edits</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">edit</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">DR</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::diff is used in 3/skn (<a href="3-skn.html#SP10_1_1">&#167;10.1.1</a>, <a href="3-skn.html#SP11">&#167;11</a>).</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b>The first level down simply starts the recursion, though it checks for
version lines first.
</p>


<pre class="display">
    <span class="reserved">linked_list</span><span class="plain"> *</span><span class="functiontext">Differ::diff_outer</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">B</span><span class="plain">) {</span>
        <span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">edits</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">edit</span><span class="plain">);</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_from</span><span class="plain"> = </span><span class="functiontext">Str::start</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_to</span><span class="plain"> = </span><span class="functiontext">Str::end</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">);</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_from</span><span class="plain"> = </span><span class="functiontext">Str::start</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_to</span><span class="plain"> = </span><span class="functiontext">Str::end</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">);</span>

        &lt;<span class="cwebmacro">If both texts contain the Inform banner version line, diff around that</span> <span class="cwebmacronumber">7.1</span>&gt;<span class="plain">;</span>

        <span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">, </span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">edits</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::diff_outer is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP7_1"></a><b>&#167;7.1.  </b>Any correctly formed I7 banner matches any other; this ensures that
transcripts of the same interaction, taken from builds on different days or
with different compiler versions, continue to match.
</p>

<p class="inwebparagraph">If text A (as we call the ideal version) and text B (the actual) both contain
I7 banners, we split them into before, then the banner, then after. The result
then consists of a diff of the before-texts, followed by preserving the actual
banner, followed by a diff of the after-texts.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">If both texts contain the Inform banner version line, diff around that</span> <span class="cwebmacronumber">7.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">template</span><span class="plain"> = </span><span class="identifier">L</span><span class="string">"(%c*?)(Release %d+ / Serial number %d+ / "</span>
            <span class="string">"Inform 7 build %c%c%c%c %cI6%c+?%c+?SD)%c*"</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">template</span><span class="plain">)) {</span>
            <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_ver</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0])); </span>    <span class="comment">at the R in "Release"</span>
            <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_post</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">A_ver</span><span class="plain">, </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1])); </span>    <span class="comment">after version line ends</span>

            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">template</span><span class="plain">)) {</span>
                <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_ver</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">B_from</span><span class="plain">, </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]));</span>
                <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_post</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">B_ver</span><span class="plain">, </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1]));</span>

                <span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_ver</span><span class="plain">, </span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_ver</span><span class="plain">);</span>
                <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">A_ver</span><span class="plain">, </span><span class="identifier">A_post</span><span class="plain">, </span><span class="constant">PRESERVE_EDIT</span><span class="plain">);</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
                <span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">A_post</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">, </span><span class="identifier">B_post</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">);</span>
                <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">edits</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8.  </b>The second level is at last recursive.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="reserved">linked_list</span><span class="plain"> *</span><span class="identifier">edits</span><span class="plain">,</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_from</span><span class="plain">, </span><span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_to</span><span class="plain">,</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_from</span><span class="plain">, </span><span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_to</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">A_len</span><span class="plain"> = </span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">B_len</span><span class="plain"> = </span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">A_len</span><span class="plain"> == 0) &amp;&amp; (</span><span class="identifier">B_len</span><span class="plain"> == 0)) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A_len</span><span class="plain"> &lt; 0) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"A text negative"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">B_len</span><span class="plain"> &lt; 0) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"B text negative"</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"Differ (recursion):\</span><span class="plain">n</span><span class="string">A (%d chars) = "</span><span class="plain">, </span><span class="identifier">A_len</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Log::aspect_switched_on</span><span class="plain">(</span><span class="constant">DIFFER_DA</span><span class="plain">)) </span><span class="functiontext">Str::substr</span><span class="plain">(</span><span class="identifier">DL</span><span class="plain">, </span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"\</span><span class="plain">n</span><span class="string">B (%d chars) = "</span><span class="plain">, </span><span class="identifier">B_len</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Log::aspect_switched_on</span><span class="plain">(</span><span class="constant">DIFFER_DA</span><span class="plain">)) </span><span class="functiontext">Str::substr</span><span class="plain">(</span><span class="identifier">DL</span><span class="plain">, </span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">If A is empty B must be inserted, if B is empty A must be deleted</span> <span class="cwebmacronumber">8.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Any common prefix can be preserved</span> <span class="cwebmacronumber">8.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Any common suffix can be preserved</span> <span class="cwebmacronumber">8.3</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Splice around the longest common substring</span> <span class="cwebmacronumber">8.4</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">If all else fails we can always just delete A and insert B</span> <span class="cwebmacronumber">8.5</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::diff_inner is used in <a href="#SP7">&#167;7</a>, <a href="#SP7_1">&#167;7.1</a>, <a href="#SP8_2">&#167;8.2</a>, <a href="#SP8_3">&#167;8.3</a>, <a href="#SP8_4">&#167;8.4</a>.</p>

<p class="inwebparagraph"><a id="SP8_1"></a><b>&#167;8.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">If A is empty B must be inserted, if B is empty A must be deleted</span> <span class="cwebmacronumber">8.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A_len</span><span class="plain"> == 0) {</span>
            <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">, </span><span class="constant">INSERT_EDIT</span><span class="plain">);</span>
            <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">B_len</span><span class="plain"> == 0) {</span>
            <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">, </span><span class="constant">DELETE_EDIT</span><span class="plain">);</span>
            <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP8_2"></a><b>&#167;8.2.  </b>We look for the longest common prefix consisting of a sequence of entire
words, or at any rate, ending at a word boundary (in both texts).
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Any common prefix can be preserved</span> <span class="cwebmacronumber">8.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_after_prefix</span><span class="plain"> = </span><span class="identifier">A_from</span><span class="plain">;</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_after_prefix</span><span class="plain"> = </span><span class="identifier">B_from</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (; (</span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">A_after_prefix</span><span class="plain">) &lt; </span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">A_to</span><span class="plain">)) &amp;&amp;</span>
                <span class="plain">(</span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">B_after_prefix</span><span class="plain">) &lt; </span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">B_to</span><span class="plain">));</span>
            <span class="identifier">A_after_prefix</span><span class="plain"> = </span><span class="functiontext">Str::forward</span><span class="plain">(</span><span class="identifier">A_after_prefix</span><span class="plain">),</span>
            <span class="identifier">B_after_prefix</span><span class="plain"> = </span><span class="functiontext">Str::forward</span><span class="plain">(</span><span class="identifier">B_after_prefix</span><span class="plain">))</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="identifier">A_after_prefix</span><span class="plain">) != </span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="identifier">B_after_prefix</span><span class="plain">))</span>
                <span class="reserved">break</span><span class="plain">;</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"Common prefix size %d\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_after_prefix</span><span class="plain">));</span>

        <span class="comment">roll backwards until we're at a word boundary between the prefix and the rest</span>
        <span class="reserved">while</span><span class="plain"> ((</span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_after_prefix</span><span class="plain">) &gt; 0) &amp;&amp;</span>
            <span class="plain">(!</span><span class="functiontext">Differ::boundary</span><span class="plain">(</span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">A_after_prefix</span><span class="plain">)), </span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="identifier">A_after_prefix</span><span class="plain">)))) {</span>
            <span class="identifier">A_after_prefix</span><span class="plain"> = </span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">A_after_prefix</span><span class="plain">);</span>
            <span class="identifier">B_after_prefix</span><span class="plain"> = </span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">B_after_prefix</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"After rollback, prefix size %d\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_after_prefix</span><span class="plain">));</span>

        <span class="comment">if there's anything left, mark it as common text and recurse to move past it</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_after_prefix</span><span class="plain">) &gt; 0) {</span>
            <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_after_prefix</span><span class="plain">, </span><span class="constant">PRESERVE_EDIT</span><span class="plain">);</span>
            <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
            <span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">A_after_prefix</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">, </span><span class="identifier">B_after_prefix</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP8_3"></a><b>&#167;8.3.  </b>Similarly, we're only interested in a common suffix going back to the start
of a whole word.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Any common suffix can be preserved</span> <span class="cwebmacronumber">8.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_suffix</span><span class="plain"> = </span><span class="identifier">A_to</span><span class="plain">;</span>
        <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_suffix</span><span class="plain"> = </span><span class="identifier">B_to</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (; (</span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">) &gt; </span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">)) &amp;&amp;</span>
            <span class="plain">(</span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">B_suffix</span><span class="plain">) &gt; </span><span class="functiontext">Str::index</span><span class="plain">(</span><span class="identifier">B_from</span><span class="plain">));</span>
            <span class="identifier">A_suffix</span><span class="plain"> = </span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">),</span>
            <span class="identifier">B_suffix</span><span class="plain"> = </span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">B_suffix</span><span class="plain">))</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">)) != </span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">B_suffix</span><span class="plain">)))</span>
                <span class="reserved">break</span><span class="plain">;</span>

        <span class="comment">roll forwards until we're at a word boundary between the front and the suffix</span>
        <span class="reserved">while</span><span class="plain"> ((</span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">) &gt; 0) &amp;&amp;</span>
            <span class="plain">(!</span><span class="functiontext">Differ::boundary</span><span class="plain">(</span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="functiontext">Str::back</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">)), </span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">)))) {</span>
            <span class="identifier">A_suffix</span><span class="plain"> = </span><span class="functiontext">Str::forward</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">);</span>
            <span class="identifier">B_suffix</span><span class="plain"> = </span><span class="functiontext">Str::forward</span><span class="plain">(</span><span class="identifier">B_suffix</span><span class="plain">);</span>
        <span class="plain">}</span>

        <span class="comment">if there's anything left, mark it as common text and recurse to move back past it</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::width_between</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">) &gt; 0) {</span>
            <span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_suffix</span><span class="plain">, </span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_suffix</span><span class="plain">);</span>
            <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">A_suffix</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">, </span><span class="constant">PRESERVE_EDIT</span><span class="plain">);</span>
            <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP8_4"></a><b>&#167;8.4.  </b>In the typical use case most of the strings will now be gone, and this is
where the algorithm goes quadratic. We're going to look for the longest
common substring between A and B, provided it occurs at word boundaries,
and is not trivially short. If we find this, we'll recurse to diff the
text before the substring, then preserve the substring, then recurse to
diff the text afterwards.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MINIMUM_SPLICE_WORTH_BOTHERING_WITH</span><span class="plain"> 5</span>
    <span class="definitionkeyword">define</span> <span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">n</span><span class="plain">) </span><span class="functiontext">Str::get</span><span class="plain">(</span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">##</span><span class="identifier">_from</span><span class="plain">, </span><span class="identifier">n</span><span class="plain">))</span>
</pre>

<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Splice around the longest common substring</span> <span class="cwebmacronumber">8.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">max_i</span><span class="plain"> = -1, </span><span class="identifier">max_j</span><span class="plain"> = -1, </span><span class="identifier">max_len</span><span class="plain"> = 0;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain"> = 0; </span><span class="identifier">i</span><span class="plain"> &lt; </span><span class="identifier">A_len</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++)</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain"> == 0) || (</span><span class="functiontext">Differ::boundary</span><span class="plain">(</span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">-1), </span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">))))</span>
                <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">j</span><span class="plain"> = 0; </span><span class="identifier">j</span><span class="plain"> &lt; </span><span class="identifier">B_len</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">++)</span>
                    <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">j</span><span class="plain"> == 0) || (</span><span class="functiontext">Differ::boundary</span><span class="plain">(</span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">j</span><span class="plain">-1), </span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">j</span><span class="plain">)))) {</span>
                        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">k</span><span class="plain">;</span>
                        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">k</span><span class="plain"> = 0; (</span><span class="identifier">i</span><span class="plain">+</span><span class="identifier">k</span><span class="plain"> &lt; </span><span class="identifier">A_len</span><span class="plain">) &amp;&amp; (</span><span class="identifier">j</span><span class="plain">+</span><span class="identifier">k</span><span class="plain"> &lt; </span><span class="identifier">B_len</span><span class="plain">) &amp;&amp; (</span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">+</span><span class="identifier">k</span><span class="plain">) == </span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">j</span><span class="plain">+</span><span class="identifier">k</span><span class="plain">)); </span><span class="identifier">k</span><span class="plain">++) ;</span>
                        <span class="reserved">while</span><span class="plain"> ((</span><span class="identifier">k</span><span class="plain"> &gt; </span><span class="constant">MINIMUM_SPLICE_WORTH_BOTHERING_WITH</span><span class="plain">) &amp;&amp;</span>
                            <span class="plain">(!(</span><span class="functiontext">Differ::boundary</span><span class="plain">(</span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">+</span><span class="identifier">k</span><span class="plain">-1), </span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">+</span><span class="identifier">k</span><span class="plain">))))) </span><span class="identifier">k</span><span class="plain">--;</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">k</span><span class="plain"> &gt; </span><span class="identifier">max_len</span><span class="plain">) {</span>
                            <span class="identifier">max_len</span><span class="plain"> = </span><span class="identifier">k</span><span class="plain">; </span><span class="identifier">max_i</span><span class="plain"> = </span><span class="identifier">i</span><span class="plain">; </span><span class="identifier">max_j</span><span class="plain"> = </span><span class="identifier">j</span><span class="plain">;</span>
                        <span class="plain">}</span>
                    <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">max_len</span><span class="plain"> &gt;= </span><span class="constant">MINIMUM_SPLICE_WORTH_BOTHERING_WITH</span><span class="plain">) {</span>
            <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"substring: "</span><span class="plain">);</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain">=0; </span><span class="identifier">c</span><span class="plain">&lt;</span><span class="identifier">max_len</span><span class="plain">; </span><span class="identifier">c</span><span class="plain">++) {</span>
                <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"%c"</span><span class="plain">, </span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">max_i</span><span class="plain">+</span><span class="identifier">c</span><span class="plain">));</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">max_i</span><span class="plain">+</span><span class="identifier">c</span><span class="plain">) != </span><span class="identifier">SPCHAR</span><span class="plain">(</span><span class="identifier">B</span><span class="plain">, </span><span class="identifier">max_j</span><span class="plain">+</span><span class="identifier">c</span><span class="plain">)) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"oops"</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"\</span><span class="plain">n</span><span class="string">---\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>

            <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_splice</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">max_i</span><span class="plain">);</span>
            <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_splice</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">max_j</span><span class="plain">);</span>
            <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">A_post</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">A_splice</span><span class="plain">, </span><span class="identifier">max_len</span><span class="plain">);</span>
            <span class="reserved">string_position</span><span class="plain"> </span><span class="identifier">B_post</span><span class="plain"> = </span><span class="functiontext">Str::plus</span><span class="plain">(</span><span class="identifier">B_splice</span><span class="plain">, </span><span class="identifier">max_len</span><span class="plain">);</span>

            <span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_splice</span><span class="plain">, </span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_splice</span><span class="plain">);</span>
            <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">A_splice</span><span class="plain">, </span><span class="identifier">A_post</span><span class="plain">, </span><span class="constant">PRESERVE_EDIT</span><span class="plain">);</span>
            <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
            <span class="functiontext">Differ::diff_inner</span><span class="plain">(</span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">A_post</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">, </span><span class="identifier">B_post</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Log::aspect_switched_on</span><span class="plain">(</span><span class="constant">DIFFER_DA</span><span class="plain">)) </span><span class="functiontext">Differ::print_edit_list</span><span class="plain">(</span><span class="identifier">DL</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
            <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">DIFFER</span><span class="plain">, </span><span class="string">"\</span><span class="plain">n</span><span class="string">---\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP8_5"></a><b>&#167;8.5.  </b>If we can't find any good substring, all we can usefully do is say that
the text has entirely changed, and we display this as cleanly as possible:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">If all else fails we can always just delete A and insert B</span> <span class="cwebmacronumber">8.5</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">edit</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">A_from</span><span class="plain">, </span><span class="identifier">A_to</span><span class="plain">, </span><span class="constant">DELETE_EDIT</span><span class="plain">);</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
        <span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Differ::new_edit</span><span class="plain">(</span><span class="identifier">B_from</span><span class="plain">, </span><span class="identifier">B_to</span><span class="plain">, </span><span class="constant">INSERT_EDIT</span><span class="plain">);</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">E</span><span class="plain">, </span><span class="reserved">edit</span><span class="plain">, </span><span class="identifier">edits</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9.  </b>This was the definition of "word boundary" used, where these are expected
to be adjacent characters (in either direction). For best results, we want
a version of <code class="display"><span class="extract">isalpha</span></code> which respects Unicode, or else the above algorithm
will sometimes show edits mid-word at accented letters.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Differ::boundary</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">d</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Characters::isalpha</span><span class="plain">(</span><span class="identifier">c</span><span class="plain">)) &amp;&amp; (</span><span class="functiontext">Characters::isalpha</span><span class="plain">(</span><span class="identifier">d</span><span class="plain">))) </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="constant">TRUE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::boundary is used in <a href="#SP8_2">&#167;8.2</a>, <a href="#SP8_3">&#167;8.3</a>, <a href="#SP8_4">&#167;8.4</a>.</p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10. Printing results. </b>That's all except to provide some routines for printing out what we found:
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Differ::print_results</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">diff_results</span><span class="plain"> *</span><span class="identifier">DR</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">original</span><span class="plain">) {</span>
        <span class="functiontext">Differ::print_edit_list</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">DR</span><span class="plain">-</span><span class="element">&gt;edits</span><span class="plain">, </span><span class="identifier">original</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Differ::print_results_as_HTML</span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">diff_results</span><span class="plain"> *</span><span class="identifier">DR</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">original</span><span class="plain">) {</span>
        <span class="functiontext">Differ::print_edit_list_as_HTML</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">DR</span><span class="plain">-</span><span class="element">&gt;edits</span><span class="plain">, </span><span class="identifier">original</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Differ::print_results is used in 3/skn (<a href="3-skn.html#SP10_1_1">&#167;10.1.1</a>).</p>

<p class="endnote">The function Differ::print_results_as_HTML is used in 3/skn (<a href="3-skn.html#SP11">&#167;11</a>).</p>

<hr class="tocbar">
<ul class="toc"><li><a href="3-th.html">Back to 'The Hasher'</a></li><li><a href="3-tr.html">Continue with 'The Reporter'</a></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

