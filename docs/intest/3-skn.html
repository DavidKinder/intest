<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Skeins</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-src/Figures/Intest.png" height=72">
</a></h1>
<ul><li><a href="index.html"><span class="selectedlink">intest</span></a></li>
</ul><h2>Foundation Module</h2><ul>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>
</ul><h2>Repository</h2><ul>
<li><a href="https://github.com/ganelson/intest"><img src="../github.png" height=18> github</a></li>
</ul><h2>Related Projects</h2><ul>
<li><a href="../../../inweb/docs/index.html">inweb</a></li>
<li><a href="../../../inform/docs/index.html">inform</a></li>

</ul>
		</nav>
		<main role="main">
		
<!--Weave of 'Skeins' generated by 7-->
<ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">intest</a></li><li><a href="index.html#3">Chapter 3: Performing Tests</a></li><li><b>Skeins</b></li></ul><p class="purpose">To build and compare skein threads.</p>

<ul class="toc"><li><a href="3-skn.html#SP1">&#167;1. About skeins</a></li><li><a href="3-skn.html#SP3">&#167;3. Stringing skeins together</a></li><li><a href="3-skn.html#SP9">&#167;9. Disposing of skeins</a></li><li><a href="3-skn.html#SP10">&#167;10. Matching skeins</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. About skeins. </b>"Skein" is a term coined by the Inform project for a tree of possible
textual commands and responses. Branching in the tree represents a choice
of which command to give. Such branches are useful when considering what
lines of play are possible, but Intest is only interested in the past, not
the future, and there is only one linear past. So Intest will only consider
skeins which are not so much trees as trunks: a skein for us is going to be
a linked list where each node is a <code class="display"><span class="extract">skein</span></code> structure, not a tree of them.
</p>

<p class="inwebparagraph">All this may seem as if it applies only to testing interactive fiction
projects created by Inform, and certainly the full power of the code below is
only really useful to implement the Delia commands <code class="display"><span class="extract">match glulxe transcript</span></code>
and <code class="display"><span class="extract">match frotz transcript</span></code>. But it is actually used for every sort of match.
When Intest needs to match two plain text files, it creates skeins for them
with one node per line of text. It follows that virtually all Intest runs do
use the code below, even if only minimally.
</p>

<p class="inwebparagraph">Skein text can be supplied in a variety of formats:
</p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">I7_OUTPUT_SKF</span><span class="definitionkeyword"> from </span><span class="constant">1</span>    <span class="comment"> I7 only: console output of I7 compiler problem messages</span>
    <span class="definitionkeyword">enum</span> <span class="constant">GENERIC_SKF</span><span class="plain"> </span><span class="comment"> I7 only: a transcript which might be either from Frotz or Glulxe</span>
    <span class="definitionkeyword">enum</span> <span class="constant">DUMB_FROTZ_SKF</span><span class="plain"> </span><span class="comment"> I7 only: a transcript file produced by dumb-frotz</span>
    <span class="definitionkeyword">enum</span> <span class="constant">DUMB_GLULXE_SKF</span><span class="plain"> </span><span class="comment"> I7 only: a transcript file produced by dumb-glulxe</span>
    <span class="definitionkeyword">enum</span> <span class="constant">I7_SKEIN_SKF</span><span class="plain"> </span><span class="comment"> I7 only: from the XML-format Skein file of an I7 project bundle</span>
    <span class="definitionkeyword">enum</span> <span class="constant">PLAIN_SKF</span><span class="plain"> </span><span class="comment"> for plain text matching, nothing to do with I7</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">skein</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">from_format</span><span class="plain">; </span><span class="comment"> one of the <code class="display"><span class="extract">*_SKF</span></code> constants above</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">; </span><span class="comment"> the real content, the text of what happened</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">label</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">line_count_label</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">disposed_of</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">down</span><span class="plain">; </span><span class="comment"> thus making this a linked list of <code class="display"><span class="extract">skein</span></code></span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">skein</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure skein is private to this section.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::write<button class="popup" onclick="togglePopup('usagePopup82')">...<span class="popuptext" id="usagePopup82">Usage of <b>Skeins::write</b>:<br>none</span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">sk</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="identifier">sk</span><span class="plain">) {</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Node %d: "</span><span class="plain">, </span><span class="identifier">count</span><span class="plain">++);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">sk</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
            <span class="identifier">sk</span><span class="plain"> = </span><span class="identifier">sk</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::write_node_label<button class="popup" onclick="togglePopup('usagePopup83')">...<span class="popuptext" id="usagePopup83">Usage of <b>Skeins::write_node_label</b>:<br>Basics - <a href="1-bsc.html#SP2_5">&#167;2.5</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">char</span><span class="plain"> *</span><span class="identifier">format</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">vS</span><span class="plain">) {</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain"> = (</span><span class="reserved">skein</span><span class="plain"> *) </span><span class="identifier">vS</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;null-node&gt;"</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">line_count_label</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"line %d"</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">line_count_label</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">label</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Stringing skeins together. </b>The Tester, when trying to match two files <code class="display"><span class="extract">A</span></code> and <code class="display"><span class="extract">B</span></code>, calls one of the
following on each to turn it into a skein.
</p>

<pre class="display">
    <span class="reserved">skein</span><span class="plain"> *</span><span class="functiontext">Skeins::from_i7_problems<button class="popup" onclick="togglePopup('usagePopup84')">...<span class="popuptext" id="usagePopup84">Usage of <b>Skeins::from_i7_problems</b>:<br>The Tester - <a href="4-tt.html#SP1_1_1_2_3_2_3_3_6">&#167;1.1.1.2.3.2.3.3.6</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext"><a href="3-skn.html#SP4">Skeins::read</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">I7_OUTPUT_SKF</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">skein</span><span class="plain"> *</span><span class="functiontext">Skeins::from_transcript<button class="popup" onclick="togglePopup('usagePopup85')">...<span class="popuptext" id="usagePopup85">Usage of <b>Skeins::from_transcript</b>:<br>none</span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext"><a href="3-skn.html#SP4">Skeins::read</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">GENERIC_SKF</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">skein</span><span class="plain"> *</span><span class="functiontext">Skeins::from_Z_transcript<button class="popup" onclick="togglePopup('usagePopup86')">...<span class="popuptext" id="usagePopup86">Usage of <b>Skeins::from_Z_transcript</b>:<br>The Tester - <a href="4-tt.html#SP1_1_1_2_3_2_3_3_4">&#167;1.1.1.2.3.2.3.3.4</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext"><a href="3-skn.html#SP4">Skeins::read</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">DUMB_FROTZ_SKF</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">skein</span><span class="plain"> *</span><span class="functiontext">Skeins::from_G_transcript<button class="popup" onclick="togglePopup('usagePopup87')">...<span class="popuptext" id="usagePopup87">Usage of <b>Skeins::from_G_transcript</b>:<br>The Tester - <a href="4-tt.html#SP1_1_1_2_3_2_3_3_5">&#167;1.1.1.2.3.2.3.3.5</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext"><a href="3-skn.html#SP4">Skeins::read</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">DUMB_GLULXE_SKF</span><span class="plain">, </span><span class="identifier">cle</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">skein</span><span class="plain"> *</span><span class="functiontext">Skeins::from_I7_skein<button class="popup" onclick="togglePopup('usagePopup88')">...<span class="popuptext" id="usagePopup88">Usage of <b>Skeins::from_I7_skein</b>:<br><a href="3-skn.html#SP11">&#167;11</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">seek</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">actual_flag</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext"><a href="3-skn.html#SP4">Skeins::read</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">I7_SKEIN_SKF</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="identifier">seek</span><span class="plain">, </span><span class="identifier">actual_flag</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">skein</span><span class="plain"> *</span><span class="functiontext">Skeins::from_plain_text<button class="popup" onclick="togglePopup('usagePopup89')">...<span class="popuptext" id="usagePopup89">Usage of <b>Skeins::from_plain_text</b>:<br>The Tester - <a href="4-tt.html#SP1_1_1_2_3_2_3_3_1">&#167;1.1.1.2.3.2.3.3.1</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext"><a href="3-skn.html#SP4">Skeins::read</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">PLAIN_SKF</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>All of which use the following:
</p>

<pre class="display">
    <span class="reserved">skein</span><span class="plain"> *</span><span class="functiontext">Skeins::read<button class="popup" onclick="togglePopup('usagePopup90')">...<span class="popuptext" id="usagePopup90">Usage of <b>Skeins::read</b>:<br><a href="3-skn.html#SP3">&#167;3</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">format</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">cle</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">seek</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">actual_flag</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">TB</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">CN</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">NL</span><span class="plain">);</span>
        <span class="reserved">skein_state</span><span class="plain"> </span><span class="identifier">sks</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Initialise the Skein reader state</span> <span class="cwebmacronumber">4.2</span>&gt;<span class="plain">;</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-tf.html#SP5">TextFiles::read</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open problems transcript"</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">,</span>
            <span class="plain">&amp;</span><span class="functiontext"><a href="3-skn.html#SP5">Skeins::read_assistant</a></span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">sks</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">.</span><span class="element">writing_to</span><span class="plain">) </span><span class="functiontext"><a href="3-skn.html#SP8">Skeins::flush</a></span><span class="plain">(&amp;</span><span class="identifier">sks</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">CN</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">NL</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">TB</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">sks</span><span class="plain">.</span><span class="identifier">root</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4_1"></a><b>&#167;4.1.  </b></p>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">skein_state</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">root</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">tendril</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">writing_to</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">detected_format</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">turn_buffer</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">double_starred</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">node_to_seek</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">current_node</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">next_label</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">actual_flag</span><span class="plain">;</span>
    <span class="plain">} </span><span class="reserved">skein_state</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure skein_state is private to this section.</p>

<p class="inwebparagraph"><a id="SP4_2"></a><b>&#167;4.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Initialise the Skein reader state</span> <span class="cwebmacronumber">4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">root</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">tendril</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">writing_to</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">detected_format</span><span class="plain"> = </span><span class="identifier">format</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">turn_buffer</span><span class="plain"> = </span><span class="identifier">TB</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">double_starred</span><span class="plain"> = </span><span class="identifier">cle</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">node_to_seek</span><span class="plain"> = </span><span class="identifier">seek</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">current_node</span><span class="plain"> = </span><span class="identifier">CN</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">next_label</span><span class="plain"> = </span><span class="identifier">NL</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">.</span><span class="element">actual_flag</span><span class="plain"> = </span><span class="identifier">actual_flag</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b>The following, then, is called line by line on the skein file being read,
with the above state being maintained.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::read_assistant<button class="popup" onclick="togglePopup('usagePopup91')">...<span class="popuptext" id="usagePopup91">Usage of <b>Skeins::read_assistant</b>:<br><a href="3-skn.html#SP4">&#167;4</a>, <a href="3-skn.html#SP5_4_1">&#167;5.4.1</a>, <a href="3-skn.html#SP5_4_2">&#167;5.4.2</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line_text</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">vsks</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">line_text</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"null line"</span><span class="plain">);</span>
        <span class="reserved">skein_state</span><span class="plain"> *</span><span class="identifier">sks</span><span class="plain"> = </span><span class="identifier">vsks</span><span class="plain">;</span>

        &lt;<span class="cwebmacro">Autodetect the interpreter which produced this generic transcript</span> <span class="cwebmacronumber">5.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Skip the first line of a Frotz transcript</span> <span class="cwebmacronumber">5.2</span>&gt;<span class="plain">;</span>

        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">PLAIN_SKF:</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read from plain text</span> <span class="cwebmacronumber">5.3</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">I7_SKEIN_SKF:</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read from XML</span> <span class="cwebmacronumber">5.4</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">I7_OUTPUT_SKF:</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read from Inform 7 console output</span> <span class="cwebmacronumber">5.5</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">DUMB_FROTZ_SKF:</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read from a Frotz transcript</span> <span class="cwebmacronumber">5.6</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">DUMB_GLULXE_SKF:</span><span class="plain"> </span>&lt;<span class="cwebmacro">Read from a Glulxe transcript</span> <span class="cwebmacronumber">5.7</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain">) </span>&lt;<span class="cwebmacro">Transcribe this line into the turn buffer</span> <span class="cwebmacronumber">5.8</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5_1"></a><b>&#167;5.1.  </b>Dumb-frotz indents everything by two spaces; dumb-glulxe does not. This
can be used to tell which one produced a given transcript file.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Autodetect the interpreter which produced this generic transcript</span> <span class="cwebmacronumber">5.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="identifier">detected_format</span><span class="plain"> == </span><span class="constant">GENERIC_SKF</span><span class="plain">) &amp;&amp; (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">) &gt; </span><span class="constant">0</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">, </span><span class="constant">0</span><span class="plain">) == </span><span class="character">' '</span><span class="plain">) &amp;&amp; (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">, </span><span class="constant">1</span><span class="plain">) == </span><span class="character">' '</span><span class="plain">))</span>
                <span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain"> = </span><span class="constant">DUMB_FROTZ_SKF</span><span class="plain">;</span>
            <span class="reserved">else</span>
                <span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain"> = </span><span class="constant">DUMB_GLULXE_SKF</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_2"></a><b>&#167;5.2.  </b>The opening line of a dumb-frotz transcript is a plain text form of the
status line early in play. We don't want that.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Skip the first line of a Frotz transcript</span> <span class="cwebmacronumber">5.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">tfp</span><span class="plain">-&gt;</span><span class="identifier">line_count</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain"> == </span><span class="constant">DUMB_FROTZ_SKF</span><span class="plain">))</span>
            <span class="reserved">return</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_3"></a><b>&#167;5.3.  </b>See the documentation for why we forgive differences in thread number.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read from plain text</span> <span class="cwebmacronumber">5.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">-&gt;</span><span class="element">line_count</span><span class="plain">+1, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?)/T%d+/(%c*)"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">, </span><span class="string">"Txx/%S"</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="identifier">exp</span><span class="plain">[1]);</span>
        <span class="plain">}</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?)\\T%d+\\(%c*)"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">, </span><span class="string">"Txx\\%S"</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1]);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_4"></a><b>&#167;5.4.  </b>Let us not pretend that this is a properly capable XML reader: it's
nothing of the kind, and simply does just enough to scrape the necessary
text out of a Skein file in an I7 project. This is not the place to
document that format.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read from XML</span> <span class="cwebmacronumber">5.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">L</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">);</span>
        &lt;<span class="cwebmacro">Nefariously force a line break before any tag opener</span> <span class="cwebmacronumber">5.4.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Nefariously make a short tag its own line</span> <span class="cwebmacronumber">5.4.2</span>&gt;<span class="plain">;</span>

        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        &lt;<span class="cwebmacro">Extract the node ID, if this line declares one</span> <span class="cwebmacronumber">5.4.3</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"&lt;/item&gt;"</span><span class="plain">)) </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">current_node</span><span class="plain">);</span>

        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">node_to_seek</span><span class="plain">) == </span><span class="constant">0</span><span class="plain">) ||</span>
            <span class="plain">(</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">node_to_seek</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="identifier">current_node</span><span class="plain">)))</span>
            &lt;<span class="cwebmacro">We want this node</span> <span class="cwebmacronumber">5.4.4</span>&gt;<span class="plain">;</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_4_1"></a><b>&#167;5.4.1.  </b>Given the line <code class="display"><span class="extract">hello, &lt;it&gt;you</span></code>, split into two lines <code class="display"><span class="extract">hello, </span></code> and
<code class="display"><span class="extract">&lt;it&gt;you</span></code>, by calling this line-reading routine again on each. (That's
what's nefarious.)
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Nefariously force a line break before any tag opener</span> <span class="cwebmacronumber">5.4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">i</span><span class="plain"> &lt; </span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">) == </span><span class="character">'&lt;'</span><span class="plain">)) {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">front</span><span class="plain">);</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">back</span><span class="plain">);</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">front</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::truncate</a></span><span class="plain">(</span><span class="identifier">front</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">);</span>
                <span class="functiontext"><a href="3-skn.html#SP5">Skeins::read_assistant</a></span><span class="plain">(</span><span class="identifier">front</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">, </span><span class="identifier">vsks</span><span class="plain">);</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy_tail</a></span><span class="plain">(</span><span class="identifier">back</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">);</span>
                <span class="functiontext"><a href="3-skn.html#SP5">Skeins::read_assistant</a></span><span class="plain">(</span><span class="identifier">back</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">, </span><span class="identifier">vsks</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">front</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">back</span><span class="plain">);</span>
                <span class="reserved">return</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5_4">&#167;5.4</a>.</p>

<p class="inwebparagraph"><a id="SP5_4_2"></a><b>&#167;5.4.2.  </b>If we're here, the only place a <code class="display"><span class="extract">&lt;</span></code> can be is at the start of a line.
If we can also see a matching <code class="display"><span class="extract">&gt;</span></code> then again split, so that <code class="display"><span class="extract">&lt;it&gt;you</span></code>
would split into two lines <code class="display"><span class="extract">&lt;it&gt;</span></code> and <code class="display"><span class="extract">you</span></code>.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Nefariously make a short tag its own line</span> <span class="cwebmacronumber">5.4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_first_char</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">) == </span><span class="character">'&lt;'</span><span class="plain">) {</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">i</span><span class="plain"> &lt; </span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">i</span><span class="plain"> &lt; </span><span class="identifier">L</span><span class="plain">-1) &amp;&amp; (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">) == </span><span class="character">'&gt;'</span><span class="plain">)) {</span>
                    <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">front</span><span class="plain">);</span>
                    <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">back</span><span class="plain">);</span>
                    <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">front</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
                    <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::truncate</a></span><span class="plain">(</span><span class="identifier">front</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">+1);</span>
                    <span class="functiontext"><a href="3-skn.html#SP5">Skeins::read_assistant</a></span><span class="plain">(</span><span class="identifier">front</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">, </span><span class="identifier">vsks</span><span class="plain">);</span>
                    <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy_tail</a></span><span class="plain">(</span><span class="identifier">back</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">+1);</span>
                    <span class="functiontext"><a href="3-skn.html#SP5">Skeins::read_assistant</a></span><span class="plain">(</span><span class="identifier">back</span><span class="plain">, </span><span class="identifier">tfp</span><span class="plain">, </span><span class="identifier">vsks</span><span class="plain">);</span>
                    <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">front</span><span class="plain">);</span>
                    <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">back</span><span class="plain">);</span>
                    <span class="reserved">return</span><span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5_4">&#167;5.4</a>.</p>

<p class="inwebparagraph"><a id="SP5_4_3"></a><b>&#167;5.4.3.  </b>So now a line is either an entire tag, or entirely not a tag. In a Skein
file, <code class="display"><span class="extract">&lt;item nodeId="..."&gt;</span></code> is what declares a node ID, and it's now easy
to match for that:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Extract the node ID, if this line declares one</span> <span class="cwebmacronumber">5.4.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;item nodeId=\"(%c*)\"&gt;"</span><span class="plain">))</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">current_node</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5_4">&#167;5.4</a>.</p>

<p class="inwebparagraph"><a id="SP5_4_4"></a><b>&#167;5.4.4.  </b>Sometimes the I7 app wants us to make a skein from the whole file, and
sometimes just from a single node in it. Either way, this is run when
we are at a node whose contents we care about:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">We want this node</span> <span class="cwebmacronumber">5.4.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;command %c*&gt;"</span><span class="plain">))</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP14">Str::put_at</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">next_label</span><span class="plain">, </span><span class="constant">0</span><span class="plain">, </span><span class="constant">1</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;result %c*&gt;"</span><span class="plain">)) &amp;&amp; (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">actual_flag</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">next_label</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;commentary %c*&gt;"</span><span class="plain">)) &amp;&amp; (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">actual_flag</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">next_label</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;/result%c*&gt;"</span><span class="plain">)) ||</span>
            <span class="plain">(</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&lt;/commentary%c*&gt;"</span><span class="plain">))) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain">) </span><span class="functiontext"><a href="3-skn.html#SP8">Skeins::flush</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">);</span>
            <span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_first_char</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">) != </span><span class="character">'&lt;'</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">next_label</span><span class="plain">, </span><span class="constant">0</span><span class="plain">) == </span><span class="constant">1</span><span class="plain">) {</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">next_label</span><span class="plain">);</span>
                <span class="functiontext"><a href="3-skn.html#SP6">Skeins::remove_XML_escapes</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">next_label</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5_4">&#167;5.4</a>.</p>

<p class="inwebparagraph"><a id="SP5_5"></a><b>&#167;5.5.  </b>This code is used only for matching problem message output from the I7
compiler. We ignore <code class="display"><span class="extract">Offending filename</span></code> lines for much the reason above &mdash;
they exist only in fatal file-system problem messages in any case. A line
in the form
</p>

<pre class="display">
        <span class="plain">Problem__ PM_ActivityVariableNameless</span>
</pre>

<p class="inwebparagraph">is printed by I7 only on test runs, and lets us check that the right
problem message is being produced. We don't ignore such a line: we capture
the problem name and label the Skein node with it.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read from Inform 7 console output</span> <span class="cwebmacronumber">5.5</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Inform 7 has finished%c*"</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain">) </span><span class="functiontext"><a href="3-skn.html#SP8">Skeins::flush</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">);</span>
            <span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%c*Offending filename%c*"</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"Problem__ (%c*)"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0], </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_6"></a><b>&#167;5.6.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Read from a Frotz transcript</span> <span class="cwebmacronumber">5.6</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">la</span><span class="plain">[6];</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP6">Str::copy_to_wide_string</a></span><span class="plain">(</span><span class="identifier">la</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="constant">6</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">tfp</span><span class="plain">-&gt;</span><span class="identifier">line_count</span><span class="plain"> == </span><span class="constant">1</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="constant">0</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">tfp</span><span class="plain">-&gt;</span><span class="identifier">line_count</span><span class="plain"> == </span><span class="constant">2</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">'E'</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">'O'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[2] == </span><span class="character">'T'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[3] == </span><span class="constant">0</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1,</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP4">Str::new_from_ISO_string</a></span><span class="plain">(</span><span class="string">"opening text"</span><span class="plain">), </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">'&gt;'</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>

        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" %[quitting the game%]%c*"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">' '</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">' '</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[2] == </span><span class="character">'&gt;'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[3] == </span><span class="character">'['</span><span class="plain">)) {</span>
            <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%c%c%c%c%d+%] (%c+)"</span><span class="plain">)) {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">, </span><span class="string">"reply to \"%S\""</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
                <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1, </span><span class="identifier">label</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
                <span class="reserved">return</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">' '</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">' '</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[2] == </span><span class="character">'*'</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="identifier">la</span><span class="plain">[3] == </span><span class="character">'*'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[4] == </span><span class="character">' '</span><span class="plain">)) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">tail</span><span class="plain">);</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy_tail</a></span><span class="plain">(</span><span class="identifier">tail</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="constant">5</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">, </span><span class="string">"reply to \"%S\""</span><span class="plain">, </span><span class="identifier">tail</span><span class="plain">);</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1, </span><span class="identifier">label</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">tail</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_7"></a><b>&#167;5.7.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Read from a Glulxe transcript</span> <span class="cwebmacronumber">5.7</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">la</span><span class="plain">[6];</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP6">Str::copy_to_wide_string</a></span><span class="plain">(</span><span class="identifier">la</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="constant">6</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1,</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP4">Str::new_from_ISO_string</a></span><span class="plain">(</span><span class="string">"opening text"</span><span class="plain">), </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>

        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&gt;Are you sure you want to quit?%c*"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"&gt;%(Testing.%)%c*"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
            <span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">'&gt;'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">'['</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%c%c%d+%] (%c+)"</span><span class="plain">))) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">, </span><span class="string">"reply to \"%S\""</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1, </span><span class="identifier">label</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="identifier">double_starred</span><span class="plain">) &amp;&amp;</span>
            <span class="plain">(</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">'*'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">'*'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[2] == </span><span class="character">' '</span><span class="plain">)) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">tail</span><span class="plain">);</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy_tail</a></span><span class="plain">(</span><span class="identifier">tail</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">, </span><span class="constant">3</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">, </span><span class="string">"reply to \"%S\""</span><span class="plain">, </span><span class="identifier">tail</span><span class="plain">);</span>
            <span class="functiontext"><a href="3-skn.html#SP7">Skeins::new_node</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">, -1, </span><span class="identifier">label</span><span class="plain">, </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">tail</span><span class="plain">);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_8"></a><b>&#167;5.8.  </b>We lose the redundant two-space indentation of a dumb-frotz transcript.
Otherwise, we simply add the new line to the current turn buffer.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Transcribe this line into the turn buffer</span> <span class="cwebmacronumber">5.8</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain"> == </span><span class="constant">DUMB_FROTZ_SKF</span><span class="plain">) {</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP24">Str::delete_first_character</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">);</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP24">Str::delete_first_character</a></span><span class="plain">(</span><span class="identifier">line_text</span><span class="plain">);</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">detected_format</span><span class="plain"> == </span><span class="constant">I7_SKEIN_SKF</span><span class="plain">)</span>
            <span class="functiontext"><a href="3-skn.html#SP6">Skeins::remove_XML_escapes</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">turn_buffer</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
        <span class="reserved">else</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::concatenate</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">turn_buffer</span><span class="plain">, </span><span class="identifier">line_text</span><span class="plain">);</span>
        <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">turn_buffer</span><span class="plain">, </span><span class="character">'\n'</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>This "utility" simply removes the XML escapes for <code class="display"><span class="extract">&lt;</span></code>, <code class="display"><span class="extract">&gt;</span></code> and <code class="display"><span class="extract">&amp;</span></code>.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::remove_XML_escapes<button class="popup" onclick="togglePopup('usagePopup92')">...<span class="popuptext" id="usagePopup92">Usage of <b>Skeins::remove_XML_escapes</b>:<br><a href="3-skn.html#SP5_4_4">&#167;5.4.4</a>, <a href="3-skn.html#SP5_8">&#167;5.8</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">L</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">);</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">i</span><span class="plain"> &lt; </span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">la</span><span class="plain">[6];</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP6">Str::copy_to_wide_string</a></span><span class="plain">(</span><span class="identifier">la</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">, </span><span class="constant">6</span><span class="plain">);</span>

            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">'&amp;'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">'l'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[2] == </span><span class="character">'t'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[3] == </span><span class="character">';'</span><span class="plain">)) {</span>
                <span class="identifier">PUT</span><span class="plain">(</span><span class="character">'&lt;'</span><span class="plain">);</span>
                <span class="identifier">i</span><span class="plain"> += </span><span class="constant">3</span><span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">'&amp;'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">'g'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[2] == </span><span class="character">'t'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[3] == </span><span class="character">';'</span><span class="plain">)) {</span>
                <span class="identifier">PUT</span><span class="plain">(</span><span class="character">'&gt;'</span><span class="plain">);</span>
                <span class="identifier">i</span><span class="plain"> += </span><span class="constant">3</span><span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">la</span><span class="plain">[0] == </span><span class="character">'&amp;'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[1] == </span><span class="character">'a'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[2] == </span><span class="character">'m'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[3] == </span><span class="character">'p'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">la</span><span class="plain">[4] == </span><span class="character">';'</span><span class="plain">)) {</span>
                <span class="identifier">PUT</span><span class="plain">(</span><span class="character">'&amp;'</span><span class="plain">);</span>
                <span class="identifier">i</span><span class="plain"> += </span><span class="constant">4</span><span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">PUT</span><span class="plain">(</span><span class="identifier">la</span><span class="plain">[0]);</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b>The following begins a new node in the Skein:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::new_node<button class="popup" onclick="togglePopup('usagePopup93')">...<span class="popuptext" id="usagePopup93">Usage of <b>Skeins::new_node</b>:<br><a href="3-skn.html#SP5_3">&#167;5.3</a>, <a href="3-skn.html#SP5_4_4">&#167;5.4.4</a>, <a href="3-skn.html#SP5_5">&#167;5.5</a>, <a href="3-skn.html#SP5_6">&#167;5.6</a>, <a href="3-skn.html#SP5_7">&#167;5.7</a></span></button></span><span class="plain">(</span><span class="reserved">skein_state</span><span class="plain"> *</span><span class="identifier">sks</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">ln</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">label</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">format</span><span class="plain">) {</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">new_node</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">skein</span><span class="plain">);</span>
        <span class="identifier">new_node</span><span class="plain">-&gt;</span><span class="identifier">label</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">new_node</span><span class="plain">-&gt;</span><span class="identifier">line_count_label</span><span class="plain"> = </span><span class="identifier">ln</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ln</span><span class="plain"> &lt; </span><span class="constant">0</span><span class="plain">) </span><span class="identifier">new_node</span><span class="plain">-&gt;</span><span class="element">label</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">label</span><span class="plain">);</span>
        <span class="identifier">new_node</span><span class="plain">-&gt;</span><span class="identifier">text</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP2">Str::new</a></span><span class="plain">();</span>
        <span class="identifier">new_node</span><span class="plain">-&gt;</span><span class="identifier">down</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">new_node</span><span class="plain">-&gt;</span><span class="identifier">from_format</span><span class="plain"> = </span><span class="identifier">format</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain">) </span><span class="functiontext"><a href="3-skn.html#SP8">Skeins::flush</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">);</span>
        <span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain"> = </span><span class="identifier">new_node</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">root</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">root</span><span class="plain"> = </span><span class="identifier">new_node</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="identifier">tendril</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain"> = </span><span class="identifier">new_node</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">tendril</span><span class="plain"> = </span><span class="identifier">new_node</span><span class="plain">;</span>
        <span class="identifier">new_node</span><span class="plain">-&gt;</span><span class="identifier">disposed_of</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8.  </b>While this routine brings the existing node &mdash; that is, the one currently
being written to &mdash; to an end:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::flush<button class="popup" onclick="togglePopup('usagePopup94')">...<span class="popuptext" id="usagePopup94">Usage of <b>Skeins::flush</b>:<br><a href="3-skn.html#SP4">&#167;4</a>, <a href="3-skn.html#SP5_4_4">&#167;5.4.4</a>, <a href="3-skn.html#SP5_5">&#167;5.5</a>, <a href="3-skn.html#SP7">&#167;7</a></span></button></span><span class="plain">(</span><span class="reserved">skein_state</span><span class="plain"> *</span><span class="identifier">sks</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">writing_to</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">turn_buffer</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">sks</span><span class="plain">-&gt;</span><span class="element">turn_buffer</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Disposing of skeins. </b>On a long run of many tests, Intest creates an enormous number of <code class="display"><span class="extract">skein</span></code>
structures, so this is the one data structure it takes the trouble to
deallocate when it's done with them. We need to do this depth-first, i.e.,
from the bottom upwards, because if you start at the top then you destroy
the link to the rest before you can get to them.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::dispose_of<button class="popup" onclick="togglePopup('usagePopup95')">...<span class="popuptext" id="usagePopup95">Usage of <b>Skeins::dispose_of</b>:<br>The Tester - <a href="4-tt.html#SP1_1_1_2_3_2_3_3_1">&#167;1.1.1.2.3.2.3.3.1</a>, <a href="4-tt.html#SP1_1_1_2_3_2_3_3_4">&#167;1.1.1.2.3.2.3.3.4</a>, <a href="4-tt.html#SP1_1_1_2_3_2_3_3_5">&#167;1.1.1.2.3.2.3.3.5</a>, <a href="4-tt.html#SP1_1_1_2_3_2_3_3_6">&#167;1.1.1.2.3.2.3.3.6</a></span></button></span><span class="plain">(</span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">N</span><span class="plain"> = </span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">; </span><span class="identifier">S</span><span class="plain">; </span><span class="identifier">S</span><span class="plain"> = </span><span class="identifier">N</span><span class="plain">, </span><span class="identifier">N</span><span class="plain"> = (</span><span class="identifier">S</span><span class="plain">)?(</span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">):</span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">disposed_of</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"skein node doubly disposed of"</span><span class="plain">);</span>
            <span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">disposed_of</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">) </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP2">Str::dispose_of</a></span><span class="plain">(</span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="element">label</span><span class="plain">) </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP2">Str::dispose_of</a></span><span class="plain">(</span><span class="identifier">S</span><span class="plain">-&gt;</span><span class="identifier">label</span><span class="plain">);</span>
            <span class="identifier">DESTROY</span><span class="plain">(</span><span class="identifier">S</span><span class="plain">, </span><span class="reserved">skein</span><span class="plain">);</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10. Matching skeins. </b>So, this was what it was all about. Given two skeins, do they hold the same
sequence of pieces of text? And if not, find a clean way to express the
differences between them.
</p>

<p class="inwebparagraph">To match perfectly, the skeins <code class="display"><span class="extract">A</span></code> (actual) and <code class="display"><span class="extract">I</span></code> (ideal) must have the
same number of nodes, and each corresponding pair of nodes must have the
same "label" and the same "text".
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_COMPARE_ERRORS_REPORTED</span><span class="plain"> </span><span class="constant">10</span>
</pre>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Skeins::compare<button class="popup" onclick="togglePopup('usagePopup96')">...<span class="popuptext" id="usagePopup96">Usage of <b>Skeins::compare</b>:<br>The Tester - <a href="4-tt.html#SP1_1_1_2_3_2_3_3_1">&#167;1.1.1.2.3.2.3.3.1</a>, <a href="4-tt.html#SP1_1_1_2_3_2_3_3_4">&#167;1.1.1.2.3.2.3.3.4</a>, <a href="4-tt.html#SP1_1_1_2_3_2_3_3_5">&#167;1.1.1.2.3.2.3.3.5</a>, <a href="4-tt.html#SP1_1_1_2_3_2_3_3_6">&#167;1.1.1.2.3.2.3.3.6</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain">, </span><span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">problems</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">, </span><span class="identifier">error_count</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="reserved">char</span><span class="plain"> *</span><span class="identifier">thing</span><span class="plain"> = </span><span class="string">"problem"</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">problems</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) { </span><span class="identifier">count</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">thing</span><span class="plain"> = </span><span class="string">"turn"</span><span class="plain">; }</span>
        <span class="reserved">while</span><span class="plain"> (((</span><span class="identifier">A</span><span class="plain">) || (</span><span class="identifier">I</span><span class="plain">)) &amp;&amp; (</span><span class="identifier">error_count</span><span class="plain"> &lt; </span><span class="constant">MAX_COMPARE_ERRORS_REPORTED</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">A</span><span class="plain">) &amp;&amp; (</span><span class="identifier">I</span><span class="plain">)) {</span>
                &lt;<span class="cwebmacro">Both skeins are still going</span> <span class="cwebmacronumber">10.1</span>&gt;<span class="plain">;</span>
                <span class="reserved">continue</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">) {</span>
                &lt;<span class="cwebmacro">The actual skein is still going, but the ideal one has run out</span> <span class="cwebmacronumber">10.2</span>&gt;<span class="plain">;</span>
                <span class="reserved">continue</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">I</span><span class="plain">) {</span>
                &lt;<span class="cwebmacro">The ideal skein is still going, but the actual one has run out</span> <span class="cwebmacronumber">10.3</span>&gt;<span class="plain">;</span>
                <span class="reserved">continue</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">error_count</span><span class="plain"> &gt;= </span><span class="constant">MAX_COMPARE_ERRORS_REPORTED</span><span class="plain">)</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"...and so on (stopped reading after %d errors)\n"</span><span class="plain">, </span><span class="constant">MAX_COMPARE_ERRORS_REPORTED</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">error_count</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">1</span><span class="plain">; </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">0</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP10_1"></a><b>&#167;10.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Both skeins are still going</span> <span class="cwebmacronumber">10.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">same_label</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">line_count_label</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">line_count_label</span><span class="plain"> &gt;= </span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">line_count_label</span><span class="plain">))</span>
            <span class="identifier">same_label</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">label</span><span class="plain">) &amp;&amp; (</span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">label</span><span class="plain">) &amp;&amp; (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">label</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">label</span><span class="plain">))) </span><span class="identifier">same_label</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">same_label</span><span class="plain">) </span>&lt;<span class="cwebmacro">Both skeins have the same label at this node</span> <span class="cwebmacronumber">10.1.1</span>&gt;
        <span class="reserved">else</span><span class="plain"> </span>&lt;<span class="cwebmacro">The two skeins have different labels at this node</span> <span class="cwebmacronumber">10.1.2</span>&gt;<span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP10_1_1"></a><b>&#167;10.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Both skeins have the same label at this node</span> <span class="cwebmacronumber">10.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP18">Str::ne</a></span><span class="plain">(</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">)) {</span>
            <span class="reserved">diff_results</span><span class="plain"> *</span><span class="identifier">DR</span><span class="plain"> = </span><span class="functiontext"><a href="3-td.html#SP6">Differ::diff</a></span><span class="plain">(</span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/2-llas.html#SP6">LinkedLists::len</a></span><span class="plain">(</span><span class="identifier">DR</span><span class="plain">-&gt;</span><span class="element">edits</span><span class="plain">) &gt; </span><span class="constant">0</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">from_format</span><span class="plain"> == </span><span class="constant">PLAIN_SKF</span><span class="plain">)</span>
                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Discrepancy at %k:\n"</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">);</span>
                <span class="reserved">else</span>
                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Discrepancy on %s %d (%k):\n"</span><span class="plain">, </span><span class="identifier">thing</span><span class="plain">, </span><span class="identifier">count</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">);</span>
                <span class="constant">INDENT</span><span class="plain">;</span>
                <span class="functiontext"><a href="3-td.html#SP10">Differ::print_results</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">DR</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
                <span class="constant">OUTDENT</span><span class="plain">;</span>
                <span class="identifier">error_count</span><span class="plain">++;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="identifier">count</span><span class="plain">++;</span>
        <span class="identifier">A</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">;</span>
        <span class="identifier">I</span><span class="plain"> = </span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP10_1">&#167;10.1</a>.</p>

<p class="inwebparagraph"><a id="SP10_1_2"></a><b>&#167;10.1.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">The two skeins have different labels at this node</span> <span class="cwebmacronumber">10.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Unexpected %s %d (%k not %k):\n%S"</span><span class="plain">, </span><span class="identifier">thing</span><span class="plain">, </span><span class="identifier">count</span><span class="plain">++, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="constant">OUTDENT</span><span class="plain">;</span>
        <span class="identifier">A</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">;</span>
        <span class="identifier">error_count</span><span class="plain">++;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP10_1">&#167;10.1</a>.</p>

<p class="inwebparagraph"><a id="SP10_2"></a><b>&#167;10.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">The actual skein is still going, but the ideal one has run out</span> <span class="cwebmacronumber">10.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">from_format</span><span class="plain"> == </span><span class="constant">PLAIN_SKF</span><span class="plain">)</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Extra %k:\n%S"</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
        <span class="reserved">else</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Unexpected %s %d (%k):\n%S"</span><span class="plain">, </span><span class="identifier">thing</span><span class="plain">, </span><span class="identifier">count</span><span class="plain">++, </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="constant">OUTDENT</span><span class="plain">;</span>
        <span class="identifier">A</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">;</span>
        <span class="identifier">error_count</span><span class="plain">++;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP10_3"></a><b>&#167;10.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">The ideal skein is still going, but the actual one has run out</span> <span class="cwebmacronumber">10.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">from_format</span><span class="plain"> == </span><span class="constant">PLAIN_SKF</span><span class="plain">)</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Missing %k:\n%S"</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
        <span class="reserved">else</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Missing %s (%k):\n%S"</span><span class="plain">, </span><span class="identifier">thing</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">); </span><span class="constant">INDENT</span><span class="plain">;</span>
        <span class="constant">OUTDENT</span><span class="plain">;</span>
        <span class="identifier">I</span><span class="plain"> = </span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">down</span><span class="plain">;</span>
        <span class="identifier">error_count</span><span class="plain">++;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="3-skn.html#SP10">&#167;10</a>.</p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11.  </b>This powers <code class="display"><span class="extract">-test-skein</span></code>, which specifies an exact node ID and wants to
compare only the text at that one node. We therefore make mimimal <code class="display"><span class="extract">skein</span></code>
structures &mdash; each a singleton &mdash; and then just call the Differ directly
to compare the two.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Skeins::test_i7_skein<button class="popup" onclick="togglePopup('usagePopup97')">...<span class="popuptext" id="usagePopup97">Usage of <b>Skeins::test_i7_skein</b>:<br>Actions - <a href="2-act.html#SP9_2">&#167;9.2</a></span></button></span><span class="plain">(</span><span class="constant">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">node_id</span><span class="plain">) {</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">A</span><span class="plain"> = </span><span class="functiontext"><a href="3-skn.html#SP3">Skeins::from_I7_skein</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="identifier">node_id</span><span class="plain">, </span><span class="constant">TRUE</span><span class="plain">);</span>
        <span class="reserved">skein</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain"> = </span><span class="functiontext"><a href="3-skn.html#SP3">Skeins::from_I7_skein</a></span><span class="plain">(</span><span class="identifier">F</span><span class="plain">, </span><span class="identifier">node_id</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">);</span>
        <span class="reserved">diff_results</span><span class="plain"> *</span><span class="identifier">DR</span><span class="plain"> = </span><span class="functiontext"><a href="3-td.html#SP6">Differ::diff</a></span><span class="plain">(</span><span class="identifier">I</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
        <span class="functiontext"><a href="3-td.html#SP10">Differ::print_results_as_HTML</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">DR</span><span class="plain">, </span><span class="identifier">A</span><span class="plain">-&gt;</span><span class="element">text</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="3-tr.html">Back to 'The Reporter'</a></li><li><i>(This section ends Chapter 3: Performing Tests.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
		</main>
	</body>
</html>

